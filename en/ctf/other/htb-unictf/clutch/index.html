<!doctype html><html lang="en"><head><title>Clutch | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="HTB UniCTF 2024. Quantum Cryptography. Frame-based Quantum Key Distribution"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB UniCTF 2024. Quantum Cryptography. Frame-based Quantum Key Distribution"><meta itemprop="keywords" content><meta itemprop="name" content="Clutch"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="HTB UniCTF 2024. Quantum Cryptography. Frame-based Quantum Key Distribution"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Clutch"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/htb-unictf/clutch/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="HTB UniCTF 2024. Quantum Cryptography. Frame-based Quantum Key Distribution"><meta name="twitter:description" content="HTB UniCTF 2024. Quantum Cryptography. Frame-based Quantum Key Distribution"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Clutch"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/htb-unictf/clutch/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\lcm}{\mathop{\mathrm{lcm}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/htb-unictf/clutch/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB UNICTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/htb-unictf/clutch/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/htb-unictf/clutch/&amp;text=Clutch" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/htb-unictf/clutch/&amp;title=Clutch" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Clutch</h1><p class="mb4 f6 dib tracked">22 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#background">Background</a><ul><li><a href="#frame-based-qkd">Frame-based QKD</a></li></ul></li><li><a href="#source-code-analysis">Source code analysis</a></li><li><a href="#solution">Solution</a><ul><li><a href="#getting-the-flag">Getting the flag</a></li></ul></li><li><a href="#flag">Flag</a><ul><li><a href="#conclusion">Conclusion</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given the following Python code that implements a quantum algorithm for key distribution:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">sha256</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">uniform</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">json</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">Padding</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">unpad</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Cipher</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">secret</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">SECRET_MESSAGE</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">alice</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">Alice</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">bob</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">Bob</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">json_print</span><span class="mtk1">(</span><span class="mtk9 mtki">message</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">(</span><span class="mtk9 mtki">message</span><span class="mtk1">))</span>

<span class="mtk3"># Python implementation of the Frame-based QKD pro</span><span class="mtk3">tocol described here : </span><span class="mtk3 detected-link">https://www.mdpi.com/2073-8994/12/6/1053</span>
<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">QKD</span><span class="mtk1">:</span><span class="inline-folded"></span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk8">json_print</span><span class="mtk1">({</span><span class="mtk4">"info"</span><span class="mtk1">: </span><span class="mtk4">"To all ships of The Frontier Board, use your secr</span><span class="mtk4">et key to get the coordinates of The Starry Spurr"</span><span class="mtk1">})</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk8">json_print</span><span class="mtk1">({</span><span class="mtk4">"info"</span><span class="mtk1">: </span><span class="mtk4">"Initializing QKD..."</span><span class="mtk1">})</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">qkd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">QKD</span><span class="mtk1">(</span><span class="mtk8 mtku">Alice</span><span class="mtk1">, </span><span class="mtk8 mtku">Bob</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">public</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">qkd</span><span class="mtk1">.</span><span class="mtk8">execute</span><span class="mtk1">()</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk8">json_print</span><span class="mtk1">(</span><span class="mtk1">public</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk4">"error"</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">public</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">status</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">qkd</span><span class="mtk1">.</span><span class="mtk8">check_status</span><span class="mtk1">()</span>
<span class="mtk1">            </span><span class="mtk8">json_print</span><span class="mtk1">(</span><span class="mtk1">status</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">break</span>

<span class="mtk1">    </span><span class="mtk8">json_print</span><span class="mtk1">({</span><span class="mtk4">"info"</span><span class="mtk1">: </span><span class="mtk4">"Initialization completed. Only trusted ships can </span><span class="mtk4">send valid commands"</span><span class="mtk1">})</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">loads</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk1">encrypted_command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk4">"command"</span><span class="mtk1">])</span>
<span class="mtk1">            </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">encrypted_command</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">json_print</span><span class="mtk1">({</span><span class="mtk4">"error"</span><span class="mtk1">: </span><span class="mtk4">"Invalid input. Please, try again"</span><span class="mtk1">})</span>
<span class="mtk1">            </span><span class="mtk5">continue</span>

<span class="mtk1">        </span><span class="mtk1">command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">qkd</span><span class="mtk1">.</span><span class="mtk8">decrypt_command</span><span class="mtk1">(</span><span class="mtk1">encrypted_command</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">command</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"OPEN THE GATE"</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">FLAG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'flag.txt'</span><span class="mtk1">).</span><span class="mtk8">read</span><span class="mtk1">()</span>
<span class="mtk1">            </span><span class="mtk8">json_print</span><span class="mtk1">({</span><span class="mtk4">"info"</span><span class="mtk1">: </span><span class="mtk7 mtki">f</span><span class="mtk4">" Welcome to The Frontier Board, the coordinates o</span><span class="mtk4">f The Starry Spurr are </span><span class="mtk6">{</span><span class="mtk1">SECRET_MESSAGE</span><span class="mtk6">}{</span><span class="mtk1">FLAG</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">})</span>  
<span class="mtk1">            </span><span class="mtk8">exit</span><span class="mtk1">()</span>

<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">json_print</span><span class="mtk1">({</span><span class="mtk4">"error"</span><span class="mtk1">: </span><span class="mtk4">"Unknown command. Please, try again"</span><span class="mtk1">})</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>The project is made out of four files:</p><ul><li><code>server.py</code></li><li><code>alice.py</code></li><li><code>bob.py</code></li><li><code>helpers.py</code></li></ul><p>There is a link to a <a target="_blank" href="https://www.mdpi.com/2073-8994/12/6/1053">paper</a> that presents the quantum algorithm that is implemented in Python. We will be analyzing the algorithm and the code.</p><p>The algorithm is called Frame-based Quantum Key Distribution (QKD), and it allows two parties (Alice and Bob) to share a secret in a secure way over an insecure channel while using quantum computing. In this challenge we are in the position of Eve, a malicious user that can eavesdrop the communication between Alice and Bob, and we will need to find the shared secret among them, which should be hard to find from Eve&rsquo;s position.</p><p>Therefore, we might think that the QKD algorithm is correct and the Python implementation has a bug that allows us to extract sensitive information. But it is also possible that the QKD algorithm is not completely good, although it is published in a research journal, and we need to find a flaw to get the shared secret.</p><h2 id="background">Background</h2><p>This challenge needs some knowledge about quantum computing. I&rsquo;m not probably prepared to write rigorous quantum stuff here yet, but I will try to express some key concepts:</p><ul><li><p>In quantum computing, qbits don&rsquo;t have a certain value, they have a superposition state. It means that they can have any value, until the qbit is measured. Once a qbit is observed, it collapses to a value (<code>0</code> or <code>1</code>) and it cannot be changed. And this happens with some probability, that can be expressed as $\ket{\psi} = \alpha \cdot \ket{0} + \beta \cdot \ket{1}$, where $|\alpha|^2$ and $|\beta|^2$ represent the probability of collapsing to <code>0</code> or <code>1</code>, thus $|\alpha|^2 + |\beta|^2 = 1$</p></li><li><p>A Hadamard gate (H) produces a &ldquo;change of basis&rdquo;:</p><ul><li><p>$H \ket{0} = \displaystyle\frac{1}{\sqrt{2}} \big(\ket{0} + \ket{1}\big) \equiv \ket{+}$</p></li><li><p>$H \ket{1} = \displaystyle\frac{1}{\sqrt{2}} \big(\ket{0} - \ket{1}\big) \equiv \ket{-}$</p></li></ul></li><li><p>Measuring a qbit that has been transformed by a Hadamard gate has 50% chance of collapsing to <code>0</code> or <code>1</code></p></li></ul><p>The <a target="_blank" href="https://www.mdpi.com/2073-8994/12/6/1053">paper</a> uses the following notation: $\ket{0_\mathrm{Z}}$ and $\ket{1_\mathrm{Z}}$ for qbits polarized with the standard basis, and $\ket{0_\mathrm{X}}$ and $\ket{1_\mathrm{X}}$ for qbits polarized with the Hadamard basis (that is, apply a Hadamard gate before measuring).</p><p>This means that if one measures using $\mathrm{Z}$, then $\ket{0_\mathrm{Z}}$ collapes to <code>0</code> and $\ket{1_\mathrm{Z}}$ collapses so <code>1</code> with 100% probability, while measuring any of $\ket{0_\mathrm{X}}$ or $\ket{1_\mathrm{X}}$ will collapse either to <code>0</code> or <code>1</code> with exactly 50% probability. The same happens in reverse when measuring with $\mathrm{X}$.</p><p>The QKD algorithm is mainly based in the use of non-orthogonal qbits. The purpose is that Alice sends a pair of qbits that are non-orthogonal, chosen at random and polarized with $\mathrm{X}$ and $\mathrm{Z}$, in this order. Actually, there are only 4 possible non-orthogonal pairs:</p><ul><li>$(\ket{0_\mathrm{X}}, \ket{0_\mathrm{Z}})$</li><li>$(\ket{0_\mathrm{X}}, \ket{1_\mathrm{Z}})$</li><li>$(\ket{1_\mathrm{X}}, \ket{0_\mathrm{Z}})$</li><li>$(\ket{1_\mathrm{X}}, \ket{1_\mathrm{Z}})$</li></ul><p>Then, Bob measures with either $\mathrm{Z}$ or $\mathrm{X}$, so that one of the qbits is always measured correctly. The author uses the term <em>double matching</em> to refer the fact of measuring the same value on both qbits. For example, if Bob receives $(\ket{0_\mathrm{X}}, \ket{1_\mathrm{Z}})$ and measures with $\mathrm{X}$, he can decode as either $(0, 0)$ or $(0, 1)$. The former is a double matching, whereas the latter is not.</p><p>Another concept to learn before diving into the QKD protocol is a <em>binary frame</em> (or simply, frame). This is just a matrix of non-orthogonal qbit pairs. For instance, pairs $(\ket{1_\mathrm{X}}, \ket{1_\mathrm{Z}})$ and $(\ket{0_\mathrm{X}}, \ket{1_\mathrm{Z}})$ can be arranged like</p><p class="scroll">$$
\begin{pmatrix}
\ket{1_\mathrm{X}} & \ket{1_\mathrm{Z}} \\
  \ket{0_\mathrm{X}} & \ket{1_\mathrm{Z}}
\end{pmatrix}
$$</p><p>The <a target="_blank" href="https://www.mdpi.com/2073-8994/12/6/1053">paper</a> shows in Table 3 that not all frames are useful, there are only 6 that are useful for the QKD protocol, while some of the useless frames can be used as auxiliary frames for error detection and correction.</p><p>Finally, the concept of <em>matching result</em> is the configuration that results from Bob&rsquo;s measurement when obtaining a double matching. For instance, if Bob measures $(\ket{1_\mathrm{X}}, \ket{1_\mathrm{Z}})$ with $\mathrm{Z}$ and gets $(1, 1)$, and then measures $(\ket{0_\mathrm{X}}, \ket{1_\mathrm{Z}})$ with $\mathrm{X}$ and gets $(0, 0)$, the matching result can be represented as</p><p class="scroll">$$
\begin{pmatrix}
- & \ket{\bullet_\mathrm{Z}} \\
  \ket{\bullet_\mathrm{X}} & -
\end{pmatrix}
$$</p><p>Since Bob got a matching result while measuring the first pair with $\mathrm{X}$ and the second pair with $\mathrm{Z}$. Table 4 in the <a target="_blank" href="https://www.mdpi.com/2073-8994/12/6/1053">paper</a> shows the 4 possible arrangements and encodes them like bits <code>00</code>, <code>01</code>, <code>10</code>, <code>11</code> for later decoding.</p><h3 id="frame-based-qkd">Frame-based QKD</h3><p>I&rsquo;ll show the steps of the algorithm and then we will do a short example using the source code:</p><ol><li>Alice sends $n$ pairs chosen randomly from the set of 4 possible pairs</li><li>Bob chooses the basis to measure each of the $n$ pairs, randomly between whether $\mathrm{X}$ or $\mathrm{Z}$</li><li>Bob tells the indices of the pairs that got double matching</li><li>Alice takes the indices and performs 2-combinations to form frames, and discards useless ones</li><li>Alice sends the frames to Bob as tuples of indices</li><li>Bob computes sifting strings (sifting bits and measured bits) and sends them to Alice</li><li>Alice is capable of getting Bob&rsquo;s matching results to learn his basis choices for each qbit pair</li><li>Alice and Bob compute a shared secret based on Bob&rsquo;s measurement basis</li></ol><p>Figure 6 in the <a target="_blank" href="https://www.mdpi.com/2073-8994/12/6/1053">paper</a> shows the following flow:</p><p><img alt="Clutch 5" src="/images/other/HTB%20UniCTF/Clutch-1.webp"></p><p>There is an additional step before deriving the shared key. Alice must find ambiguous frames and tell Bob which frames are ambiguous, so that they don&rsquo;t use those frames.</p><h2 id="source-code-analysis">Source code analysis</h2><p>The top-level protocol can be read in the <code>QKD</code> class from <code>server.py</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">QKD</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">Alice</span><span class="mtk1">, </span><span class="mtk9 mtki">Bob</span><span class="mtk1">, </span><span class="mtk9 mtki">pairs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">, </span><span class="mtk9 mtki">security</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Alice</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">Alice</span><span class="mtk1">(</span><span class="mtk9 mtki">pairs</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Bob</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">Bob</span><span class="mtk1">(</span><span class="mtk1">uniform</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">))</span>

<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">security</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">security</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">check_status</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">"status"</span><span class="mtk1">: </span><span class="mtk4">"OK"</span><span class="mtk1">, </span><span class="mtk4">"QBER"</span><span class="mtk1">: </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Bob</span><span class="mtk1">.depolarizing_probability}</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">execute</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">pairs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Alice</span><span class="mtk1">.prepare()</span>
<span class="mtk1">        </span><span class="mtk1">double_matchings</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Bob</span><span class="mtk1">.measure(</span><span class="mtk1">pairs</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">double_matchings</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">"error"</span><span class="mtk1">: </span><span class="mtk4">"Key exchange failed, there's no double matchings.</span><span class="mtk4"> Retrying..."</span><span class="mtk1">}</span>
<span class="mtk1">    </span>
<span class="mtk1">        </span><span class="mtk1">frames</span><span class="mtk1">, </span><span class="mtk1">usable_frames</span><span class="mtk1">, </span><span class="mtk1">auxiliary_frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Alice</span><span class="mtk1">.compute_frames(</span><span class="mtk1">double_matchings</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">frames</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">"error"</span><span class="mtk1">: </span><span class="mtk4">"Key exchange failed, there's no frames. Retrying.</span><span class="mtk4">.."</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">bob_sifting_strings</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Bob</span><span class="mtk1">.compute_sifting_strings(</span><span class="mtk1">frames</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">, </span><span class="mtk1">ambiguous_frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Alice</span><span class="mtk1">.error_correction(</span><span class="mtk1">usable_frames</span><span class="mtk1">, </span><span class="mtk1">auxiliary_frames</span><span class="mtk1">, </span><span class="mtk1">bob_sifting_strings</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk1">alice_key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Alice</span><span class="mtk1">.generate_shared_key(</span><span class="mtk1">frames</span><span class="mtk1">, </span><span class="mtk1">usable_frames</span><span class="mtk1">, </span><span class="mtk1">ambiguous_frames</span><span class="mtk1">, </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">, </span><span class="mtk1">bob_sifting_strings</span><span class="mtk1">)</span>  

<span class="mtk1">        </span><span class="mtk1">bob_key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">Bob</span><span class="mtk1">.generate_shared_key(</span><span class="mtk1">frames</span><span class="mtk1">, </span><span class="mtk1">ambiguous_frames</span><span class="mtk1">, </span><span class="mtk1">bob_sifting_strings</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">alice_key</span><span class="mtk1">) </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">security</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">"error"</span><span class="mtk1">: </span><span class="mtk4">"Key exchange failed, the instance does not satisf</span><span class="mtk4">y the security requirements. Retrying..."</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">alice_key</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">bob_key</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">"error"</span><span class="mtk1">: </span><span class="mtk4">"Key exchange failed, both keys are not equal. Ret</span><span class="mtk4">rying..."</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">bob_sifting_strings</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk1">bob_sifting_strings</span><span class="mtk1">.values())</span>

<span class="mtk1">        </span><span class="mtk1">public</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk4">"double_matchings"</span><span class="mtk1">: </span><span class="mtk1">double_matchings</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">"frames"</span><span class="mtk1">: </span><span class="mtk1">frames</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">"sifting_strings"</span><span class="mtk1">: </span><span class="mtk1">bob_sifting_strings</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">"ambiguous_frames"</span><span class="mtk1">: </span><span class="mtk1">ambiguous_frames</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">shared_key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">alice_key</span><span class="mtk1">.encode()</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">public</span>
</code></pre></div><p><strong>Step 1:</strong> First of all, Alice generates random non-orthogonal qbit pairs (by default, a total of 256), and they are saved in <code>pairs_data</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Alice</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pairs</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pairs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">pairs</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pairs_data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {}</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk3"># Setting up global parameters. Local variables wi</span><span class="mtk3">th the same name refers to the frames generated in</span><span class="mtk3"> the actual QKD instance</span>  
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">usable_frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">USABLE_FRAMES</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">usable_frames_iterable</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">usable_frames</span><span class="mtk1">.</span><span class="mtk8">keys</span><span class="mtk1">())</span>

<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">auxiliary_frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">AUXILIARY_FRAMES</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">auxiliary_frames_iterable</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">auxiliary_frames</span><span class="mtk1">.</span><span class="mtk8">keys</span><span class="mtk1">())</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">generate_pairs</span><span class="mtk1">()</span>
<span class="mtk1">        </span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate_pairs</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pairs</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">x</span><span class="mtk1">, </span><span class="mtk1">z</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [ </span><span class="mtk8">randbits</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">) ]</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pairs_data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk1">x</span><span class="mtk6">}</span><span class="mtk4">x,</span><span class="mtk6">{</span><span class="mtk1">z</span><span class="mtk6">}</span><span class="mtk4">z"</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">pairs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pairs</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">circuits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">generate_circuits</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pairs_data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">])</span>
<span class="mtk1">            </span><span class="mtk1">pairs</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">circuits</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">pairs</span>
<span class="mtk1">            </span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate_circuits</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pair</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">x</span><span class="mtk1">, </span><span class="mtk1">z</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [ </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">state</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">state</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">pair</span><span class="mtk1">.split(</span><span class="mtk4">","</span><span class="mtk1">) ]</span>
<span class="mtk1">        </span><span class="mtk1">circuits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [ QuantumCircuit(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">) ]</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">: </span><span class="mtk1">circuits</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">].x(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">z</span><span class="mtk1">: </span><span class="mtk1">circuits</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].x(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk1">circuits</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">].h(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">circuits</span>
</code></pre></div><p>The returning value of <code>Alice.prepare</code> is a list of quantum circuits that encode the qbit pairs. These circuits are very simple, they just use X and H gates to get one of the possible 4 non-orthogonal qbit pairs. So, nothing really interesting to see here.</p><p><strong>Step 2:</strong> Then, Bob measures each circuit using a random basis:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Bob</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">depolarizing_probability</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">depolarizing_probability</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">depolarizing_probability</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">measurement_basis</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {}</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">measurement_results</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {}</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">backend</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> Aer.get_backend(</span><span class="mtk4">"qasm_simulator"</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">noise_model</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">p</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">error_model</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> depolarizing_error(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk1">noise_model</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> NoiseModel()</span>
<span class="mtk1">        </span><span class="mtk1">noise_model</span><span class="mtk1">.add_all_qubit_quantum_error(</span><span class="mtk1">error_model</span><span class="mtk1">, </span><span class="mtk4">"measure"</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">noise_model</span>
<span class="mtk1">        </span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">measure</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pairs</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">double_matchings</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk1">noise_model</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">None</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">depolarizing_probability</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">noise_model</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">noise_model</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">depolarizing_probability</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">pairs</span><span class="mtk1">)):</span>
<span class="mtk1">            </span><span class="mtk1">basis</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randbits</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">basis</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk3"># Measurement in "X" basis</span>
<span class="mtk1">                </span><span class="mtk9 mtki">pairs</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">][</span><span class="mtk6">0</span><span class="mtk1">].h(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk9 mtki">pairs</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">][</span><span class="mtk6">1</span><span class="mtk1">].h(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">                </span>
<span class="mtk1">            </span><span class="mtk9 mtki">pairs</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">][</span><span class="mtk6">0</span><span class="mtk1">].measure(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk9 mtki">pairs</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">][</span><span class="mtk6">1</span><span class="mtk1">].measure(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk1">bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">""</span>
<span class="mtk1">            </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">circuit</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">pairs</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]:</span>
<span class="mtk1">                </span><span class="mtk1">transpiled</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> transpile(</span><span class="mtk1">circuit</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">backend</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk1">results</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">backend</span><span class="mtk1">.run(</span><span class="mtk1">transpiled</span><span class="mtk1">, </span><span class="mtk9 mtki">noise_model</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">noise_model</span><span class="mtk1">, </span><span class="mtk9 mtki">shots</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">).result().get_counts()</span>  
<span class="mtk1">                </span><span class="mtk1">bits</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk1">results</span><span class="mtk1">.keys())[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">            </span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">bits</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">bits</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]: </span><span class="mtk1">double_matchings</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span>
<span class="mtk1">            </span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">measurement_results</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">bits</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">measurement_basis</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"X"</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">basis</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk4">"Z"</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">double_matchings</span>
</code></pre></div><p>As can be seen, Bob introduces some noise to the circuits with a depolarizing error probability, to make it more realistic.</p><p><strong>Step 3:</strong> The output of <code>Bob.measure</code> is the list of indices that resulted in a double matching. Bob also saves the measurements in <code>measurements_results</code> and the chosen basis in <code>measurement_basis</code>.</p><p><strong>Step 4:</strong> Alice computes frames based on 2-combinations of the double matching indices:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">public_frame_to_private_frame</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">frame</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pairs_data</span><span class="mtk1">[</span><span class="mtk9 mtki">frame</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pairs_data</span><span class="mtk1">[</span><span class="mtk9 mtki">frame</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]])</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">compute_frames</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">double_matchings</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">usable_frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {}</span>
<span class="mtk1">        </span><span class="mtk1">auxiliary_frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {}</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk1">public_frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk8 mtku">combinations</span><span class="mtk1">(</span><span class="mtk9 mtki">double_matchings</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">))</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">public_frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">public_frames</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">private_frame</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">public_frame_to_private_frame</span><span class="mtk1">(</span><span class="mtk1">public_frame</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">private_frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">usable_frames_iterable</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">usable_frames</span><span class="mtk1">[</span><span class="mtk1">public_frame</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">usable_frames</span><span class="mtk1">[</span><span class="mtk1">private_frame</span><span class="mtk1">]</span>
<span class="mtk1">            </span>
<span class="mtk1">            </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">private_frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">auxiliary_frames_iterable</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">auxiliary_frames</span><span class="mtk1">[</span><span class="mtk1">public_frame</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">auxiliary_frames</span><span class="mtk1">[</span><span class="mtk1">private_frame</span><span class="mtk1">]</span>  

<span class="mtk1">        </span><span class="mtk1">frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk1">usable_frames</span><span class="mtk1">.</span><span class="mtk8">keys</span><span class="mtk1">()) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk1">auxiliary_frames</span><span class="mtk1">.</span><span class="mtk8">keys</span><span class="mtk1">())</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk1">shuffle</span><span class="mtk1">(</span><span class="mtk1">frames</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">frames</span><span class="mtk1">, </span><span class="mtk1">usable_frames</span><span class="mtk1">, </span><span class="mtk1">auxiliary_frames</span>
</code></pre></div><p><strong>Step 5:</strong> Alice shuffles the frames list, although this doesn&rsquo;t increase security, in my opinion. Then, they are sent to Bob.</p><p><strong>Step 6:</strong> Now Bob uses <code>compute_sifting_strings</code> to compute both the sifting bits and the measurement bits:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">compute_sifting_bits</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">frame</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">sifting_bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk4">"X"</span><span class="mtk1">: </span><span class="mtk6">0</span><span class="mtk1">, </span>
<span class="mtk1">            </span><span class="mtk4">"Z"</span><span class="mtk1">: </span><span class="mtk6">0</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">pair</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">frame</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">sifting_bits</span><span class="mtk1">[</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">measurement_basis</span><span class="mtk1">[</span><span class="mtk1">pair</span><span class="mtk1">]] </span><span class="mtk5">^=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">measurement_results</span><span class="mtk1">[</span><span class="mtk1">pair</span><span class="mtk1">][</span><span class="mtk6">0</span><span class="mtk1">])</span>
<span class="mtk1">            </span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk1">sifting_bits</span><span class="mtk1">.</span><span class="mtk8">values</span><span class="mtk1">()))</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">compute_measured_bits</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">frame</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">measured_bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">pair</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">frame</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">measured_bits</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">measurement_results</span><span class="mtk1">[</span><span class="mtk1">pair</span><span class="mtk1">][</span><span class="mtk6">0</span><span class="mtk1">]) </span><span class="mtk3"># since both bits are equal due to the double matc</span><span class="mtk3">hing event</span>  

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk1">measured_bits</span><span class="mtk1">)</span>
<span class="mtk1">            </span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">compute_sifting_strings</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">frames</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">sifting_strings</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {}</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">frames</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">sifting_bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">compute_sifting_bits</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">measured_bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">compute_measured_bits</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk1">sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk1">sifting_bits</span><span class="mtk6">}</span><span class="mtk4">,</span><span class="mtk6">{</span><span class="mtk1">measured_bits</span><span class="mtk6">}</span><span class="mtk4">"</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">sifting_strings</span>
</code></pre></div><p>These sifting strings are really interesting because they give too much information. First of all, sifting bits are the column-wise XOR of the measured pairs, considering only the values that are 100% correct, and the rest as <code>0</code>. For instance,</p><p class="scroll">$$
\text{Alice:} \begin{pmatrix}
\ket{1_\mathrm{X}} & \ket{1_\mathrm{Z}} \\
  \ket{0_\mathrm{X}} & \ket{1_\mathrm{Z}}
\end{pmatrix} \longrightarrow \text{Bob:} \begin{Bmatrix}
\mathrm{Z}\\
\mathrm{X}
\end{Bmatrix} \longrightarrow
\begin{pmatrix}
- & \ket{1_\mathrm{Z}} \\
  \ket{0_\mathrm{X}} & -
\end{pmatrix} \longrightarrow \text{01}
$$</p><p>On the other hand, the measured bits are simply $10$, in row order. Since both pairs are double matchings, the $-$ sign is not relevant. So, the sifting string in this example is <code>01,10</code>.</p><p><strong>Step 7:</strong> Alice performs error detection and correction on Bob&rsquo;s sifting strings:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">verify_undetected_error</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pair</span><span class="mtk1">, </span><span class="mtk9 mtki">detection_frame</span><span class="mtk1">, </span><span class="mtk9 mtki">required_sifting_string</span><span class="mtk1">, </span><span class="mtk9 mtki">frame</span><span class="mtk1">, </span><span class="mtk9 mtki">auxiliary_frames</span><span class="mtk1">, </span><span class="mtk9 mtki">auxiliary_frames_iterable</span><span class="mtk1">, </span><span class="mtk9 mtki">sifting_string</span><span class="mtk1">):</span>  
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">auxiliary_frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">auxiliary_frames_iterable</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1">  (</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">frame</span><span class="mtk1">[</span><span class="mtk9 mtki">pair</span><span class="mtk1">]                       </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">auxiliary_frame</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]      </span><span class="mtk5">and</span><span class="mtk1"> </span>
<span class="mtk1">                    </span><span class="mtk9 mtki">auxiliary_frames</span><span class="mtk1">[</span><span class="mtk1">auxiliary_frame</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk9 mtki">detection_frame</span><span class="mtk1">         </span><span class="mtk5">and</span><span class="mtk1"> </span>
<span class="mtk1">                    </span><span class="mtk9 mtki">sifting_string</span><span class="mtk1">[</span><span class="mtk1">auxiliary_frame</span><span class="mtk1">]   </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk9 mtki">required_sifting_string</span>
<span class="mtk1">                ):</span>

<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">True</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">error_correction</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">usable_frames</span><span class="mtk1">, </span><span class="mtk9 mtki">auxiliary_frames</span><span class="mtk1">, </span><span class="mtk9 mtki">bob_sifting_strings</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">bob_sifting_strings</span><span class="mtk1">.copy()</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk1">ambiguous_frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk1">usable_frames_iterable</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk9 mtki">usable_frames</span><span class="mtk1">.keys())</span>
<span class="mtk1">        </span><span class="mtk1">auxiliary_frames_iterable</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk9 mtki">auxiliary_frames</span><span class="mtk1">.keys())</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">usable_frames_iterable</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">] </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">VALID_SS</span><span class="mtk1">[</span><span class="mtk9 mtki">usable_frames</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">]]:</span>
<span class="mtk1">                </span><span class="mtk1">sifting_bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">][:</span><span class="mtk6">2</span><span class="mtk1">]</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">sifting_bits</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"01"</span><span class="mtk1"> </span><span class="mtk5">or</span><span class="mtk1"> </span><span class="mtk1">sifting_bits</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"10"</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk1">ambiguous_frames</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk1">pair</span><span class="mtk1">, </span><span class="mtk1">detection_frame</span><span class="mtk1">, </span><span class="mtk1">required_sifting_string</span><span class="mtk1">, </span><span class="mtk1">corrections</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">ERROR_CORRECTION_RULES</span><span class="mtk1">[</span><span class="mtk9 mtki">usable_frames</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">]]</span>
<span class="mtk1">                    </span>
<span class="mtk1">                    </span><span class="mtk1">verify</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">verify_undetected_error</span><span class="mtk1">(</span>
<span class="mtk1">                                </span><span class="mtk1">pair</span><span class="mtk1">, </span>
<span class="mtk1">                                </span><span class="mtk1">detection_frame</span><span class="mtk1">, </span>
<span class="mtk1">                                </span><span class="mtk1">required_sifting_string</span><span class="mtk1">, </span>
<span class="mtk1">                                </span><span class="mtk1">frame</span><span class="mtk1">, </span>
<span class="mtk1">                                </span><span class="mtk9 mtki">auxiliary_frames</span><span class="mtk1">,</span>
<span class="mtk1">                                </span><span class="mtk1">auxiliary_frames_iterable</span><span class="mtk1">, </span>
<span class="mtk1">                                </span><span class="mtk1">alice_sifting_strings</span>
<span class="mtk1">                            )</span>

<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">verify</span><span class="mtk1">:</span>
<span class="mtk1">                        </span><span class="mtk5">if</span><span class="mtk1">  </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"00,11"</span><span class="mtk1">:</span>
<span class="mtk1">                            </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">corrections</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">                            </span>
<span class="mtk1">                        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"11,11"</span><span class="mtk1">:</span>
<span class="mtk1">                             </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">corrections</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">ambiguous_frames</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk1">ambiguous_frames</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk9 mtki">auxiliary_frames</span>

<span class="mtk1">        </span><span class="mtk1">shuffle</span><span class="mtk1">(</span><span class="mtk1">ambiguous_frames</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">, </span><span class="mtk1">ambiguous_frames</span>
</code></pre></div><p>This process is meant to discard frames that result ambiguous due to errors when measuring qbits on the simulated circuits. With this, Alice gets the correct sifting strings, that can be used to compute the shared secret. Bob also needs to know the frames that are ambiguous, in order to discard them later.</p><p><strong>Step 8:</strong> Alice and Bob can generate the same secret:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate_shared_key</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">frames</span><span class="mtk1">, </span><span class="mtk9 mtki">usable_frames</span><span class="mtk1">, </span><span class="mtk9 mtki">ambiguous_frames</span><span class="mtk1">, </span><span class="mtk9 mtki">alice_sifting_strings</span><span class="mtk1">, </span><span class="mtk9 mtki">bob_sifting_strings</span><span class="mtk1">):</span>  
<span class="mtk1">        </span><span class="mtk1">shared_secret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">""</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">frames</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">ambiguous_frames</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">continue</span>

<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">sifting_bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">alice_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">][:</span><span class="mtk6">2</span><span class="mtk1">]</span>
<span class="mtk1">                </span><span class="mtk1">measurement_result</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">ALICE_MR_DERIVATION</span><span class="mtk1">[</span><span class="mtk9 mtki">usable_frames</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">]][</span><span class="mtk1">sifting_bits</span><span class="mtk1">]</span>
<span class="mtk1">                </span><span class="mtk1">shared_secret</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">KEY_DERIVATION</span><span class="mtk1">[</span><span class="mtk9 mtki">bob_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">]][</span><span class="mtk1">measurement_result</span><span class="mtk1">]</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">shared_secret</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate_shared_key</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">frames</span><span class="mtk1">, </span><span class="mtk9 mtki">ambiguous_frames</span><span class="mtk1">, </span><span class="mtk9 mtki">sifting_strings</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">shared_secret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">""</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">frames</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">ambiguous_frames</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">continue</span>

<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">basis_orientation</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">measurement_basis</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">measurement_basis</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]])</span>  
<span class="mtk1">                </span><span class="mtk1">measurement_result</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BOB_MR_DERIVATION</span><span class="mtk1">[</span><span class="mtk1">basis_orientation</span><span class="mtk1">]</span>
<span class="mtk1">                </span><span class="mtk1">shared_secret</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">KEY_DERIVATION</span><span class="mtk1">[</span><span class="mtk9 mtki">sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">]][</span><span class="mtk1">measurement_result</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">shared_secret</span>
</code></pre></div><p>Alice&rsquo;s way to generate the secret looks more complicated. On Bob&rsquo;s side, he only takes the measurement basis he computed at random and uses that to derive the secret using a table that depends on the measurement results.</p><h2 id="solution">Solution</h2><p>I started playing with <code>Alice</code> and <code>Bob</code> in the Python REPL, with a small key size:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; from server import Alice, Bob, QKD
&gt;&gt;&gt;
&gt;&gt;&gt; while True:
...     qkd = QKD(Alice, Bob, 16, 8)
...     public = qkd.execute()
...     if 'error' not in public:
...         break
...
&gt;&gt;&gt; public
{'double_matchings': [2, 3, 4, 6, 7, 8, 9, 11, 12, 13, 14, 15], 'frames': [(2, 15), (3, 13), (7, 12), (4, 14), (4, 7), (4, 6), (7, 13), (3, 12), (9, 15), (8, 15), (6, 15), (8, 13), (9, 13), (4, 9), (12, 15), (4, 8), (2, 13), (7, 15), (2, 4), (11, 12), (6, 12), (11, 15), (8, 12), (6, 13), (3, 15), (13, 15), (2, 12), (12, 13), (11, 13), (9, 12), (4, 11), (3, 4), (14, 15)], 'sifting_strings': ['11,11', '01,10', '00,11', '10,10', '11,11', '00,11', '01,10', '00,11', '11,11', '10,01', '00,11', '00,00', '01,10', '11,11', '11,11', '10,10', '01,10', '11,11', '11,11', '11,11', '11,11', '00,11', '01,01', '10,10', '11,11', '10,01', '00,11', '01,10', '10,10', '00,11', '00,11', '11,11', '10,01'], 'ambiguous_frames': [(7, 12), (13, 15), (9, 12), (11, 13), (3, 12), (3, 13), (8, 15), (12, 15), (11, 12), (14, 15), (2, 13), (7, 13), (8, 12), (4, 8), (4, 14), (9, 13), (2, 12), (6, 12), (6, 13), (12, 13), (8, 13)]}  
&gt;&gt;&gt;
&gt;&gt;&gt; double_matchings = public.get('double_matchings')
&gt;&gt;&gt; frames = list(map(tuple, data.get('frames', [])))
&gt;&gt;&gt; sifting_strings = public.get('sifting_strings')
&gt;&gt;&gt; ambiguous_frames = set(map(tuple, public.get('ambiguous_frames', [])))
&gt;&gt;&gt;
&gt;&gt;&gt; double_matchings
[2, 3, 4, 6, 7, 8, 9, 11, 12, 13, 14, 15]
&gt;&gt;&gt; frames
[(2, 15), (3, 13), (7, 12), (4, 14), (4, 7), (4, 6), (7, 13), (3, 12), (9, 15), (8, 15), (6, 15), (8, 13), (9, 13), (4, 9), (12, 15), (4, 8), (2, 13), (7, 15), (2, 4), (11, 12), (6, 12), (11, 15), (8, 12), (6, 13), (3, 15), (13, 15), (2, 12), (12, 13), (11, 13), (9, 12), (4, 11), (3, 4), (14, 15)]
&gt;&gt;&gt; sifting_strings
['11,11', '01,10', '00,11', '10,10', '11,11', '00,11', '01,10', '00,11', '11,11', '10,01', '00,11', '00,00', '01,10', '11,11', '11,11', '10,10', '01,10', '11,11', '11,11', '11,11', '11,11', '00,11', '01,01', '10,10', '11,11', '10,01', '00,11', '01,10', '10,10', '00,11', '00,11', '11,11', '10,01']
&gt;&gt;&gt; ambiguous_frames
{(6, 12), (12, 13), (3, 13), (8, 12), (8, 15), (7, 13), (4, 8), (4, 14), (12, 15), (3, 12), (14, 15), (9, 13), (11, 13), (2, 13), (6, 13), (7, 12), (9, 12), (11, 12), (8, 13), (2, 12), (13, 15)}
</code></pre></div><p>Let&rsquo;s start looking at some values that we are not supposed to know. For instance, the variable <code>bob_sifting_strings</code> is computed from <code>compute_sifting_strings</code> on <code>frames</code> (I&rsquo;ll put a beginning underscore to denote private variables):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; _bob_sifting_strings = qkd.Bob.compute_sifting_strings(frames)
&gt;&gt;&gt; _bob_sifting_strings
{(2, 15): '11,11', (3, 13): '01,10', (7, 12): '00,11', (4, 14): '10,10', (4, 7): '11,11', (4, 6): '00,11', (7, 13): '01,10', (3, 12): '00,11', (9, 15): '11,11', (8, 15): '10,01', (6, 15): '00,11', (8, 13): '00,00', (9, 13): '01,10', (4, 9): '11,11', (12, 15): '11,11', (4, 8): '10,10', (2, 13): '01,10', (7, 15): '11,11', (2, 4): '11,11', (11, 12): '11,11', (6, 12): '11,11', (11, 15): '00,11', (8, 12): '01,01', (6, 13): '10,10', (3, 15): '11,11', (13, 15): '10,01', (2, 12): '00,11', (12, 13): '01,10', (11, 13): '10,10', (9, 12): '00,11', (4, 11): '00,11', (3, 4): '11,11', (14, 15): '10,01'}  
</code></pre></div><p>Notice that we can get this value by joining <code>frames</code> and <code>sifting_strings</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; dict(zip(frames, sifting_strings)) == _bob_sifting_strings  
True
&gt;&gt;&gt; bob_sifting_strings = dict(zip(frames, sifting_strings))
</code></pre></div><p>Another thing to notice is that the bit-length of the shared key equals the length of <code>frames</code> minus the length of <code>ambiguous_frames</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; _shared_key = qkd.shared_key
&gt;&gt;&gt; _shared_key
b'010001000000'
&gt;&gt;&gt; len(_shared_key)
12
&gt;&gt;&gt; len(frames)
33
&gt;&gt;&gt; len(ambiguous_frames)
21
&gt;&gt;&gt; len(frames) - len(ambiguous_frames) == len(_shared_key)  
True
</code></pre></div><p>We know that none of the <code>ambiguous_frames</code> are used to generate the shared secret, therefore, we can easily find the frames that are actually used to generate the secret (which determines the length of the secret):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; used = sorted(set(frames).difference(ambiguous_frames))
&gt;&gt;&gt; used
[(2, 4), (2, 15), (3, 4), (3, 15), (4, 6), (4, 7), (4, 9), (4, 11), (6, 15), (7, 15), (9, 15), (11, 15)]  
</code></pre></div><p>Let&rsquo;s take a closer look to the condition that makes a frame ambiguous or not:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">error_correction</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">usable_frames</span><span class="mtk1">, </span><span class="mtk9 mtki">auxiliary_frames</span><span class="mtk1">, </span><span class="mtk9 mtki">bob_sifting_strings</span><span class="mtk1">):</span>  
<span class="mtk1">        </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">bob_sifting_strings</span><span class="mtk1">.copy()</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk1">ambiguous_frames</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk1">usable_frames_iterable</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk9 mtki">usable_frames</span><span class="mtk1">.keys())</span>
<span class="mtk1">        </span><span class="mtk1">auxiliary_frames_iterable</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk9 mtki">auxiliary_frames</span><span class="mtk1">.keys())</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">frame</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">usable_frames_iterable</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">] </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">VALID_SS</span><span class="mtk1">[</span><span class="mtk9 mtki">usable_frames</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">]]:</span>
<span class="mtk1">                </span><span class="mtk1">sifting_bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">[</span><span class="mtk1">frame</span><span class="mtk1">][:</span><span class="mtk6">2</span><span class="mtk1">]</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">sifting_bits</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"01"</span><span class="mtk1"> </span><span class="mtk5">or</span><span class="mtk1"> </span><span class="mtk1">sifting_bits</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"10"</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk1">ambiguous_frames</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk3"># ...</span>

<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">ambiguous_frames</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk1">ambiguous_frames</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk9 mtki">auxiliary_frames</span>

<span class="mtk1">        </span><span class="mtk1">shuffle</span><span class="mtk1">(</span><span class="mtk1">ambiguous_frames</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">alice_sifting_strings</span><span class="mtk1">, </span><span class="mtk1">ambiguous_frames</span>
</code></pre></div><p>We can see that sifting bits $01$ or $10$ are always ambiguous! Let&rsquo;s have a look:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; bob_sifting_strings
{(2, 15): '11,11', (3, 13): '01,10', (7, 12): '00,11', (4, 14): '10,10', (4, 7): '11,11', (4, 6): '00,11', (7, 13): '01,10', (3, 12): '00,11', (9, 15): '11,11', (8, 15): '10,01', (6, 15): '00,11', (8, 13): '00,00', (9, 13): '01,10', (4, 9): '11,11', (12, 15): '11,11', (4, 8): '10,10', (2, 13): '01,10', (7, 15): '11,11', (2, 4): '11,11', (11, 12): '11,11', (6, 12): '11,11', (11, 15): '00,11', (8, 12): '01,01', (6, 13): '10,10', (3, 15): '11,11', (13, 15): '10,01', (2, 12): '00,11', (12, 13): '01,10', (11, 13): '10,10', (9, 12): '00,11', (4, 11): '00,11', (3, 4): '11,11', (14, 15): '10,01'}  
&gt;&gt;&gt; ambiguous_frames
{(6, 12), (12, 13), (3, 13), (8, 12), (8, 15), (7, 13), (4, 8), (4, 14), (12, 15), (3, 12), (14, 15), (9, 13), (11, 13), (2, 13), (6, 13), (7, 12), (9, 12), (11, 12), (8, 13), (2, 12), (13, 15)}
&gt;&gt;&gt; for t, s in bob_sifting_strings.items():
...     print(t, ' \t', repr(s), '\t', t in ambiguous_frames)
...
(2, 15)          '11,11'         False
(3, 13)          '01,10'         True
(7, 12)          '00,11'         True
(4, 14)          '10,10'         True
(4, 7)           '11,11'         False
(4, 6)           '00,11'         False
(7, 13)          '01,10'         True
(3, 12)          '00,11'         True
(9, 15)          '11,11'         False
(8, 15)          '10,01'         True
(6, 15)          '00,11'         False
(8, 13)          '00,00'         True
(9, 13)          '01,10'         True
(4, 9)           '11,11'         False
(12, 15)         '11,11'         True
(4, 8)           '10,10'         True
(2, 13)          '01,10'         True
(7, 15)          '11,11'         False
(2, 4)           '11,11'         False
(11, 12)         '11,11'         True
(6, 12)          '11,11'         True
(11, 15)         '00,11'         False
(8, 12)          '01,01'         True
(6, 13)          '10,10'         True
(3, 15)          '11,11'         False
(13, 15)         '10,01'         True
(2, 12)          '00,11'         True
(12, 13)         '01,10'         True
(11, 13)         '10,10'         True
(9, 12)          '00,11'         True
(4, 11)          '00,11'         False
(3, 4)           '11,11'         False
(14, 15)         '10,01'         True
</code></pre></div><p>It looks correct, all sifting strings that start with <code>01</code> or <code>10</code> are ambiguous. Therefore, these are the non-ambiguous frames:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; non_ambiguous = {t: s for t, s in bob_sifting_strings.items() if s[:2] in {'00', '11'}}
&gt;&gt;&gt; non_ambiguous
{(2, 15): '11,11', (7, 12): '00,11', (4, 7): '11,11', (4, 6): '00,11', (3, 12): '00,11', (9, 15): '11,11', (6, 15): '00,11', (8, 13): '00,00', (4, 9): '11,11', (12, 15): '11,11', (7, 15): '11,11', (2, 4): '11,11', (11, 12): '11,11', (6, 12): '11,11', (11, 15): '00,11', (3, 15): '11,11', (2, 12): '00,11', (9, 12): '00,11', (4, 11): '00,11', (3, 4): '11,11'}  
</code></pre></div><p>However, we need to take the frames that were actually used:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; used_non_ambiguous = {t: s for t, s in non_ambiguous.items() if t in used}
&gt;&gt;&gt; used_non_ambiguous
{(2, 15): '11,11', (4, 7): '11,11', (4, 6): '00,11', (9, 15): '11,11', (6, 15): '00,11', (4, 9): '11,11', (7, 15): '11,11', (2, 4): '11,11', (11, 15): '00,11', (3, 15): '11,11', (4, 11): '00,11', (3, 4): '11,11'}  
&gt;&gt;&gt;
&gt;&gt;&gt; for t, s in used_non_ambiguous.items():
...     print(t, ' \t', repr(s))
...
(2, 15)          '11,11'
(4, 7)           '11,11'
(4, 6)           '00,11'
(9, 15)          '11,11'
(6, 15)          '00,11'
(4, 9)           '11,11'
(7, 15)          '11,11'
(2, 4)           '11,11'
(11, 15)         '00,11'
(3, 15)          '11,11'
(4, 11)          '00,11'
(3, 4)           '11,11'
</code></pre></div><p>This is very interesting. All used sifting strings are either <code>00,11</code> or <code>11,11</code>&mldr; Let&rsquo;s have a look at Bob&rsquo;s measurement basis:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; for i, b in qkd.Bob.measurement_basis.items():  
...     print(f'{i:2d}: {b}')
...
 0: Z
 1: Z
 2: Z
 3: Z
 4: X
 5: Z
 6: X
 7: Z
 8: Z
 9: Z
10: X
11: X
12: Z
13: Z
14: X
15: X
</code></pre></div><p>Don&rsquo;t you notice something? Let&rsquo;s combine the outputs:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; for t, s in used_non_ambiguous.items():
...     print(t, ' \t', repr(s), '\t', (_basis[t[0]], _basis[t[1]]))  
...
(2, 15)          '11,11'         ('Z', 'X')
(4, 7)           '11,11'         ('X', 'Z')
(4, 6)           '00,11'         ('X', 'X')
(9, 15)          '11,11'         ('Z', 'X')
(6, 15)          '00,11'         ('X', 'X')
(4, 9)           '11,11'         ('X', 'Z')
(7, 15)          '11,11'         ('Z', 'X')
(2, 4)           '11,11'         ('Z', 'X')
(11, 15)         '00,11'         ('X', 'X')
(3, 15)          '11,11'         ('Z', 'X')
(4, 11)          '00,11'         ('X', 'X')
(3, 4)           '11,11'         ('Z', 'X')
</code></pre></div><p>Hey! If a sifting string is <code>11,11</code>, then the basis are always $(\mathrm{Z}, \mathrm{X})$ or $(\mathrm{X}, \mathrm{Z})$. On the other hand, if the sifting string is <code>00,11</code>, then the basis are always $(\mathrm{Z}, \mathrm{Z})$ or $(\mathrm{X}, \mathrm{X})$.</p><p>With this information, we can simply choose an initial basis for one index and then derive the rest using the previous conditions. We can do this with a simple algorithm:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">basis</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span><span class="mtk1">used</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">][</span><span class="mtk6">0</span><span class="mtk1">]: </span><span class="mtk4">'X'</span><span class="mtk1">}</span>

<span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">basis</span><span class="mtk1">) </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">used</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">old_basis</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">basis</span><span class="mtk1">.</span><span class="mtk8">copy</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">u</span><span class="mtk1">, </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">old_basis</span><span class="mtk1">.</span><span class="mtk8">items</span><span class="mtk1">():</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">t</span><span class="mtk1">, </span><span class="mtk1">v</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">used_non_ambiguous</span><span class="mtk1">.</span><span class="mtk8">items</span><span class="mtk1">():</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">u</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">v</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'11,11'</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">basis</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">basis</span><span class="mtk1">[</span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'Z'</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'X'</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk4">'X'</span>
<span class="mtk1">            </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">u</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">v</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'11,11'</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">basis</span><span class="mtk1">:</span>  
<span class="mtk1">                </span><span class="mtk1">basis</span><span class="mtk1">[</span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'Z'</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'X'</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk4">'X'</span>
<span class="mtk1">            </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">u</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">v</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'00,11'</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">basis</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">basis</span><span class="mtk1">[</span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">m</span>
<span class="mtk1">            </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">u</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">v</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'00,11'</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">basis</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">basis</span><span class="mtk1">[</span><span class="mtk1">t</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">m</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">old_basis</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">basis</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">break</span>
</code></pre></div><p>We will have a 50% chance of getting the correct basis:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; basis = {used[0][0]: 'X'}
&gt;&gt;&gt;
&gt;&gt;&gt; while len(basis) &lt; len(used):
...     old_basis = basis.copy()
...     for u, m in old_basis.items():
...         for t, v in used_non_ambiguous.items():
...             if u == t[0] and v == '11,11' and t[1] not in basis:
...                 basis[t[1]] = 'Z' if m == 'X' else 'X'
...             elif u == t[1] and v == '11,11' and t[0] not in basis:
...                 basis[t[0]] = 'Z' if m == 'X' else 'X'
...             elif u == t[0] and v == '00,11' and t[1] not in basis:
...                 basis[t[1]] = m
...             elif u == t[1] and v == '00,11' and t[0] not in basis:
...                 basis[t[0]] = m
...     if len(old_basis) == len(basis):
...         break
...
&gt;&gt;&gt; basis_x = basis
&gt;&gt;&gt; basis_x
{2: 'X', 15: 'Z', 4: 'Z', 9: 'X', 6: 'Z', 7: 'X', 11: 'Z', 3: 'X'}
&gt;&gt;&gt; _basis
{0: 'Z', 1: 'Z', 2: 'Z', 3: 'Z', 4: 'X', 5: 'Z', 6: 'X', 7: 'Z', 8: 'Z', 9: 'Z', 10: 'X', 11: 'X', 12: 'Z', 13: 'Z', 14: 'X', 15: 'X'}  
</code></pre></div><p>So, if the key is not correct, then it is the opposite:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; basis = {used[0][0]: 'Z'}
&gt;&gt;&gt;
&gt;&gt;&gt; while len(basis) < len(used):
...     old_basis = basis.copy()
...     for u, m in old_basis.items():
...         for t, v in used_non_ambiguous.items():
...             if u == t[0] and v == '11,11' and t[1] not in basis:
...                 basis[t[1]] = 'Z' if m == 'X' else 'X'
...             elif u == t[1] and v == '11,11' and t[0] not in basis:
...                 basis[t[0]] = 'Z' if m == 'X' else 'X'
...             elif u == t[0] and v == '00,11' and t[1] not in basis:
...                 basis[t[1]] = m
...             elif u == t[1] and v == '00,11' and t[0] not in basis:
...                 basis[t[0]] = m
...     if len(old_basis) == len(basis):
...         break
...
&gt;&gt;&gt; basis_z = basis
&gt;&gt;&gt; basis_z
{2: 'Z', 15: 'X', 4: 'X', 9: 'Z', 6: 'X', 7: 'Z', 11: 'X', 3: 'Z'}
&gt;&gt;&gt; _basis
{0: 'Z', 1: 'Z', 2: 'Z', 3: 'Z', 4: 'X', 5: 'Z', 6: 'X', 7: 'Z', 8: 'Z', 9: 'Z', 10: 'X', 11: 'X', 12: 'Z', 13: 'Z', 14: 'X', 15: 'X'}  
</code></pre></div><p>Notice that we don&rsquo;t need to find the whole measurement basis, only the indices that are actually used for secret generation. Now, we can use Bob&rsquo;s <code>generate_shared_key</code> to find the shared key:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; from helpers import BOB_MR_DERIVATION, KEY_DERIVATION
&gt;&gt;&gt;
&gt;&gt;&gt; def generate_shared_key(measurement_basis, frames, ambiguous_frames, sifting_strings):  
...     shared_secret = ''
...     for frame in frames:
...         if frame in ambiguous_frames:
...             continue
...         basis_orientation = (measurement_basis[frame[0]], measurement_basis[frame[1]])
...         measurement_result = BOB_MR_DERIVATION[basis_orientation]
...         shared_secret += KEY_DERIVATION[sifting_strings[frame]][measurement_result]
...     return shared_secret
...
&gt;&gt;&gt; generate_shared_key(basis_x, frames, ambiguous_frames, bob_sifting_strings)
'101110111111'
&gt;&gt;&gt; generate_shared_key(basis_z, frames, ambiguous_frames, bob_sifting_strings)
'010001000000'
&gt;&gt;&gt; _shared_key.decode()
'010001000000'
</code></pre></div><p>At this point, we have found a way to find the shared key with a 50% chance.</p><h3 id="getting-the-flag">Getting the flag</h3><p>Now we only need use the shared key to derive an AES key to encrypt the requested command (<code>"OPEN THE GATE"</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">loads</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk1">encrypted_command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk4">"command"</span><span class="mtk1">])</span>
<span class="mtk1">            </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">encrypted_command</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">json_print</span><span class="mtk1">({</span><span class="mtk4">"error"</span><span class="mtk1">: </span><span class="mtk4">"Invalid input. Please, try again"</span><span class="mtk1">})</span>
<span class="mtk1">            </span><span class="mtk5">continue</span>

<span class="mtk1">        </span><span class="mtk1">command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">qkd</span><span class="mtk1">.</span><span class="mtk8">decrypt_command</span><span class="mtk1">(</span><span class="mtk1">encrypted_command</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">command</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"OPEN THE GATE"</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">FLAG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'flag.txt'</span><span class="mtk1">).</span><span class="mtk8">read</span><span class="mtk1">()</span>
<span class="mtk1">            </span><span class="mtk8">json_print</span><span class="mtk1">({</span><span class="mtk4">"info"</span><span class="mtk1">: </span><span class="mtk7 mtki">f</span><span class="mtk4">" Welcome to The Frontier Board, the coordinates o</span><span class="mtk4">f The Starry Spurr are </span><span class="mtk6">{</span><span class="mtk1">SECRET_MESSAGE</span><span class="mtk6">}{</span><span class="mtk1">FLAG</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">})</span>  
<span class="mtk1">            </span><span class="mtk8">exit</span><span class="mtk1">()</span>

<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">json_print</span><span class="mtk1">({</span><span class="mtk4">"error"</span><span class="mtk1">: </span><span class="mtk4">"Unknown command. Please, try again"</span><span class="mtk1">})</span>
</code></pre></div><p>The <code>decrypt_command</code> function uses the shared key to derive an AES key. Then, it removes PKCS7 padding, but there is no exception handler:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">decrypt_command</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">encrypted_command</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sha256</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">shared_key</span><span class="mtk1">).</span><span class="mtk8">digest</span><span class="mtk1">()</span>

<span class="mtk1">        </span><span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk1">key</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_ECB</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">unpad</span><span class="mtk1">(</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">encrypted_command</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>  
<span class="mtk1">    </span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">command</span><span class="mtk1">.</span><span class="mtk8">decode</span><span class="mtk1">()</span>
</code></pre></div><p>Therefore, we won&rsquo;t be able to test the two possible shared keys we got before, because it is very likely that a wrong AES key will result in incorrect padding and the server will close. But this is not a problem, because we will get the correct shared key one out of two times.</p><h2 id="flag">Flag</h2><p>We can sum up all the above code snippets into a Python script that connects to the challenge instance, takes the needed information, extracts the shared key and uses it to encrypt the required command. With this, we can get the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.54.253:46816
[<span class="code-green">+</span>] Opening connection to 94.237.54.253 on port 46816: Done
[<span class="code-green">+</span>] Shared key: 0101010011011010111110011110011111111101011111101000010100101111110110001011100011011111010010011100010010101111010110110011010000101111001010001001101101011101101101111101001011101110110100101101011001000110010111100101110110010110010011101001111101100010101101111001100100110110011011100011000111100000011001000111110100100010100001011100011011110001110010100110101010101000111010001111111000000111000010101110110111101000010010101100001111010101001101010111011110100110111000010010100111101110111010110100100000000010011000001110001101111000000110001011100111001011101010110000010010110011110000101101000011011011110111101001101010011110100000111011010000110101100000010010001011100011101110101100111101111101111110101000100010100011101111110011010001001110  
[<span class="code-green">+</span>] HTB{n0w_7h475_4_C1u7Ch!_d3f1n3731Y_Fr4m3_b453d_QKD_n33d5_70_M47ur3__C0ngr47u14710n5!_d546b1cc16212e806fac3136509fe5f8}
[<span class="code-blue">*</span>] Closed connection to 94.237.54.253 port 46816
</code></pre></div><p>The full script can be found in here: <a target="_blank" href="https://github.com/7Rocky/CTF-scripts/tree/main/HTB%20UniCTF/Crypto/Clutch/solve.py"><code>solve.py</code></a>.</p><h3 id="conclusion">Conclusion</h3><p>Not all research papers are perfect. This is a great example of an algorithm that looks pretty complex and hard to break, but it is fully broken, despite being very nicely documented. I want to thank the author of the challenge, <a target="_blank" href="https://www.youtube.com/@d-cryp7352">D-Cryp7</a>, for this awesome challenge, that made my deep-dive into the QKD protocol trying to find a flaw, although it seemed to be pretty secure at first glance.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#background">Background</a><ul><li><a href="#frame-based-qkd">Frame-based QKD</a></li></ul></li><li><a href="#source-code-analysis">Source code analysis</a></li><li><a href="#solution">Solution</a><ul><li><a href="#getting-the-flag">Getting the flag</a></li></ul></li><li><a href="#flag">Flag</a><ul><li><a href="#conclusion">Conclusion</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2025</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>